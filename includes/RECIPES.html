<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Documentation</title>

    <link href="../stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="../stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="../javascripts/all_nosearch.js" type="text/javascript"></script>

  </head>

  <body class="includes includes_RECIPES">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="../images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="../images/logo.png" />
      <div id="toc">
      </div>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id="recipe-book">Recipe book</h1>

<h2 id="raw-queries">Raw queries</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">raw</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">);</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'coalesce(sum(??), 0) as ??'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'childAgeSum'</span><span class="p">]))</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s2">`?? || ' ' || ??`</span><span class="p">,</span> <span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">),</span> <span class="s1">'Arnold Schwarzenegger'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'random()'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">childAgeSums</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">childAgeSums</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childAgeSum</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'coalesce(sum(??), 0) as ??'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'childAgeSum'</span><span class="p">]))</span>
  <span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="s1">'parentId'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">childAgeSums</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">childAgeSums</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childAgeSum</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>To mix raw SQL with queries, use the <a href="#raw"><code class="prettyprint">raw</code></a> function from the main module 
or the <code class="prettyprint">raw</code> method of any <a href="#model"><code class="prettyprint">Model</code></a> subclass. The only difference between
these two is that the <code class="prettyprint">raw</code> function from the main module doesn&rsquo;t depend on knex
where as <code class="prettyprint">Model.raw()</code> will throw if the model doesn&rsquo;t have a knex instance installed.
Both of these functions work just like the <a href="http://knexjs.org/#Raw">knex&rsquo;s raw method</a>. 
And of course you can just use <code class="prettyprint">knex.raw()</code>.</p>

<p>There are also some helper methods such as <a href="#whereraw"><code class="prettyprint">whereRaw</code></a> in the <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>.</p>

<h2 id="json-queries">JSON queries</h2>
<pre class="highlight javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">ref</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'objection'</span><span class="p">;</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">([</span>
    <span class="s1">'id'</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">(</span><span class="s1">'jsonColumn:details.name'</span><span class="p">).</span><span class="nx">castText</span><span class="p">().</span><span class="nx">as</span><span class="p">(</span><span class="s1">'name'</span><span class="p">),</span>
    <span class="nx">ref</span><span class="p">(</span><span class="s1">'jsonColumn:details.age'</span><span class="p">).</span><span class="nx">castInt</span><span class="p">().</span><span class="nx">as</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span>
  <span class="p">])</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'Animal'</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Person.jsonColumn:details.name'</span><span class="p">).</span><span class="nx">castText</span><span class="p">(),</span> <span class="s1">'='</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Animal.name'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Animal.jsonData:details.ageLimit'</span><span class="p">));</span>
</code></pre>
<blockquote>
<p>Individual json fields can be updated like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
    <span class="s1">'jsonColumn:details.name'</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="s1">'jsonColumn:details.age'</span><span class="p">:</span> <span class="mi">29</span>
  <span class="p">});</span>
</code></pre>
<p>You can use the <a href="#ref"><code class="prettyprint">ref</code></a> function from the main module to refer to json columns
in queries. There is also a bunch of query building methods that have <code class="prettyprint">Json</code> in their
names. Check them out too.</p>

<p>See <a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a> for more information about how to refer to
json fields.</p>

<p>Json queries currently only work with postgres.</p>

<h2 id="change-id-column">Change id column</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">idColumn</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'person_id'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Name of the identifier column can be changed by setting the static <a href="#idcolumn"><code class="prettyprint">idColumn</code></a> property of a model class.
Composite key can be defined by using an array of column names.</p>

<h2 id="custom-validation">Custom validation</h2>

<blockquote>
<p>Additional validation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeInsert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">objection</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">({</span>
        <span class="na">id</span><span class="p">:</span> <span class="p">[{</span>
          <span class="na">message</span><span class="p">:</span> <span class="s1">'identifier should not be defined before insert'</span>
          <span class="na">keyword</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
          <span class="na">params</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">}]</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Modifying the <a href="https://github.com/epoberezkin/ajv">Ajv</a> based <code class="prettyprint">jsonSchema</code> validation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">AjvValidator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">AjvValidator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">AjvValidator</span><span class="p">({</span>
      <span class="na">onCreateAjv</span><span class="p">:</span> <span class="p">(</span><span class="nx">ajv</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Here you can modify the `Ajv` instance.</span>
      <span class="p">},</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">allErrors</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">validateSchema</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">ownProperties</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">v5</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Replace <code class="prettyprint">jsonSchema</code> validation with any other validation scheme by
implementing a custom <a href="#validator"><code class="prettyprint">Validator</code></a>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// MyCustomValidator.js</span>

<span class="kr">const</span> <span class="nx">Validator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Validator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MyCustomValidator</span> <span class="kr">extends</span> <span class="nx">Validator</span> <span class="p">{</span>
  <span class="nx">validate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The model instance. May be empty at this point.</span>
    <span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>

    <span class="c1">// The properties to validate. After validation these values will</span>
    <span class="c1">// be merged into `model` by objection.</span>
    <span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">json</span><span class="p">;</span>

    <span class="c1">// `ModelOptions` object. If your custom validator sets default</span>
    <span class="c1">// values, you need to check the `opt.patch` boolean. If it is true</span>
    <span class="c1">// we are validating a patch object, the defaults should not be set.</span>
    <span class="kr">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>

    <span class="c1">// A context object shared between the validation methods. A new</span>
    <span class="c1">// object is created for each validation operation.</span>
    <span class="kr">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ctx</span><span class="p">;</span>

    <span class="c1">// Do your validation here and throw any exception if the</span>
    <span class="c1">// validation fails.</span>
    <span class="nx">doSomeValidationAndThrowIfFails</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>

    <span class="c1">// You need to return the (possibly modified) json.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">beforeValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Takes the same arguments as `validate`. Usually there is no need</span>
    <span class="c1">// to override this.</span>
    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">beforeValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">afterValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Takes the same arguments as `validate`. Usually there is no need</span>
    <span class="c1">// to override this.</span>
    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">afterValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// BaseModel.js</span>

<span class="kr">const</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">;</span>

<span class="c1">// Override the `createValidator` method of a `Model` to use the</span>
<span class="c1">// custom validator.</span>
<span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyCustomValidator</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>If you want to use the json schema validation but add some custom validation on top of it you can override the
<a href="#_s_beforevalidate"><code class="prettyprint">$beforeValidate</code></a> or <a href="#_s_aftervalidate"><code class="prettyprint">$afterValidate</code></a> method.</p>

<p>If you need to do validation on insert or update you can throw exceptions from the
<a href="#_s_beforeinsert"><code class="prettyprint">$beforeInsert</code></a> and <a href="#_s_beforeupdate"><code class="prettyprint">$beforeUpdate</code></a> methods.</p>

<p>If you don&rsquo;t want to use the built-in json schema validation, you can just ignore the <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> property.
It is completely optional. If you want to use some other validation library you need to implement a custom <a href="#validator"><code class="prettyprint">Validator</code></a>
(see the example).</p>

<h2 id="map-column-names-to-different-property-names">Map column names to different property names</h2>

<blockquote>
<p>snake_case/camelCase conversion:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// It's a good idea to memoize the conversion functions.</span>
<span class="kr">const</span> <span class="nx">snakeCase</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">snakeCase</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">camelCase</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">camelCase</span><span class="p">);</span>

<span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="c1">// This is called when an object is serialized to database format.</span>
  <span class="nx">$formatDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$formatDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">mapKeys</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">snakeCase</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// This is called when an object is read from database.</span>
  <span class="nx">$parseDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">mapKeys</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">camelCase</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$parseDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Note that even though column names are mapped when fetching / storing data, one still has to use
db column names when writing queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">await</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">insert</span><span class="p">({</span> <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">jen</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">,</span> <span class="s1">'Jennifer'</span><span class="p">);</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">jen</span><span class="p">.</span><span class="nx">firstName</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'Jennifer'</span><span class="p">);</span>
</code></pre>
<p>Sometimes you may want to use for example snake_cased column names in database tables
and camelCased property names in code. You can use the functions</p>

<ul>
<li><a href="#_s_parsedatabasejson"><code class="prettyprint">$parseDatabaseJson</code></a></li>
<li><a href="#_s_formatdatabasejson"><code class="prettyprint">$formatDatabaseJson</code></a></li>
<li><a href="#_s_parsejson"><code class="prettyprint">$parseJson</code></a></li>
<li><a href="#_s_formatjson"><code class="prettyprint">$formatJson</code></a></li>
</ul>

<p>to convert data between database and &ldquo;external&rdquo; representations.</p>

<h2 id="paging">Paging</h2>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 100</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span> <span class="c1">// --&gt; 3341</span>
  <span class="p">});</span>
</code></pre>
<p>Any query can be paged using the <a href="#page"><code class="prettyprint">page</code></a> or <a href="#range"><code class="prettyprint">range</code></a> method.</p>

<h2 id="subqueries">Subqueries</h2>

<blockquote>
<p>You can use functions:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">).</span><span class="nx">from</span><span class="p">(</span><span class="s1">'Person'</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Or <code class="prettyprint">QueryBuilder</code>s:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Subqueries can be written just like in knex: by passing a function in place of a value. A bunch of query building
methods accept a function. See the knex.js documentation or just try it out. A function is accepted in most places
you would expect. You can also pass <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> instances or knex queries instead of functions.</p>

<h2 id="joins">Joins</h2>

<blockquote>
<p>Normal knex-style join:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'Person.*'</span><span class="p">,</span> <span class="s1">'Parent.firstName as parentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'Person as Parent'</span><span class="p">,</span> <span class="s1">'Person.parentId'</span><span class="p">,</span> <span class="s1">'Parent.id'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p><a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> helper for joining relation graphs:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'parent:parent.name as grandParentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'parent.parent'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">grandParentName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Again, <a href="http://knexjs.org/#Builder-join">do as you would with a knex query builder</a>. Objection also has helpers like
the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method family.</p>

<h2 id="postgresql-quot-returning-quot-tricks">PostgreSQL &ldquo;returning&rdquo; tricks</h2>

<blockquote>
<p>Insert and return a Model instance in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">);</span> <span class="c1">// NOW()-ish</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="c1">// Sequence ID</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Update a single row by ID and return the updated Model instance in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jenn'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span> <span class="c1">// Ensures we're returned a single row in the promise resolution</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">);</span> <span class="c1">// NOW()-ish</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span> <span class="c1">// "Jenn"</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Patch a Model instance and receive DB updates to Model instance in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'J.'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span> <span class="c1">// Ensures we're returned a single row in the promise resolution</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">);</span> <span class="c1">// NOW()-ish</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span> <span class="c1">// "J."</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Delete all Persons named Jennifer and return the deleted rows as Model instances in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jenn'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deletedJennifers</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">deletedJennifers</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// However many Jennifers there were</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">deletedJennifers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lastName</span><span class="p">);</span> <span class="c1">// Maybe "Lawrence"</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Delete all of Jennifer&rsquo;s dogs and return the deleted Model instances in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">({</span><span class="s1">'species'</span><span class="p">:</span> <span class="s1">'dog'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennsDeletedDogs</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennsDeletedDogs</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// However many dogs Jennifer had</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennsDeletedDogs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// Maybe "Fido"</span>
  <span class="p">});</span>

</code></pre>
<p>Because PostgreSQL (and some others) support <code class="prettyprint">returning(&#39;*&#39;)</code> chaining, you can actually <code class="prettyprint">insert</code> a row, or
<code class="prettyprint">update</code> / <code class="prettyprint">patch</code> / <code class="prettyprint">delete</code> (an) existing row(s), <strong>and</strong> receive the affected row(s) as Model instances in a single query, thus improving efficiency. See the examples for more clarity.</p>

<h2 id="polymorphic-associations">Polymorphic associations</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Issue</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">comments</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Comment</span><span class="p">,</span>
        <span class="na">filter</span><span class="p">:</span> <span class="p">{</span><span class="na">commentableType</span><span class="p">:</span> <span class="s1">'Issue'</span><span class="p">},</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Issue.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Comment.commentableId'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">PullRequest</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">comments</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Comment</span><span class="p">,</span>
        <span class="na">filter</span><span class="p">:</span> <span class="p">{</span><span class="na">commentableType</span><span class="p">:</span> <span class="s1">'PullRequest'</span><span class="p">},</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'PullRequest.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Comment.commentableId'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>The <code class="prettyprint">{commentableType: &#39;Type&#39;}</code> filter adds a <code class="prettyprint">WHERE &quot;commentableType&quot; = &#39;Type&#39;</code> clause to the relation fetch
query. It doesn&rsquo;t automatically set the type when you insert a new comment. You have to set the <code class="prettyprint">commentableType</code>
manually:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">someIssue</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">text</span><span class="p">:</span> <span class="s1">'blaa'</span><span class="p">,</span> <span class="na">commentableType</span><span class="p">:</span> <span class="s1">'Issue'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
</code></pre>
<p>Creating polymorphic associations isn&rsquo;t as easy as it could be at the moment, but it can be done using
custom filters for relations. Let&rsquo;s assume we have tables <code class="prettyprint">Comment</code>, <code class="prettyprint">Issue</code> and <code class="prettyprint">PullRequest</code>. Both
<code class="prettyprint">Issue</code> and <code class="prettyprint">PullRequest</code> can have a list of comments. <code class="prettyprint">Comment</code> has a column <code class="prettyprint">commentableId</code> to hold
the foreign key and <code class="prettyprint">commentableType</code> to hold the related model type. Check out the first example for
how to create relations for this setup âž”</p>

<h2 id="timestamps">Timestamps</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeInsert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">created_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">$beforeUpdate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updated_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can implement the <code class="prettyprint">$beforeInsert</code> and <code class="prettyprint">$beforeUpdate</code> methods to set the timestamps. If you want to do this for all
your models, you can simply create common base class that implements these methods.</p>

<h2 id="custom-query-builder">Custom query builder</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">QueryBuilder</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">QueryBuilder</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MyQueryBuilder</span> <span class="kr">extends</span> <span class="nx">QueryBuilder</span> <span class="p">{</span>
  <span class="c1">// Some custom method.</span>
  <span class="nx">upsert</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">QueryBuilder</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">MyQueryBuilder</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Now you can do this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">upsert</span><span class="p">(</span><span class="nx">person</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">});</span>
</code></pre>
<p>You can extend the <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> returned by <a href="#query"><code class="prettyprint">Model.query()</code></a>, <a href="#_s_relatedquery"><code class="prettyprint">modelInstance.$relatedQuery()</code></a>
and <a href="#_s_query"><code class="prettyprint">modelInstance.$query()</code></a> methods by setting the model class&rsquo;s static <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>.</p>

<p>If you want to set the custom query builder for all model classes you can just set the <code class="prettyprint">QueryBuilder</code>
property of the <a href="#model"><code class="prettyprint">Model</code></a> base class. A cleaner option would be to create your own Model subclass, set its <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>
property and inherit all your models from the custom Model class.</p>

<h2 id="multi-tenancy">Multi-tenancy</h2>
<pre class="highlight javascript"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Function that parses the tenant id from path, header, query parameter etc.</span>
  <span class="c1">// and returns an instance of knex. You should cache the knex instances and</span>
  <span class="c1">// not create a new one for each query.</span>
  <span class="kd">var</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">getDatabaseForRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>

  <span class="nx">req</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Person</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex</span><span class="p">),</span>
    <span class="na">Movie</span><span class="p">:</span> <span class="nx">Movie</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex</span><span class="p">),</span>
    <span class="na">Animal</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex</span><span class="p">)</span>
  <span class="p">};</span>

  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
<p>By default, the examples guide you to setup the database connection by setting the knex object of the <a href="#model"><code class="prettyprint">Model</code></a> base
class. This doesn&rsquo;t fly if you want to select the database based on the request as it sets the connection globally.</p>

<p>If you have a different database for each tenant, a useful pattern is to add a middleware that adds the models to
<code class="prettyprint">req.models</code> hash and then <em>always</em> use the models through <code class="prettyprint">req.models</code> instead of requiring them directly. What
<a href="#bindknex"><code class="prettyprint">bindKnex</code></a> method actually does is that it creates an anonymous subclass of the model class and sets its
knex connection. That way the database connection doesn&rsquo;t change for the other requests that are currently being executed.</p>

<h2 id="sql-clause-precedence-and-parentheses">SQL clause precedence and parentheses</h2>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">orWhere</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>SQL:</p>
</blockquote>
<pre class="highlight sql"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Person"</span> <span class="k">where</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">and</span> <span class="p">(</span><span class="nv">"foo"</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">or</span> <span class="nv">"bar"</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</code></pre>
<p>You can add parentheses to queries by passing a function to the <a href="#where"><code class="prettyprint">where</code></a> method.</p>

<h2 id="default-values">Default values</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">jsonSchema</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
      <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">gender</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span>
          <span class="na">enum</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Male'</span><span class="p">,</span> <span class="s1">'Female'</span><span class="p">,</span> <span class="s1">'Other'</span><span class="p">],</span>
          <span class="na">default</span><span class="p">:</span> <span class="s1">'Female'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can set the default values for properties using the <code class="prettyprint">default</code> property in <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a>.</p>

<h2 id="composite-keys">Composite keys</h2>

<blockquote>
<p>Specifying a composite primary key for a model:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">idColumn</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">,</span> <span class="s1">'dateOfBirth'</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Specifying a relation using a composite primary key and a composite foreign key:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">'Person.firstName'</span><span class="p">,</span>
            <span class="s1">'Person.lastName'</span><span class="p">,</span>
            <span class="s1">'Person.dateOfBirth'</span>
          <span class="p">],</span>
          <span class="na">to</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">'Animal.ownerFirstName'</span><span class="p">,</span>
            <span class="s1">'Animal.ownerLastName'</span><span class="p">,</span>
            <span class="s1">'Animal.ownerDateOfBirth'</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>Compound keys are fully supported. Just give an array of columns where you would normally give a single column name.
Composite primary key can be specified by setting an array of column names to the <a href="#idcolumn"><code class="prettyprint">idColumn</code></a> of a model
class.</p>

<p>Here&rsquo;s a list of methods that may help working with composite keys:</p>

<ul>
<li><a href="#wherecomposite"><code class="prettyprint">whereComposite</code></a></li>
<li><a href="#whereincomposite"><code class="prettyprint">whereInComposite</code></a></li>
<li><a href="#findbyid"><code class="prettyprint">findById</code></a></li>
<li><a href="#deletebyid"><code class="prettyprint">deleteById</code></a></li>
<li><a href="#updateandfetchbyid"><code class="prettyprint">updateAndFetchById</code></a></li>
<li><a href="#patchandfetchbyid"><code class="prettyprint">patchAndFetchById</code></a></li>
<li><a href="#_s_id"><code class="prettyprint">$id</code></a></li>
<li><a href="#_s_values"><code class="prettyprint">$values</code></a></li>
</ul>

<h2 id="indexing-postgresql-jsonb-columns">Indexing PostgreSQL JSONB columns</h2>

<p>Good reading on the subject:</p>

<ul>
<li><a href="https://blog.2ndquadrant.com/jsonb-type-performance-postgresql-9-4/">JSONB type performance in PostgreSQL 9.4</a> and</li>
<li><a href="http://paquier.xyz/postgresql-2/postgres-9-4-feature-highlight-indexing-jsonb/">Postgres 9.4 feature highlight - Indexing JSON data with jsonb data type</a>.</li>
</ul>

<h3 id="general-inverted-indexes-a-k-a-gin">General Inverted Indexes a.k.a. GIN</h3>

<p>This is the index type which makes all JSONB set operations fast. All <code class="prettyprint">isSuperset</code> / <code class="prettyprint">isSubset</code> / <code class="prettyprint">hasKeys</code> / <code class="prettyprint">hasValues</code> etc. queries can use this index to speed â€™em up. Usually this is the index you want and it may take around 30% extra space on the DB server.</p>

<p>If one likes to use only the subset/superset operators with faster and smaller index one can give an extra <code class="prettyprint">path_ops</code> parameter when creating the index: <a href="https://wiki.postgresql.org/wiki/What's_new_in_PostgreSQL_9.4">â€œThe path_ops index supports only the search path operator <code class="prettyprint">@&gt;</code> (see below), but produces a smaller and faster index for these kinds of searches.â€</a>. According to Marco Nenciariniâ€™s post the speed up can be over 600% compared to full GIN index and the size of the index is reduced from ~30% -&gt; ~20%.</p>

<blockquote>
<p>Full GIN index to speed up all type of json queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'CREATE INDEX on ?? USING GIN (??)'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">])</span>
</code></pre>
<blockquote>
<p>Partial GIN index to speed up all subset / superset type of json queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'CREATE INDEX on ?? USING GIN (?? jsonb_path_ops)'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Place'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">])</span>
</code></pre>
<h3 id="index-on-expression">Index on Expression</h3>

<p>Another type of index one may use for JSONB field is to create an expression index for example for a certain JSON field inside a column.</p>

<p>You might want to use these if you are using lots of <code class="prettyprint">.where(ref(&#39;jsonColumn:details.name&#39;).castText(), &#39;marilyn&#39;)</code> type of queries, which cannot be sped up with GIN index.</p>

<p>Use of these indexes are more limited, but they are also somewhat faster than using GIN and querying e.g. <code class="prettyprint">{ field: value }</code> with subset operator. GIN indices also takes a lot of space in compared to expression index for certain field. So if you want to make just certain query to go extra fast you may consider using index on expression.</p>

<blockquote>
<p>An expression index referring an internal <code class="prettyprint">details.name</code> attribute of an object stored in <code class="prettyprint">jsonColumn</code>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"CREATE INDEX on ?? ((??#&gt;&gt;'{details,name}'))"</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'jsonColumn'</span><span class="p">])</span>
</code></pre>
<h3 id="complete-migration-example-and-created-tables-indexes">Complete Migration Example and Created Tables / Indexes</h3>

<p>Complete example how to try out different index choices.</p>

<blockquote>
<p>Migration:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">up</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">knex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span>
    <span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">jsonb</span><span class="p">(</span><span class="s1">'details'</span><span class="p">);</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="s1">'homeId'</span><span class="p">).</span><span class="nx">unsigned</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">inTable</span><span class="p">(</span><span class="s1">'Place'</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">raw</span><span class="p">(</span>
      <span class="s1">'CREATE INDEX on ?? USING GIN (??)'</span><span class="p">,</span>
      <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="nx">raw</span><span class="p">(</span>
      <span class="s2">"CREATE INDEX on ?? ((??#&gt;&gt;'{type}'))"</span><span class="p">,</span>
      <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="s1">'Place'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">jsonb</span><span class="p">(</span><span class="s1">'details'</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">raw</span><span class="p">(</span>
      <span class="s1">'CREATE INDEX on ?? USING GIN (?? jsonb_path_ops)'</span><span class="p">,</span>
      <span class="p">[</span><span class="s1">'Place'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">]</span>
    <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<blockquote>
<p>Results following schema:</p>
</blockquote>
<pre class="highlight sql"><code><span class="n">objection</span><span class="o">-</span><span class="n">jsonb</span><span class="o">-</span><span class="n">example</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="nv">"Hero"</span>
            <span class="k">Table</span> <span class="nv">"public.Hero"</span>
 <span class="k">Column</span>  <span class="o">|</span>          <span class="k">Type</span>
<span class="c1">---------+------------------------</span>
 <span class="n">id</span>      <span class="o">|</span> <span class="n">integer</span>
 <span class="n">name</span>    <span class="o">|</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
 <span class="n">details</span> <span class="o">|</span> <span class="n">jsonb</span>
 <span class="n">homeId</span>  <span class="o">|</span> <span class="n">integer</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="nv">"Hero_pkey"</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="nv">"Hero_details_idx"</span> <span class="n">gin</span> <span class="p">(</span><span class="n">details</span><span class="p">)</span>
    <span class="nv">"Hero_expr_idx"</span> <span class="n">btree</span> <span class="p">((</span><span class="n">details</span> <span class="o">#&gt;&gt;</span> <span class="s1">'{type}'</span><span class="p">::</span><span class="n">text</span><span class="p">[]))</span>

<span class="n">objection</span><span class="o">-</span><span class="n">jsonb</span><span class="o">-</span><span class="n">example</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="nv">"Place"</span>
           <span class="k">Table</span> <span class="nv">"public.Place"</span>
 <span class="k">Column</span>  <span class="o">|</span>          <span class="k">Type</span>
<span class="c1">---------+------------------------</span>
 <span class="n">id</span>      <span class="o">|</span> <span class="n">integer</span>
 <span class="n">name</span>    <span class="o">|</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
 <span class="n">details</span> <span class="o">|</span> <span class="n">jsonb</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="nv">"Place_pkey"</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="nv">"Place_details_idx"</span> <span class="n">gin</span> <span class="p">(</span><span class="n">details</span> <span class="n">jsonb_path_ops</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Expression index is used for example for following query:</p>
</blockquote>
<pre class="highlight sql"><code><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Hero"</span> <span class="k">where</span> <span class="n">details</span><span class="o">#&gt;&gt;</span><span class="s1">'{type}'</span> <span class="o">=</span> <span class="s1">'Hero'</span><span class="p">;</span>

                           <span class="n">QUERY</span> <span class="n">PLAN</span>
<span class="c1">----------------------------------------------------------------</span>
 <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="nv">"Hero_expr_idx"</span> <span class="k">on</span> <span class="nv">"Hero"</span>
   <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">((</span><span class="n">details</span> <span class="o">#&gt;&gt;</span> <span class="s1">'{type}'</span><span class="p">::</span><span class="n">text</span><span class="p">[])</span> <span class="o">=</span> <span class="s1">'Hero'</span><span class="p">::</span><span class="n">text</span><span class="p">)</span>
</code></pre>
      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
