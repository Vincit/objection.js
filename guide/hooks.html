<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Hooks | Objection.js</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.3da53256.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.aac9f1d1.js" as="script"><link rel="preload" href="/objection.js/assets/js/2.95f20b73.js" as="script"><link rel="preload" href="/objection.js/assets/js/1.317fd1a4.js" as="script"><link rel="preload" href="/objection.js/assets/js/46.7926c441.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/10.8a0f09eb.js"><link rel="prefetch" href="/objection.js/assets/js/11.bbb59564.js"><link rel="prefetch" href="/objection.js/assets/js/14.bb8bba7c.js"><link rel="prefetch" href="/objection.js/assets/js/15.bc71fa15.js"><link rel="prefetch" href="/objection.js/assets/js/16.1015d7dd.js"><link rel="prefetch" href="/objection.js/assets/js/17.ab0dd903.js"><link rel="prefetch" href="/objection.js/assets/js/18.a3b06a8a.js"><link rel="prefetch" href="/objection.js/assets/js/19.5c3531e2.js"><link rel="prefetch" href="/objection.js/assets/js/20.2af5813f.js"><link rel="prefetch" href="/objection.js/assets/js/21.6a6c2510.js"><link rel="prefetch" href="/objection.js/assets/js/22.eee14584.js"><link rel="prefetch" href="/objection.js/assets/js/23.6778d240.js"><link rel="prefetch" href="/objection.js/assets/js/24.c29fb8d5.js"><link rel="prefetch" href="/objection.js/assets/js/25.b88ad4e1.js"><link rel="prefetch" href="/objection.js/assets/js/26.9731c624.js"><link rel="prefetch" href="/objection.js/assets/js/27.2309824e.js"><link rel="prefetch" href="/objection.js/assets/js/28.9cd4116c.js"><link rel="prefetch" href="/objection.js/assets/js/29.9bc7197a.js"><link rel="prefetch" href="/objection.js/assets/js/3.67dbd821.js"><link rel="prefetch" href="/objection.js/assets/js/30.1547f4b8.js"><link rel="prefetch" href="/objection.js/assets/js/31.b88bc1d1.js"><link rel="prefetch" href="/objection.js/assets/js/32.66fe2719.js"><link rel="prefetch" href="/objection.js/assets/js/33.e8009bdb.js"><link rel="prefetch" href="/objection.js/assets/js/34.f1f78902.js"><link rel="prefetch" href="/objection.js/assets/js/35.207a938f.js"><link rel="prefetch" href="/objection.js/assets/js/36.b95f3f00.js"><link rel="prefetch" href="/objection.js/assets/js/37.4f09d1c0.js"><link rel="prefetch" href="/objection.js/assets/js/38.95ee9973.js"><link rel="prefetch" href="/objection.js/assets/js/39.5d0d1076.js"><link rel="prefetch" href="/objection.js/assets/js/4.45d2dbd6.js"><link rel="prefetch" href="/objection.js/assets/js/40.1106236d.js"><link rel="prefetch" href="/objection.js/assets/js/41.2819fb93.js"><link rel="prefetch" href="/objection.js/assets/js/42.46aedc9e.js"><link rel="prefetch" href="/objection.js/assets/js/43.97f8a0cf.js"><link rel="prefetch" href="/objection.js/assets/js/44.108db8aa.js"><link rel="prefetch" href="/objection.js/assets/js/45.0b550365.js"><link rel="prefetch" href="/objection.js/assets/js/47.2eb7ded0.js"><link rel="prefetch" href="/objection.js/assets/js/48.f94e2444.js"><link rel="prefetch" href="/objection.js/assets/js/49.a31c4e2f.js"><link rel="prefetch" href="/objection.js/assets/js/5.4784c48b.js"><link rel="prefetch" href="/objection.js/assets/js/50.e7cbb678.js"><link rel="prefetch" href="/objection.js/assets/js/51.9cce1f3f.js"><link rel="prefetch" href="/objection.js/assets/js/52.640685d3.js"><link rel="prefetch" href="/objection.js/assets/js/53.5926f518.js"><link rel="prefetch" href="/objection.js/assets/js/54.672b4e20.js"><link rel="prefetch" href="/objection.js/assets/js/55.2684a066.js"><link rel="prefetch" href="/objection.js/assets/js/56.28c3b1d4.js"><link rel="prefetch" href="/objection.js/assets/js/57.d32a8c76.js"><link rel="prefetch" href="/objection.js/assets/js/58.7ef64bdc.js"><link rel="prefetch" href="/objection.js/assets/js/59.57d27807.js"><link rel="prefetch" href="/objection.js/assets/js/6.d162f3c7.js"><link rel="prefetch" href="/objection.js/assets/js/60.fa4c2ff7.js"><link rel="prefetch" href="/objection.js/assets/js/61.03e12088.js"><link rel="prefetch" href="/objection.js/assets/js/62.9237edcc.js"><link rel="prefetch" href="/objection.js/assets/js/63.7f748604.js"><link rel="prefetch" href="/objection.js/assets/js/64.309afa4e.js"><link rel="prefetch" href="/objection.js/assets/js/65.5408ec5a.js"><link rel="prefetch" href="/objection.js/assets/js/66.255018e8.js"><link rel="prefetch" href="/objection.js/assets/js/67.8fe54358.js"><link rel="prefetch" href="/objection.js/assets/js/68.2f58527c.js"><link rel="prefetch" href="/objection.js/assets/js/69.1be647c6.js"><link rel="prefetch" href="/objection.js/assets/js/7.a905ae32.js"><link rel="prefetch" href="/objection.js/assets/js/70.499b7621.js"><link rel="prefetch" href="/objection.js/assets/js/71.1caae563.js"><link rel="prefetch" href="/objection.js/assets/js/72.9fe3e8ea.js"><link rel="prefetch" href="/objection.js/assets/js/73.adc7a66e.js"><link rel="prefetch" href="/objection.js/assets/js/74.051786cd.js"><link rel="prefetch" href="/objection.js/assets/js/75.3f83663e.js"><link rel="prefetch" href="/objection.js/assets/js/8.e75082ac.js"><link rel="prefetch" href="/objection.js/assets/js/9.0594e08f.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.08d45e08.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.3da53256.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" class="nav-link">
  Migration to 3.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v2/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v2.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ‚≠ê Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" class="nav-link">
  Migration to 3.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v2/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v2.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ‚≠ê Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/objection.js/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/objection.js/guide/getting-started.html" class="sidebar-link">Getting started</a></li><li><a href="/objection.js/guide/models.html" class="sidebar-link">Models</a></li><li><a href="/objection.js/guide/relations.html" class="sidebar-link">Relations</a></li><li><a href="/objection.js/guide/query-examples.html" class="sidebar-link">Query examples</a></li><li><a href="/objection.js/guide/transactions.html" class="sidebar-link">Transactions</a></li><li><a href="/objection.js/guide/hooks.html" aria-current="page" class="active sidebar-link">Hooks</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/hooks.html#instance-query-hooks" class="sidebar-link">Instance query hooks</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/hooks.html#static-query-hooks" class="sidebar-link">Static query hooks</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/hooks.html#model-data-lifecycle-hooks" class="sidebar-link">Model data lifecycle hooks</a></li></ul></li><li><a href="/objection.js/guide/validation.html" class="sidebar-link">Validation</a></li><li><a href="/objection.js/guide/documents.html" class="sidebar-link">Documents</a></li><li><a href="/objection.js/guide/plugins.html" class="sidebar-link">Plugins</a></li><li><a href="/objection.js/guide/contributing.html" class="sidebar-link">Contribution guide</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="hooks"><a href="#hooks" class="header-anchor">#</a> Hooks</h1> <p>Hooks are model methods that allow you too hook into different stages of objection queries. There are three different kinds of hooks</p> <ol><li><a href="#instance-query-hooks">instance query hooks</a></li> <li><a href="#static-query-hooks">static query hooks</a></li> <li><a href="#model-data-lifecycle-hooks">model data lifecycle hooks</a></li></ol> <p>Each hook type serve a different purpose. We'll go through the different types in the following chapters.</p> <h2 id="instance-query-hooks"><a href="#instance-query-hooks" class="header-anchor">#</a> Instance query hooks</h2> <p>These hooks are executed in different stages of each query type (find, update, insert, delete) for <strong>model instances</strong>. The following hooks exist:</p> <ul><li><a href="/objection.js/api/model/instance-methods.html#beforeinsert">$beforeInsert</a></li> <li><a href="/objection.js/api/model/instance-methods.html#afterinsert">$afterInsert</a></li> <li><a href="/objection.js/api/model/instance-methods.html#beforeupdate">$beforeUpdate</a></li> <li><a href="/objection.js/api/model/instance-methods.html#afterupdate">$afterUpdate</a></li> <li><a href="/objection.js/api/model/instance-methods.html#beforedelete">$beforeDelete</a></li> <li><a href="/objection.js/api/model/instance-methods.html#afterdelete">$afterDelete</a></li> <li><a href="/objection.js/api/model/instance-methods.html#afterfind">$afterFind</a></li></ul> <p>All of these are instance methods on a model. Therefore you can access the model instance's properties through <code>this</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token function">$beforeInsert</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>createdAt <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Instance hooks can be async. It allows you, among other things, to execute queries. If you do fire off queries from instance hooks, it's important to always make sure they are fired inside any existing transaction. You can access the transaction through the <code>context</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">$beforeInsert</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Remember to attach any queries to the existing transaction. This works</span>
    <span class="token comment">// even if there's no transaction, so you should just always pass the</span>
    <span class="token comment">// `context.transaction` to queries.</span>
    <span class="token keyword">await</span> SomeModel<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>transaction<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">whatever</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Warning!</p> <p>Running queries and other async operations inside instance hooks can lead to very unpredictable performance because the instance hooks are run for each model instance. For example, consider a query that returns 1000 items. If you have an <code>$afterFind</code> hook that executes a query, you'd be executing 1000 queries! The <a href="#static-query-hooks">static query hooks</a> are better suited for that kind of thing.</p></div> <p>Because the instance hooks are executed for model instances, they cannot be executed when there are no model instances available. Not all hooks can be implemented and some hooks are only executed in certain situations. There's no <code>$beforeFind</code> hook, because we don't have any model instances before the query is executed. There's nothing to call the hook for. <code>$beforeDelete</code> and <code>$afterDelete</code> are also a bit strange for this reason. They are <strong>only</strong> executed when you run an instance query like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> arnold <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Arnold'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This will execute the delete hooks because here we have a model</span>
<span class="token comment">// instance `arnold`.</span>
<span class="token keyword">await</span> arnold<span class="token punctuation">.</span><span class="token function">$query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This will NOT execute the delete hooks because we don't have model</span>
<span class="token comment">// instance for Arnold.</span>
<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'Arnold'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Objection could fetch the items from the database and call the hooks for those model instances, but that would lead to unpredicable performance, and that's something objection tries to avoid. If you need to do something like this, you can do it using <a href="#static-query-hooks">the static query hooks</a>.</p> <p>Another thing that may cause confusion with the instance hooks is that the insert and update hooks are always executed for the <strong>input</strong> items:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token function">$beforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// This will print 'Jennifer'</span>
<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> arnold <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Arnold'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This will also print 'Jennifer' and NOT 'Arnold'.</span>
<span class="token keyword">await</span> arnold<span class="token punctuation">.</span><span class="token function">$query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Each instance hook is passed the <a href="/objection.js/api/query-builder/other-methods.html#context">context</a> object as the only argument. The context contains whatever data you have installed using either the <a href="/objection.js/api/query-builder/other-methods.html#context">context</a> or the <a href="/objection.js/api/query-builder/other-methods.html#mergecontext">mergeContext</a> method. In addition to that, it always contains the <code>transaction</code> property that holds the parent query's transaction.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token function">$beforeUpdate</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>hello<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// This will print 'hello!'</span>
<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">mergeContext</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">hello</span><span class="token operator">:</span> <span class="token string">'hello!'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Note!</p> <p>If you use 3rd party plugins, it's very usual that they use the hooks to perform their magic. If any plugins are used, it's a good idea to always call the <code>super</code> implementation if you implement any of the hooks:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">SomePluginP</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">$beforeInsert</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">$beforeInsert</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">$afterFind</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">$afterFind</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h2 id="static-query-hooks"><a href="#static-query-hooks" class="header-anchor">#</a> Static query hooks</h2> <p>Static hooks are executed in different stages of each query type (find, update, insert, delete). Unlike the <a href="#instance-query-hooks">instance query hooks</a>, static hooks are executed once per query. Static hooks are always executed and there are no corner cases like the <code>$beforeDelete</code>/<code>$afterDelete</code> issue with instance hooks. The following hooks are available:</p> <ul><li><a href="/objection.js/api/model/static-methods.html#static-beforeinsert">beforeInsert</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-afterinsert">afterInsert</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-beforeupdate">beforeUpdate</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-afterupdate">afterUpdate</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-beforedelete">beforeDelete</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-afterdelete">afterDelete</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-beforefind">beforeFind</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-afterfind">afterFind</a></li></ul> <p>The static hooks are passed one argument of type <a href="/objection.js/api/types/#type-statichookarguments">StaticHookArguments</a>. The most interesting of all properties of that object is the <code>asFindQuery</code> parameter that allows you to fetch the items that were/would be affected by the query. For example the following example would fetch the identifiers of all people that would get deleted by the query being executed:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">beforeDelete</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> asFindQuery <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// This query will automatically be executed in the same transaction</span>
    <span class="token comment">// as the query we are hooking into.</span>
    <span class="token keyword">const</span> idsOfItemsToBeDeleted <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asFindQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">doSomethingWithIds</span><span class="token punctuation">(</span>idsOfItemsToBeDeleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The beauty of <code>asFindQuery</code> and the static hooks is that they work in all cases, no matter how complex your query is.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Warning!</p> <p>Even though the static hooks are only executed once per query, and <code>asFindQuery</code> only executes one additional query, it can still lead to bad performance. For example, consider this query that deletes all items in a table:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If <code>Person</code> has a hook that uses <code>asFindQuery</code> to fetch all items that will get deleted, the hook ends up fetching the whole table! Even if you simply select the <code>id</code>, the amount of data can be huge.</p> <p>Be careful with <code>asFindQuery</code>!</p></div> <p>Another interesting argument is the <code>cancelQuery</code> function. It allows you to cancel the query being executed. Used in conjunction with the <code>asFindQuery</code>, you can do stuff like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">beforeDelete</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> asFindQuery<span class="token punctuation">,</span> cancelQuery <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Even though `asFindQuery` returns a `select` query by default, you</span>
    <span class="token comment">// can turn it into an update, insert, delete or whatever you want.</span>
    <span class="token keyword">const</span> numAffectedItems <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">asFindQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">deleted</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Cancel the query being executed with `numAffectedItems`</span>
    <span class="token comment">// as the return value. No need to `await` this one.</span>
    <span class="token function">cancelQuery</span><span class="token punctuation">(</span>numAffectedItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The example above turns all delete queries into updates that set the <code>deleted</code> property to true. These two lines implement a simple version of a &quot;soft delete&quot; feature.</p> <p>You can also access the model instances for which the query is started, the input model instances and the relation. The next example should explain what each of them mean:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items<span class="token punctuation">,</span> inputItems<span class="token punctuation">,</span> relation <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'items:     '</span><span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'inputItems:'</span><span class="token punctuation">,</span> inputItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'relation:  '</span><span class="token punctuation">,</span> relation <span class="token operator">?</span> relation<span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token function">afterInsert</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> items<span class="token punctuation">,</span> inputItems<span class="token punctuation">,</span> relation <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'items:     '</span><span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'inputItems:'</span><span class="token punctuation">,</span> inputItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'relation:  '</span><span class="token punctuation">,</span> relation <span class="token operator">?</span> relation<span class="token punctuation">.</span>name <span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// items:      []</span>
<span class="token comment">// inputItems: [{ firstName: 'Jennifer' }]</span>
<span class="token comment">// relation:   none</span>

<span class="token keyword">await</span> jennifer<span class="token punctuation">.</span><span class="token function">$query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Aniston'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// items:      [{ id: 1, firstName: 'Jennifer' }]</span>
<span class="token comment">// inputItems: [{ lastName: 'Aniston' }]</span>
<span class="token comment">// relation:   none</span>

<span class="token keyword">await</span> jennifer<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;We're the Millers&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// items:      [{ id: 1, firstName: 'Jennifer' }]</span>
<span class="token comment">// inputItems: [{ name: &quot;We're the Millers&quot; }]</span>
<span class="token comment">// relation:   movies</span>

<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token punctuation">[</span>jennifer<span class="token punctuation">,</span> brad<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Cato'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Doggo'</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// items:      [{ id: 1, firstName: 'Jennifer' }, { id: 2, firstName: 'Brad' }]</span>
<span class="token comment">// inputItems: [{ name: 'Cato' }, { name: 'Doggo' }]</span>
<span class="token comment">// relation:   pets</span>
</code></pre></div><p>In <code>afterDelete</code>, <code>afterUpdate</code>, <code>afterInsert</code> and <code>afterFind</code> hooks, the <code>result</code> property of the input argument contains the result of the query. You can change the result by returning a non-undefined value from the hook:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token function">afterFind</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> result <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">,</span>
      <span class="token literal-property property">success</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>result<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Note!</p> <p>If you use 3rd party plugins, it's very usual that they use the hooks to perform their magic. If any plugins are used, it's a good idea to always call the <code>super</code> implementation if you implement any of the hooks:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">SomePlugin</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">beforeInsert</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">beforeInsert</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> asFindQuery<span class="token punctuation">,</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token function">afterFind</span><span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">afterFind</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> asFindQuery<span class="token punctuation">,</span> items <span class="token punctuation">}</span> <span class="token operator">=</span> args<span class="token punctuation">;</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <h2 id="model-data-lifecycle-hooks"><a href="#model-data-lifecycle-hooks" class="header-anchor">#</a> Model data lifecycle hooks</h2> <p>For the purposes of this explanation, let‚Äôs define three data layouts:</p> <ol><li><code>database</code>: The data layout returned by the database.</li> <li><code>internal</code>: The data layout of a model instance.</li> <li><code>external</code>: The data layout after calling model.toJSON().</li></ol> <p>Whenever data is converted from one layout to another a data lifecycle hook is called:</p> <ol><li><code>database</code> -&gt; <a href="/objection.js/api/model/instance-methods.html#parsedatabasejson">$parseDatabaseJson</a> -&gt; <code>internal</code></li> <li><code>internal</code> -&gt; <a href="/objection.js/api/model/instance-methods.html#formatdatabasejson">$formatDatabaseJson</a> -&gt; <code>database</code></li> <li><code>external</code> -&gt; <a href="/objection.js/api/model/instance-methods.html#parsejson">$parseJson</a> -&gt; <code>internal</code></li> <li><code>internal</code> -&gt; <a href="/objection.js/api/model/instance-methods.html#formatjson">$formatJson</a> -&gt; <code>external</code></li></ol> <p>So for example when the results of a query are read from the database the data goes through the <a href="/objection.js/api/model/instance-methods.html#parsedatabasejson">$parseDatabaseJson</a> method. When data is written to database it goes through the <a href="/objection.js/api/model/instance-methods.html#formatdatabasejson">$formatDatabaseJson</a> method.</p> <p>Similarly when you give data for a query (for example <a href="/objection.js/api/query-builder/mutate-methods.html#insert"><code>query().insert(req.body)</code></a>) or create a model explicitly using <a href="/objection.js/api/model/static-methods.html#static-fromjson"><code>Model.fromJson(obj)</code></a> the <a href="/objection.js/api/model/instance-methods.html#parsejson">$parseJson</a> method is invoked. When you call <a href="/objection.js/api/model/instance-methods.html#tojson"><code>model.toJSON()</code></a> or <a href="/objection.js/api/model/instance-methods.html#tojson"><code>model.$toJson()</code></a> the <a href="/objection.js/api/model/instance-methods.html#formatjson">$formatJson</a> is called.</p> <p>Note: Most libraries like <a href="http://expressjs.com/en/index.html" target="_blank" rel="noopener noreferrer">express<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <a href="https://koajs.com/" target="_blank" rel="noopener noreferrer">koa<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> automatically call the <a href="/objection.js/api/model/instance-methods.html#tojson">toJSON</a> method when you pass the model instance to methods like <code>response.json(model)</code>. You rarely need to call <a href="/objection.js/api/model/instance-methods.html#tojson">toJSON()</a> or <a href="/objection.js/api/model/instance-methods.html#tojson">$toJson()</a> explicitly. This is because <code>JSON.stringify</code> calls the <code>toJSON</code> method and basically all libraries that create JSON strings use <code>JSON.stringify</code> under the hood.</p> <p>Data lifecycle hooks are always synchronous. They cannot be <code>async</code> or return promises.</p> <p>Fore example, here's a hook that converts date strings to <code>moment</code> instances when read from the database, and back to date strings when written to database:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// We use a hardcoded list here. Note that you can store these fields</span>
<span class="token comment">// for example as a static array in the model and access it through</span>
<span class="token comment">// this.constructor in the hooks, or read the values from `jsonSchema`</span>
<span class="token comment">// if you use it.</span>
<span class="token keyword">const</span> dateColumns <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'dateOfBirth'</span><span class="token punctuation">,</span> <span class="token string">'dateOfDeath'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token function">$parseDatabaseJson</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Remember to call the super implementation.</span>
    json <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">$parseDatabaseJson</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dateColumn <span class="token keyword">of</span> dateColumns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Remember to always check if the json object has the particular</span>
      <span class="token comment">// field. It may not exist if the user has used `select('id')`</span>
      <span class="token comment">// or any other select that excludes the field.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span>json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> json<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">$formatDatabaseJson</span><span class="token punctuation">(</span><span class="token parameter">json</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dateColumn <span class="token keyword">of</span> dateColumns<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Remember to always check if the json object has the particular field.</span>
      <span class="token comment">// It may not exist if the user updates or inserts a partial object.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> moment<span class="token punctuation">.</span><span class="token function">isMoment</span><span class="token punctuation">(</span>json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span> <span class="token operator">=</span> json<span class="token punctuation">[</span>dateColumn<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Remember to call the super implementation.</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">$formatDatabaseJson</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Be sure to read the special requirements for the data lifecycle hooks in their documentation.</p> <p><a href="/objection.js/api/model/instance-methods.html#parsedatabasejson">$parseDatabaseJson</a><br> <a href="/objection.js/api/model/instance-methods.html#formatdatabasejson">$formatDatabaseJson</a><br> <a href="/objection.js/api/model/instance-methods.html#parsejson">$parseJson</a><br> <a href="/objection.js/api/model/instance-methods.html#formatjson">$formatJson</a></p></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/objection.js/guide/transactions.html" class="prev">
        Transactions
      </a></span> <span class="next"><a href="/objection.js/guide/validation.html">
        Validation
      </a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/objection.js/assets/js/app.aac9f1d1.js" defer></script><script src="/objection.js/assets/js/2.95f20b73.js" defer></script><script src="/objection.js/assets/js/1.317fd1a4.js" defer></script><script src="/objection.js/assets/js/46.7926c441.js" defer></script>
  </body>
</html>
