<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query examples | Objection.js</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.3da53256.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.aac9f1d1.js" as="script"><link rel="preload" href="/objection.js/assets/js/2.95f20b73.js" as="script"><link rel="preload" href="/objection.js/assets/js/1.317fd1a4.js" as="script"><link rel="preload" href="/objection.js/assets/js/48.f94e2444.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/10.8a0f09eb.js"><link rel="prefetch" href="/objection.js/assets/js/11.bbb59564.js"><link rel="prefetch" href="/objection.js/assets/js/14.bb8bba7c.js"><link rel="prefetch" href="/objection.js/assets/js/15.bc71fa15.js"><link rel="prefetch" href="/objection.js/assets/js/16.1015d7dd.js"><link rel="prefetch" href="/objection.js/assets/js/17.ab0dd903.js"><link rel="prefetch" href="/objection.js/assets/js/18.a3b06a8a.js"><link rel="prefetch" href="/objection.js/assets/js/19.5c3531e2.js"><link rel="prefetch" href="/objection.js/assets/js/20.2af5813f.js"><link rel="prefetch" href="/objection.js/assets/js/21.6a6c2510.js"><link rel="prefetch" href="/objection.js/assets/js/22.eee14584.js"><link rel="prefetch" href="/objection.js/assets/js/23.6778d240.js"><link rel="prefetch" href="/objection.js/assets/js/24.c29fb8d5.js"><link rel="prefetch" href="/objection.js/assets/js/25.b88ad4e1.js"><link rel="prefetch" href="/objection.js/assets/js/26.9731c624.js"><link rel="prefetch" href="/objection.js/assets/js/27.2309824e.js"><link rel="prefetch" href="/objection.js/assets/js/28.9cd4116c.js"><link rel="prefetch" href="/objection.js/assets/js/29.9bc7197a.js"><link rel="prefetch" href="/objection.js/assets/js/3.67dbd821.js"><link rel="prefetch" href="/objection.js/assets/js/30.1547f4b8.js"><link rel="prefetch" href="/objection.js/assets/js/31.b88bc1d1.js"><link rel="prefetch" href="/objection.js/assets/js/32.66fe2719.js"><link rel="prefetch" href="/objection.js/assets/js/33.e8009bdb.js"><link rel="prefetch" href="/objection.js/assets/js/34.f1f78902.js"><link rel="prefetch" href="/objection.js/assets/js/35.207a938f.js"><link rel="prefetch" href="/objection.js/assets/js/36.b95f3f00.js"><link rel="prefetch" href="/objection.js/assets/js/37.4f09d1c0.js"><link rel="prefetch" href="/objection.js/assets/js/38.95ee9973.js"><link rel="prefetch" href="/objection.js/assets/js/39.5d0d1076.js"><link rel="prefetch" href="/objection.js/assets/js/4.45d2dbd6.js"><link rel="prefetch" href="/objection.js/assets/js/40.1106236d.js"><link rel="prefetch" href="/objection.js/assets/js/41.2819fb93.js"><link rel="prefetch" href="/objection.js/assets/js/42.46aedc9e.js"><link rel="prefetch" href="/objection.js/assets/js/43.97f8a0cf.js"><link rel="prefetch" href="/objection.js/assets/js/44.108db8aa.js"><link rel="prefetch" href="/objection.js/assets/js/45.0b550365.js"><link rel="prefetch" href="/objection.js/assets/js/46.7926c441.js"><link rel="prefetch" href="/objection.js/assets/js/47.2eb7ded0.js"><link rel="prefetch" href="/objection.js/assets/js/49.a31c4e2f.js"><link rel="prefetch" href="/objection.js/assets/js/5.4784c48b.js"><link rel="prefetch" href="/objection.js/assets/js/50.e7cbb678.js"><link rel="prefetch" href="/objection.js/assets/js/51.9cce1f3f.js"><link rel="prefetch" href="/objection.js/assets/js/52.640685d3.js"><link rel="prefetch" href="/objection.js/assets/js/53.5926f518.js"><link rel="prefetch" href="/objection.js/assets/js/54.672b4e20.js"><link rel="prefetch" href="/objection.js/assets/js/55.2684a066.js"><link rel="prefetch" href="/objection.js/assets/js/56.28c3b1d4.js"><link rel="prefetch" href="/objection.js/assets/js/57.d32a8c76.js"><link rel="prefetch" href="/objection.js/assets/js/58.7ef64bdc.js"><link rel="prefetch" href="/objection.js/assets/js/59.57d27807.js"><link rel="prefetch" href="/objection.js/assets/js/6.d162f3c7.js"><link rel="prefetch" href="/objection.js/assets/js/60.fa4c2ff7.js"><link rel="prefetch" href="/objection.js/assets/js/61.03e12088.js"><link rel="prefetch" href="/objection.js/assets/js/62.9237edcc.js"><link rel="prefetch" href="/objection.js/assets/js/63.7f748604.js"><link rel="prefetch" href="/objection.js/assets/js/64.309afa4e.js"><link rel="prefetch" href="/objection.js/assets/js/65.5408ec5a.js"><link rel="prefetch" href="/objection.js/assets/js/66.255018e8.js"><link rel="prefetch" href="/objection.js/assets/js/67.8fe54358.js"><link rel="prefetch" href="/objection.js/assets/js/68.2f58527c.js"><link rel="prefetch" href="/objection.js/assets/js/69.1be647c6.js"><link rel="prefetch" href="/objection.js/assets/js/7.a905ae32.js"><link rel="prefetch" href="/objection.js/assets/js/70.499b7621.js"><link rel="prefetch" href="/objection.js/assets/js/71.1caae563.js"><link rel="prefetch" href="/objection.js/assets/js/72.9fe3e8ea.js"><link rel="prefetch" href="/objection.js/assets/js/73.adc7a66e.js"><link rel="prefetch" href="/objection.js/assets/js/74.051786cd.js"><link rel="prefetch" href="/objection.js/assets/js/75.3f83663e.js"><link rel="prefetch" href="/objection.js/assets/js/8.e75082ac.js"><link rel="prefetch" href="/objection.js/assets/js/9.0594e08f.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.08d45e08.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.3da53256.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" class="nav-link">
  Migration to 3.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v2/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v2.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ‚≠ê Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" class="nav-link">
  Migration to 3.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v2/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v2.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ‚≠ê Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/objection.js/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/objection.js/guide/getting-started.html" class="sidebar-link">Getting started</a></li><li><a href="/objection.js/guide/models.html" class="sidebar-link">Models</a></li><li><a href="/objection.js/guide/relations.html" class="sidebar-link">Relations</a></li><li><a href="/objection.js/guide/query-examples.html" aria-current="page" class="active sidebar-link">Query examples</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#basic-queries" class="sidebar-link">Basic queries</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#find-queries" class="sidebar-link">Find queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#insert-queries" class="sidebar-link">Insert queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#update-queries" class="sidebar-link">Update queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#delete-queries" class="sidebar-link">Delete queries</a></li></ul></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-queries" class="sidebar-link">Relation queries</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-find-queries" class="sidebar-link">Relation find queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-insert-queries" class="sidebar-link">Relation insert queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-relate-queries" class="sidebar-link">Relation relate queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-unrelate-queries" class="sidebar-link">Relation unrelate queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-update-queries" class="sidebar-link">Relation update queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-delete-queries" class="sidebar-link">Relation delete queries</a></li></ul></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#eager-loading" class="sidebar-link">Eager loading</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#graph-inserts" class="sidebar-link">Graph inserts</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#graph-upserts" class="sidebar-link">Graph upserts</a></li></ul></li><li><a href="/objection.js/guide/transactions.html" class="sidebar-link">Transactions</a></li><li><a href="/objection.js/guide/hooks.html" class="sidebar-link">Hooks</a></li><li><a href="/objection.js/guide/validation.html" class="sidebar-link">Validation</a></li><li><a href="/objection.js/guide/documents.html" class="sidebar-link">Documents</a></li><li><a href="/objection.js/guide/plugins.html" class="sidebar-link">Plugins</a></li><li><a href="/objection.js/guide/contributing.html" class="sidebar-link">Contribution guide</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="query-examples"><a href="#query-examples" class="header-anchor">#</a> Query examples</h1> <p>The <code>Person</code> model used in the examples is defined <a href="/objection.js/guide/models.html#examples">here</a>.</p> <p>All queries are started with one of the <a href="/objection.js/api/model/">Model</a> methods <a href="/objection.js/api/model/static-methods.html#static-query">query</a>, <a href="/objection.js/api/model/instance-methods.html#query">$query</a>, <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> or <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a>. All these methods return a <a href="/objection.js/api/query-builder/">QueryBuilder</a> instance that can be used just like a <a href="https://knexjs.org/guide/query-builder.html" target="_blank" rel="noopener noreferrer">knex QueryBuilder<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> but they also have a bunch of methods added by objection.</p> <p>Note that you can chain <a href="/objection.js/api/query-builder/other-methods.html#debug">debug()</a> to any query to get the executed SQL printed to console.</p> <h2 id="basic-queries"><a href="#basic-queries" class="header-anchor">#</a> Basic queries</h2> <h3 id="find-queries"><a href="#find-queries" class="header-anchor">#</a> Find queries</h3> <p>Find queries can be created by calling <a href="/objection.js/api/model/static-methods.html#static-query">Model.query()</a> and chaining query builder methods for the returned
<a href="/objection.js/api/query-builder/">QueryBuilder</a> instance.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/recipes/subqueries.html">subqueries</a></li> <li><a href="/objection.js/recipes/raw-queries.html">raw queries</a></li> <li><a href="/objection.js/recipes/precedence-and-parentheses.html">precedence and parentheses</a></li></ul> <p>There's also a large amount of examples in the <a href="/objection.js/api/query-builder/">API documentation</a>.</p> <h5 id="examples"><a href="#examples" class="header-anchor">#</a> Examples</h5> <p>Fetch an item by id:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>Fetch all people from the database:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'there are'</span><span class="token punctuation">,</span> people<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">'People in total'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
</code></pre></div><p>The return value of the <a href="/objection.js/api/model/static-methods.html#static-query">query</a> method is an instance of <a href="/objection.js/api/query-builder/">QueryBuilder</a> that has all the methods a <a href="http://knexjs.org/#Builder" target="_blank" rel="noopener noreferrer">knex QueryBuilder<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> has and a lot more. Here is a simple example that uses some of them:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> middleAgedJennifers <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'lastName'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'Jennifer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'lastName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The last name of the first middle aged Jennifer is'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>middleAgedJennifers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lastName&quot;</span>
<span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&gt;</span> <span class="token number">40</span>
<span class="token operator">and</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&lt;</span> <span class="token number">60</span>
<span class="token operator">and</span> <span class="token string">&quot;firstName&quot;</span> <span class="token operator">=</span> <span class="token string">'Jennifer'</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;lastName&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>The next example shows how easy it is to build complex queries:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'persons.*'</span><span class="token punctuation">,</span> <span class="token string">'parent.firstName as parentFirstName'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">innerJoin</span><span class="token punctuation">(</span><span class="token string">'persons as parent'</span><span class="token punctuation">,</span> <span class="token string">'persons.parentId'</span><span class="token punctuation">,</span> <span class="token string">'parent.id'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'persons.age'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">'persons.age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereExists</span><span class="token punctuation">(</span>
    Animal<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">whereColumn</span><span class="token punctuation">(</span><span class="token string">'persons.id'</span><span class="token punctuation">,</span> <span class="token string">'animals.ownerId'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'persons.lastName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>parentFirstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;firstName&quot;</span> <span class="token keyword">as</span> <span class="token string">&quot;parentFirstName&quot;</span>
<span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">as</span> <span class="token string">&quot;parent&quot;</span>
  <span class="token keyword">on</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;parentId&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;age&quot;</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token number">1</span>
  <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;lastName&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>In addition to knex methods, the <a href="/objection.js/api/query-builder/">QueryBuilder</a> has a lot of helpers for dealing with relations like the <a href="/objection.js/api/query-builder/join-methods.html#joinrelated">joinRelated</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'parent:parent.name as grandParentName'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">joinRelated</span><span class="token punctuation">(</span><span class="token string">'parent.parent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grandParentName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;parent:parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;firstName&quot;</span> <span class="token keyword">as</span> <span class="token string">&quot;grandParentName&quot;</span>
<span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">as</span> <span class="token string">&quot;parent&quot;</span>
  <span class="token keyword">on</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;parentId&quot;</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">as</span> <span class="token string">&quot;parent:parent&quot;</span>
  <span class="token keyword">on</span> <span class="token string">&quot;parent:parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;parentId&quot;</span>
</code></pre></div><p>Objection allows a bit more modern syntax with groupings and subqueries. Where knex requires you to use an old fashioned <code>function</code> an <code>this</code>, with objection you can use arrow functions:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nonMiddleAgedJennifers <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token parameter">builder</span> <span class="token operator">=&gt;</span> builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'Jennifer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'lastName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The last name of the first non middle aged Jennifer is'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nonMiddleAgedJennifers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span> <span class="token operator">&lt;</span> <span class="token number">40</span> <span class="token operator">or</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token string">&quot;firstName&quot;</span> <span class="token operator">=</span> <span class="token string">'Jennifer'</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;lastName&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><h3 id="insert-queries"><a href="#insert-queries" class="header-anchor">#</a> Insert queries</h3> <p>Insert queries are created by chaining the <a href="/objection.js/api/query-builder/mutate-methods.html#insert">insert</a> method to the query. See the <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method for inserting object graphs.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/api/query-builder/mutate-methods.html#insert">insert API reference</a></li> <li><a href="/objection.js/guide/query-examples.html#graph-inserts">graph inserts</a></li></ul> <h5 id="examples-2"><a href="#examples-2" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jennifer <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jennifer<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; 'Jennifer'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jennifer<span class="token punctuation">.</span><span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; 'Jennifer Lawrence'</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;persons&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lastName&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Jennifer'</span><span class="token punctuation">,</span> <span class="token string">'Lawrence'</span><span class="token punctuation">)</span>
</code></pre></div><p>Just like with any query, you can mix in <code>raw</code> statements, subqueries, <code>knex.raw</code> instances etc.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Average'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Person'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">age</span><span class="token operator">:</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="update-queries"><a href="#update-queries" class="header-anchor">#</a> Update queries</h3> <p>Update queries are created by chaining the <a href="/objection.js/api/query-builder/mutate-methods.html#update">update</a> or <a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch</a> method to the query. <a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch</a> and <a href="/objection.js/api/query-builder/mutate-methods.html#update">update</a> return the number of updated rows. If you want the freshly updated item as a result you can use the helper method <a href="/objection.js/api/query-builder/mutate-methods.html#patchandfetchbyid">patchAndFetchById</a> and <a href="/objection.js/api/query-builder/mutate-methods.html#updateandfetchbyid">updateAndFetchById</a>. On postgresql you can simply chain <a href="/objection.js/api/query-builder/find-methods.html#returning">.returning('*')</a> or take a look at <a href="/objection.js/recipes/returning-tricks.html">this recipe</a> for more ideas. See <a href="/objection.js/api/query-builder/mutate-methods.html#update">update</a> and <a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch</a> API documentation for discussion about their differences.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch API reference</a></li> <li><a href="/objection.js/recipes/raw-queries.html">raw queries</a></li></ul> <h5 id="examples-3"><a href="#examples-3" class="header-anchor">#</a> Examples</h5> <p>Update an item by id:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numUpdated <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">set</span> <span class="token string">&quot;firstName&quot;</span> <span class="token operator">=</span> <span class="token string">'Jennifer'</span> <span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>Update multiple items:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numUpdated <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Dinosaur'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'all people over 60 years old are now dinosaurs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>numUpdated<span class="token punctuation">,</span> <span class="token string">'people were updated'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">set</span> <span class="token string">&quot;lastName&quot;</span> <span class="token operator">=</span> <span class="token string">'Dinosaur'</span> <span class="token keyword">where</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&gt;</span> <span class="token number">60</span>
</code></pre></div><p>Update and fetch an item:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> updatedPerson <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">patchAndFetchById</span><span class="token punctuation">(</span><span class="token number">246</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Updated'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>updatedPerson<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; Updated.</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">set</span> <span class="token string">&quot;lastName&quot;</span> <span class="token operator">=</span> <span class="token string">'Updated'</span> <span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">246</span>
<span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">246</span>
</code></pre></div><h3 id="delete-queries"><a href="#delete-queries" class="header-anchor">#</a> Delete queries</h3> <p>Delete queries are created by chaining the <a href="/objection.js/api/query-builder/mutate-methods.html#delete">delete</a> method to the query.</p> <p>NOTE: The return value of the query will be the number of deleted rows. <em>If you're using Postgres take a look at <a href="/objection.js/recipes/returning-tricks.html">this recipe</a> if you'd like the deleted rows to be returned as Model instances</em>.</p> <h5 id="examples-4"><a href="#examples-4" class="header-anchor">#</a> Examples</h5> <p>Delete an item by id:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numDeleted <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><p>Delete multiple items:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numDeleted <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'lower(&quot;firstName&quot;)'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'like'</span><span class="token punctuation">,</span> <span class="token string">'%ennif%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>numDeleted<span class="token punctuation">,</span> <span class="token string">'people were deleted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> lower<span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%ennif%'</span>
</code></pre></div><p>You can always use <a href="/objection.js/recipes/subqueries.html">subqueries</a>, <a href="/objection.js/api/objection/#raw">raw</a>, <a href="/objection.js/api/objection/#ref">ref</a>, <a href="/objection.js/api/objection/#lit">lit</a> and all query building methods with <a href="/objection.js/api/query-builder/mutate-methods.html#delete">delete</a> queries, just like with every query in objection. With some databases, you cannot use joins with deletes (db restriction, not objection). You can replace joins with subqueries like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This query deletes all people that have a pet named &quot;Fluffy&quot;.</span>
<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereIn</span><span class="token punctuation">(</span>
    <span class="token string">'id'</span><span class="token punctuation">,</span>
    Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'persons.id'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">joinRelated</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'pets.name'</span><span class="token punctuation">,</span> <span class="token string">'Fluffy'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;persons.id&quot;</span>
  <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">join</span> <span class="token string">&quot;pets&quot;</span> <span class="token keyword">on</span> <span class="token string">&quot;pets.ownerId&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;persons.id&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;pets.name&quot;</span> <span class="token operator">=</span> <span class="token string">'Fluffy'</span>
<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This is another way to implement the previous query.</span>
<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereExists</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'pets.name'</span><span class="token punctuation">,</span> <span class="token string">'Fluffy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;pets&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span>
  <span class="token keyword">from</span> <span class="token string">&quot;pets&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;pets.ownerId&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;persons.id&quot;</span>
  <span class="token operator">and</span> <span class="token string">&quot;pets.name&quot;</span> <span class="token operator">=</span> <span class="token string">'Fluffy'</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="relation-queries"><a href="#relation-queries" class="header-anchor">#</a> Relation queries</h2> <p>While the static <a href="/objection.js/api/model/static-methods.html#static-query">query</a> method can be used to create a query to a whole table <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> and its instance method counterpart <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> can be used to query items related to another item. Both of these methods return an instance of <a href="/objection.js/api/query-builder/">QueryBuilder</a> just like the <a href="/objection.js/api/model/static-methods.html#static-query">query</a> method.</p> <h3 id="relation-find-queries"><a href="#relation-find-queries" class="header-anchor">#</a> Relation find queries</h3> <p>Simply call <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery('relationName')</a> for a model <em>instance</em> to fetch a relation for it. The relation name is given as the only argument. The return value is a <a href="/objection.js/api/query-builder/">QueryBuilder</a> so you once again have all the query methods at your disposal. In many cases it's more convenient to use <a href="/objection.js/guide/query-examples.html#eager-loading">eager loading</a> to fetch relations. <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> is better when you only need one relation and you need to filter the query extensively.</p> <p>The static method <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> can be used to create related queries for multiple items using identifiers, model instances or even subqueries. This allows you to build complex queries by composing simple pieces.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/recipes/relation-subqueries.html">relation subqueries</a></li> <li><a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a></li></ul> <h5 id="examples-5"><a href="#examples-5" class="header-anchor">#</a> Examples</h5> <p>This example fetches the person's pets. <code>'pets'</code> is the name of a relation defined in <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> person
  <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
<span class="token operator">and</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;name&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>The above example needed two queries to find pets of a person. You can do this with one single query using the static <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
<span class="token operator">and</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;name&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>With <code>HasManyRelation</code>s and <code>BelongsToOneRelation</code>s the <code>relatedQuery</code> helper may just seem like unnecessary bloat. You can of course simply write the SQL directly. The following code should be clear to anyone even without any objection experience:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> Pet<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'ownerId'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
<span class="token operator">and</span> <span class="token string">&quot;ownerId&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;name&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>The <code>relatedQuery</code> helper comes in handy with <code>ManyToManyRelation</code> where the needed SQL is more complex. it also provides a unified API for all kinds of relations. You can write the same code regardless of the relation type. Or you may simply prefer the <code>relatedQuery</code> style. Now back to the examples üòÉ</p> <p>If you want to fetch dogs for multiple people in one query, you can pass an array of identifiers to the <code>for</code> method like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
<span class="token operator">and</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;name&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>You can even give it a subquery! The following example fetches all dogs of all people named Jennifer using one single query:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Note that there is no `await` here. This query does not get executed.</span>
<span class="token comment">// jennifersSubQuery is of type QueryBuilder&lt;Person&gt;.</span>
<span class="token keyword">const</span> jennifersSubQuery <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'Jennifer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This is the only executed query in this example.</span>
<span class="token keyword">const</span> dogs <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>jennifersSubQuery<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
<span class="token operator">and</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span>
  <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;name&quot;</span> <span class="token operator">=</span> <span class="token string">'Jennifer'</span>
<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;name&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><h3 id="relation-insert-queries"><a href="#relation-insert-queries" class="header-anchor">#</a> Relation insert queries</h3> <p>Chain the <a href="/objection.js/api/query-builder/mutate-methods.html#insert">insert</a> method to a <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> or <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> call to insert a related object for an item. The query inserts a new object to the related table and updates the needed tables to create the relationship. In case of many-to-many relation a row is inserted to the join table etc. Also check out <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method for an alternative way to insert related models.</p> <h5 id="examples-6"><a href="#examples-6" class="header-anchor">#</a> Examples</h5> <p>Add a pet for a person:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fluffy <span class="token operator">=</span> <span class="token keyword">await</span> person<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Fluffy'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;animals&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ownerId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Fluffy'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>Just like with <a href="#relation-find-queries">relation find queries</a>, you can save a query and add a pet for a person using one single query by utilizing the static <code>relatedQuery</code> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> fluffy <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Fluffy'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;animals&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ownerId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Fluffy'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>If you want to write columns to the join table of a many-to-many relation you first need to specify the columns in the <code>extra</code> array of the <code>through</code> object in <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a> (see the examples behind the link). For example, if you specified an array <code>extra: ['awesomeness']</code> in <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a> then <code>awesomeness</code> is written to the join table in the following example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> movie <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'The room'</span><span class="token punctuation">,</span> <span class="token literal-property property">awesomeness</span><span class="token operator">:</span> <span class="token number">9001</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'best movie ever was added'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;movies&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'The room'</span><span class="token punctuation">)</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;persons_movies&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;movieId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;personId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;awesomeness&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">)</span>
</code></pre></div><p>See <a href="/objection.js/recipes/extra-properties.html">this recipe</a> for more information about <code>extra</code> properties.</p> <h3 id="relation-relate-queries"><a href="#relation-relate-queries" class="header-anchor">#</a> Relation relate queries</h3> <p>Relating means attaching a existing item to another item through a relationship defined in the <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a>.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/api/query-builder/mutate-methods.html#relate">relate method</a></li></ul> <h5 id="examples-7"><a href="#examples-7" class="header-anchor">#</a> Examples</h5> <p>In the following example we relate an actor to a movie. In this example the relation between <code>Person</code> and <code>Movie</code> is a many-to-many relation but <code>relate</code> also works for all other relation types.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> actor <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">100</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> movie <span class="token operator">=</span> <span class="token keyword">await</span> Movie<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;movies&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;movies&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">200</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> actor<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">relate</span><span class="token punctuation">(</span>movie<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;persons_movies&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;personId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;movieId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
</code></pre></div><p>You can also pass the id <code>200</code> directly to <code>relate</code> instead of passing a model instance. A more objectiony way of doing this would be to once again utilize the static <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">relate</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;persons_movies&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;personId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;movieId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span>
</code></pre></div><p>Actually in this case, the cleanest way of all would be to just insert a row to the <code>persons_movies</code> table. Note that you can create models for pivot (join) tables too. There's nothing wrong with that.</p> <p>Here's one more example that relates four movies to the first person whose first name Arnold. Note that this query only works on Postgres because on other databases it would require multiple queries.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>
    Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'Arnold'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">relate</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="relation-unrelate-queries"><a href="#relation-unrelate-queries" class="header-anchor">#</a> Relation unrelate queries</h3> <p>Unrelating is the inverse of <a href="#relation-relate-queries">relating</a>. For example if an actor is related to a movie through a <code>movies</code> relation, unrelating them means removing this association, but neither the movie nor the actor get deleted from the database.</p> <h5 id="examples-8"><a href="#examples-8" class="header-anchor">#</a> Examples</h5> <p>The first example <code>unrelates</code> all movies whose name starts with the string 'Terminator' from an actor.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> actor <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">100</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> actor
  <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">unrelate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'like'</span><span class="token punctuation">,</span> <span class="token string">'Terminator%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons_movies&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;persons_movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;personId&quot;</span> <span class="token operator">=</span> <span class="token number">100</span>
<span class="token keyword">where</span> <span class="token string">&quot;persons_movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;movieId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token keyword">from</span> <span class="token string">&quot;movies&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;name&quot;</span> <span class="token operator">like</span> <span class="token string">'Terminator%'</span>
<span class="token punctuation">)</span>
</code></pre></div><p>The same using the static <a href="/objection.js/api/model/static-methods.html#static-relatedquery">relatedQuery</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">unrelate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'like'</span><span class="token punctuation">,</span> <span class="token string">'Terminator%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons_movies&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;persons_movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;personId&quot;</span> <span class="token operator">=</span> <span class="token number">100</span>
<span class="token operator">and</span> <span class="token string">&quot;persons_movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;movieId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span>
  <span class="token keyword">from</span> <span class="token string">&quot;movies&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;name&quot;</span> <span class="token operator">like</span> <span class="token string">'Terminator%'</span>
<span class="token punctuation">)</span>
</code></pre></div><p>The next query removes all Terminator movies from Arnold Schwarzenegger:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Once again, note that we don't await this query. This query</span>
<span class="token comment">// is not executed. It's a placeholder that will be used to build</span>
<span class="token comment">// a subquery when the `relatedQuery` gets executed.</span>
<span class="token keyword">const</span> arnold <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Arnold'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Schwarzenegger'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span>arnold<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">unrelate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'like'</span><span class="token punctuation">,</span> <span class="token string">'Terminator%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons_movies&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;persons_movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;personId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span>
  <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;firstName&quot;</span> <span class="token operator">=</span> <span class="token string">'Arnold'</span>
  <span class="token operator">and</span> <span class="token string">&quot;lastName&quot;</span> <span class="token operator">=</span> <span class="token string">'Schwarzenegger'</span>
<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token string">&quot;persons_movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;movieId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;movies&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span>
  <span class="token keyword">from</span> <span class="token string">&quot;movies&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;name&quot;</span> <span class="token operator">like</span> <span class="token string">'Terminator%'</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="relation-update-queries"><a href="#relation-update-queries" class="header-anchor">#</a> Relation update queries</h3> <p>Relation update queries work just like the normal update queries, but the query is automatically filtered so that only the related items are affected.</p> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#update">API documentation</a> of <code>update</code> method.</p> <h5 id="examples-9"><a href="#examples-9" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token function">raw</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">concat(name, ' the doggo')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">set</span> <span class="token string">&quot;name&quot;</span> <span class="token operator">=</span> concat<span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">' the doggo'</span><span class="token punctuation">)</span>
<span class="token keyword">where</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
</code></pre></div><h3 id="relation-delete-queries"><a href="#relation-delete-queries" class="header-anchor">#</a> Relation delete queries</h3> <p>Relation delete queries work just like the normal delete queries, but the query is automatically filtered so that only the related items are affected.</p> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#delete">API documentation</a> of <code>delete</code> method.</p> <h5 id="examples-10"><a href="#examples-10" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
</code></pre></div><h2 id="eager-loading"><a href="#eager-loading" class="header-anchor">#</a> Eager loading</h2> <p>You can fetch an arbitrary graph of relations for the results of any query by chaining the <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a> or <a href="/objection.js/api/query-builder/eager-methods.html#withgraphjoined">withGraphJoined</a> method. Both methods take a <a href="/objection.js/api/types/#type-relationexpression">relation expression</a> as the first argument. In addition to making your life easier, eager loading avoids the &quot;N+1 selects&quot; problem and provide a great performance.</p> <p>Because the relation expressions are strings (there's also an optional <a href="/objection.js/api/types/#relationexpression-object-notation">object notation</a>) they can be easily passed, for example, as a query parameter of an HTTP request. However, allowing the client to execute expressions like this without any limitations is not very secure. Therefore the <a href="/objection.js/api/query-builder/">QueryBuilder</a> has the <a href="/objection.js/api/query-builder/eager-methods.html#allowgraph">allowGraph</a> method. <a href="/objection.js/api/query-builder/eager-methods.html#allowgraph">allowGraph</a> can be used to limit the allowed relation expression to a certain subset.</p> <p>By giving the expression <code>[pets, children.pets]</code> for <a href="/objection.js/api/query-builder/eager-methods.html#allowgraph">allowGraph</a> the value passed to <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a> is allowed to be one of:</p> <ul><li><code>'pets'</code></li> <li><code>'children'</code></li> <li><code>'children.pets'</code></li> <li><code>'[pets, children]'</code></li> <li><code>'[pets, children.pets]'</code></li></ul> <p>Examples of expressions that would cause an error:</p> <ul><li><code>'movies'</code></li> <li><code>'children.children'</code></li> <li><code>'[pets, children.children]'</code></li> <li><code>'notEvenAnExistingRelation'</code></li></ul> <p>In addition to the <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a> and <a href="/objection.js/api/query-builder/eager-methods.html#withgraphjoined">withGraphJoined</a> methods, relations can be fetched using the <a href="/objection.js/api/model/static-properties.html#static-fetchgraph">fetchGraph</a> and
<a href="/objection.js/api/model/instance-methods.html#fetchgraph">$fetchGraph</a> methods.</p> <p><a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a> uses multiple queries to load the related items. (for details see <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/" target="_blank" rel="noopener noreferrer">this blog post<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Note that <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a> used to be called <code>eager</code>.). <a href="/objection.js/api/query-builder/eager-methods.html#withgraphjoined">withGraphJoined</a> uses joins and only performs one single query to fetch the whole relation graph. This doesn't mean that <code>withGraphJoined</code> is faster though. See the performance discussion <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">here</a>. You should only use <code>withGraphJoined</code> if you actually need the joins to be able to reference the nested tables. When in doubt use <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a>.</p> <h5 id="examples-11"><a href="#examples-11" class="header-anchor">#</a> Examples</h5> <p>Fetch the <code>pets</code> relation for all results of a query:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Each person has the `pets` property populated with Animal objects related</span>
<span class="token comment">// through the `pets` relation.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Animal</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
</code></pre></div><p>Fetch multiple relations on multiple levels:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span>
  <span class="token string">'[pets, children.[pets, children]]'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Each person has the `pets` property populated with Animal objects related</span>
<span class="token comment">// through the `pets` relation. The `children` property contains the Person's</span>
<span class="token comment">// children. Each child also has the `pets` and `children` relations eagerly</span>
<span class="token comment">// fetched.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Here's the previous query using the <a href="/objection.js/api/types/#relationexpression-object-notation">object notation</a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Fetch one relation recursively:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token string">'[pets, children.^]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The children relation is from Person to Person. If we want to fetch the whole</span>
<span class="token comment">// descendant tree of a person we can just say &quot;fetch this relation recursively&quot;</span>
<span class="token comment">// using the `.^` notation.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
  people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstName
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Limit recursion to 3 levels:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token string">'[pets, children.^3]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Relations can be modified using the <a href="/objection.js/api/query-builder/other-methods.html#modifygraph">modifyGraph</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token string">'[children.[pets, movies], movies]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">modifyGraph</span><span class="token punctuation">(</span><span class="token string">'children.pets'</span><span class="token punctuation">,</span> <span class="token parameter">builder</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only select pets older than 10 years old for children</span>
    <span class="token comment">// and only return their names.</span>
    builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Relations can also be modified using modifiers like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span>
    <span class="token string">'[pets(selectName, onlyDogs), children(orderByAge).[pets, children]]'</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">modifiers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token function-variable function">selectName</span><span class="token operator">:</span> <span class="token parameter">builder</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">orderByAge</span><span class="token operator">:</span> <span class="token parameter">builder</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token function-variable function">onlyDogs</span><span class="token operator">:</span> <span class="token parameter">builder</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>movies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Reusable modifiers can be defined for models using <a href="/objection.js/api/model/static-properties.html#static-modifiers">modifiers</a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Person.js</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">modifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">defaultSelects</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'firstName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token function">orderByAge</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Animal.js</span>

<span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">modifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">orderByName</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// Note that this modifier takes an argument.</span>
      <span class="token function">onlySpecies</span><span class="token punctuation">(</span><span class="token parameter">builder<span class="token punctuation">,</span> species</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> species<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// somewhereElse.js</span>

<span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modifiers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// This way you can bind arguments to modifiers.</span>
  <span class="token function-variable function">onlyDogs</span><span class="token operator">:</span> <span class="token parameter">query</span> <span class="token operator">=&gt;</span> query<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token string">'onlySpecies'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    children(defaultSelects, orderByAge).[
      pets(onlyDogs, orderByName),
      movies
    ]
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>movies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Relations can be aliased using <code>as</code> keyword:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[
    children(orderByAge) as kids .[
      pets(filterDogs) as dogs,
      pets(filterCats) as cats

      movies.[
        actors
      ]
    ]
  ]</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>kids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dogs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>kids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>movies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Example usage for <a href="/objection.js/api/query-builder/eager-methods.html#allowgraph">allowGraph</a> in an express route:</p> <div class="language-js extra-class"><pre class="language-js"><code>expressApp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/people'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">allowGraph</span><span class="token punctuation">(</span><span class="token string">'[pets, children.pets]'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withGraphFetched</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>eager<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><a href="/objection.js/api/query-builder/eager-methods.html#withgraphjoined">withGraphJoined</a> can be used just like <a href="/objection.js/api/query-builder/eager-methods.html#withgraphfetched">withGraphFetched</a>. In addition you can refer to the related items from the root query because they are all joined:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">withGraphJoined</span><span class="token punctuation">(</span><span class="token string">'[pets, children.pets]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'pets.age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'children:pets.age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="graph-inserts"><a href="#graph-inserts" class="header-anchor">#</a> Graph inserts</h2> <p>Arbitrary relation graphs can be inserted using the <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method. This is best explained using examples, so check them out.</p> <p>See the <a href="/objection.js/api/query-builder/eager-methods.html#allowgraph">allowGraph</a> method if you need to limit which relations can be inserted using <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method to avoid security issues.</p> <p>If you are using Postgres the inserts are done in batches for maximum performance. On other databases the rows need to be inserted one at a time. This is because postgresql is the only database engine that returns the identifiers of all inserted rows and not just the first or the last one.</p> <p><a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> operation is <strong>not</strong> atomic by default! You need to start a transaction and pass it to the query using any of the supported ways. See the section about <a href="/objection.js/guide/transactions.html">transactions</a> for more information.</p> <p>You can read more about graph inserts from <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/" target="_blank" rel="noopener noreferrer">this blog post<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h5 id="examples-12"><a href="#examples-12" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// The return value of `insertGraph` is the input graph converted into</span>
<span class="token comment">// model instances. Inserted objects have ids added to them and related</span>
<span class="token comment">// rows have foreign keys set, but no other columns get fetched from</span>
<span class="token comment">// the database. You can use `insertGraphAndFetch` for that.</span>
<span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Sylvester'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Stallone'</span><span class="token punctuation">,</span>

  <span class="token literal-property property">children</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Sage'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Stallone'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'dog'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The query above will insert 'Sylvester', 'Sage' and 'Fluffy' into db and create relationships between them as defined in the <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a> of the models. Technically <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> builds a dependency graph from the object graph and inserts the models that don't depend on any other models until the whole graph is inserted.</p> <p>If you need to refer to the same model in multiple places you can use the special properties <code>#id</code> and <code>#ref</code> like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string-property property">'#id'</span><span class="token operator">:</span> <span class="token string">'silverLiningsPlaybook'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Silver Linings Playbook'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">122</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Bradley'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Cooper'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string-property property">'#ref'</span><span class="token operator">:</span> <span class="token string">'silverLiningsPlaybook'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">allowRefs</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Note that you need to also set the <code>allowRefs</code> option to true for this to work.</p> <p>The query above will insert only one movie (the 'Silver Linings Playbook') but both 'Jennifer' and 'Bradley' will have the movie related to them through the many-to-many relation <code>movies</code>. The <code>#id</code> can be any string. There are no format or length requirements for them. It is quite easy to create circular dependencies using <code>#id</code> and <code>#ref</code>. Luckily <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> detects them and rejects the query with a clear error message.</p> <p>You can refer to the properties of other models anywhere in the graph using expressions of format <code>#ref{&lt;id&gt;.&lt;property&gt;}</code> as long as the reference doesn't create a circular dependency. For example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string-property property">&quot;#id&quot;</span><span class="token operator">:</span> <span class="token string">'jenni'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;I am the dog of #ref{jenni.firstName} whose id is #ref{jenni.id}&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'dog'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token literal-property property">allowRefs</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Again, make sure you set the <code>allowRefs</code> option to true.</p> <p>The query above will insert a pet named <code>I am the dog of Jennifer whose id is 523</code> for Jennifer. If <code>#ref{}</code> is used within a string, the references are replaced with the referred values inside the string. If the reference string contains nothing but the reference, the referred value is copied to its place preserving its type.</p> <p>Existing rows can be related to newly inserted rows by using the <code>relate</code> option. <code>relate</code> can be <code>true</code> in which case all models in the graph that have an identifier get related. <code>relate</code> can also be an array of relation paths like <code>['children', 'children.movies.actors']</code> in which case only objects in those paths get related even if they have an idetifier.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2636</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">relate</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The query above would create a new person <code>Jennifer Lawrence</code> and add an existing movie (id = 2636) to its <code>movies</code> relation. The next query would do the same:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2636</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">relate</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'movies'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>relate</code> option can also contain nested relations:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

      <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Silver Linings Playbook'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">duration</span><span class="token operator">:</span> <span class="token number">122</span><span class="token punctuation">,</span>

          <span class="token literal-property property">actors</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2516</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">relate</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'movies.actors'</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you need to mix inserts and relates inside a single relation, you can use the special property <code>#dbRef</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string-property property">'#dbRef'</span><span class="token operator">:</span> <span class="token number">2636</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// This will be inserted with an id.</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'New movie'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="graph-upserts"><a href="#graph-upserts" class="header-anchor">#</a> Graph upserts</h2> <p>Arbitrary relation graphs can be upserted (insert + update + delete) using the <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method. This is best explained using examples, so check them out.</p> <p>By default <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method updates the objects that have an id, inserts objects that don't have an id and deletes all objects that are not present. This functionality can be modified in many ways by providing <a href="/objection.js/api/types/#type-upsertgraphoptions">UpsertGraphOptions</a> object as the second argument.</p> <p>The <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method works a little different than the other update and patch methods. When using <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> any <code>where</code> or <code>having</code> methods are ignored. The models are updated based on the id properties in the graph. This is also clarified in the examples.</p> <p><a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> uses <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> under the hood for inserts. That means that you can insert object graphs for relations and use all <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> features like <code>#ref</code> references.</p> <p><a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> operation is <strong>not</strong> atomic by default! You need to start a transaction and pass it to the query using any of the supported ways. See the section about <a href="/objection.js/guide/transactions.html">transactions</a> for more information.</p> <p>See the <a href="/objection.js/api/query-builder/eager-methods.html#allowgraph">allowGraph</a> method if you need to limit which relations can be modified using <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method to avoid security issues.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>WARNING!</p> <p>Before you start using <code>upsertGraph</code> beware that it's not the silver bullet it seems to be. If you start using it because it seems to provide a &quot;mongodb API&quot; for a relational database, you are using it for a wrong reason!</p> <p>Our suggestion is to first try to write any code without it and only use <code>upsertGraph</code> if it saves you <strong>a lot</strong> of code and makes things simpler. Over time you'll learn where <code>upsertGraph</code> helps and where it makes things more complicated. Don't use it by default for everything. You can search through the objection issues to see what kind of problems <code>upsertGraph</code> can cause if used too much.</p> <p>For simple things <code>upsertGraph</code> calls are easy to understand and remain readable. When you start passing it a bunch of options it becomes increasingly difficult for other developers (and even yourself) to understand.</p> <p>It's also really easy to create a server that doesn't work well with multiple users by overusing <code>upsertGraph</code>. That's because you can easily get into a situation where you override other user's changes if you always upsert large graphs at a time. Always try to update the minimum amount of rows and columns and you'll save yourself a lot of trouble in the long run.</p></div> <h5 id="examples-13"><a href="#examples-13" class="header-anchor">#</a> Examples</h5> <p>For the following examples, assume this is the content of the database:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Aniston'</span><span class="token punctuation">,</span>

  <span class="token comment">// This is a BelongsToOneRelation</span>
  <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Nancy'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Dow'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// This is a HasManyRelation</span>
  <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Doggo'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Dog'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Kat'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Cat'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// This is a ManyToManyRelation</span>
  <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Horrible Bosses'</span><span class="token punctuation">,</span>

    <span class="token literal-property property">reviews</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Meh'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Meh'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Wanderlust'</span><span class="token punctuation">,</span>

    <span class="token literal-property property">reviews</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Brilliant'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Makes me want to travel'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><p>By default <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method updates the objects that have an id, inserts objects that don't have an id and deletes all objects that are not present. Of course the delete only applies to relations and not the root. Here's a basic example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// The return value of `upsertGraph` is the input graph converted into</span>
<span class="token comment">// model instances. Inserted objects have ids added to them related</span>
<span class="token comment">// rows have foreign keys set but no other columns get fetched from</span>
<span class="token comment">// the database. You can use `upsertGraphAndFetch` for that.</span>
<span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upsertGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// This updates the `Jennifer Aniston` person since the id property is present.</span>
  <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jonnifer'</span><span class="token punctuation">,</span>

  <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// This also gets updated since the id property is present. If no id was given</span>
    <span class="token comment">// here, Nancy Dow would get deleted, a new Person John Aniston would</span>
    <span class="token comment">// get inserted and related to Jennifer.</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">lastName</span><span class="token operator">:</span> <span class="token string">'Aniston'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// Notice that Kat the Cat is not listed in `pets`. It will get deleted.</span>
  <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// Jennifer just got a new pet. Insert it and relate it to Jennifer. Notice</span>
      <span class="token comment">// that there is no id!</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Wolfgang'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Dog'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// It turns out Doggo is a cat. Update it.</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Cat'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// Notice that Wanderlust is missing from the list. It will get deleted.</span>
  <span class="token comment">// It is also worth mentioning that the Wanderlust's `reviews` or any</span>
  <span class="token comment">// other relations are NOT recursively deleted (unless you have</span>
  <span class="token comment">// defined `ON DELETE CASCADE` or other hooks in the db).</span>
  <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

      <span class="token comment">// Upsert graphs can be arbitrarily deep. This modifies the</span>
      <span class="token comment">// reviews of &quot;Horrible Bosses&quot;.</span>
      <span class="token literal-property property">reviews</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token comment">// Update a review.</span>
          <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Even more Meh'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token comment">// And insert another one.</span>
          <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Loved it'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Best movie ever'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token comment">// And insert a third one.</span>
          <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
          <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'4 / 5'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Would see again'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>By giving <code>relate: true</code> and/or <code>unrelate: true</code> options as the second argument, you can change the behaviour so that instead of inserting and deleting rows, they are related and/or unrelated. Rows with no id still get inserted, but rows that have an id and are not currently related, get related.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">relate</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">unrelate</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upsertGraph</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// This updates the `Jennifer Aniston` person since the id property is present.</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">firstName</span><span class="token operator">:</span> <span class="token string">'Jonnifer'</span><span class="token punctuation">,</span>

    <span class="token comment">// Unrelate the parent. This doesn't delete it.</span>
    <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Kat the Cat is not listed in `pets`. It will get unrelated.</span>
    <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// Jennifer just got a new pet. Insert it and relate it to Jennifer. Notice</span>
        <span class="token comment">// that there is no id!</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'Wolfgang'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Dog'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// It turns out Doggo is a cat. Update it.</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Cat'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Wanderlust is missing from the list. It will get unrelated.</span>
    <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

        <span class="token comment">// Upsert graphs can be arbitrarily deep. This modifies the</span>
        <span class="token comment">// reviews of &quot;Horrible Bosses&quot;.</span>
        <span class="token literal-property property">reviews</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token comment">// Update a review.</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Even more Meh'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token comment">// And insert another one.</span>
            <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Loved it'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Best movie ever'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// This is some existing movie that isn't currently related to Jennifer.</span>
        <span class="token comment">// It will get related.</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1253</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  options
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>relate</code> and <code>unrelate</code> (and all other <a href="/objection.js/api/types/#type-upsertgraphoptions">options</a> can also be lists of relation paths. In that case the option is only applied for the listed relations.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Only enable `unrelate` functionality for these two paths.</span>
  <span class="token literal-property property">unrelate</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'pets'</span><span class="token punctuation">,</span> <span class="token string">'movies.reviews'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// Only enable `relate` functionality for 'movies' relation.</span>
  <span class="token literal-property property">relate</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'movies'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// Disable deleting for movies.</span>
  <span class="token literal-property property">noDelete</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'movies'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">upsertGraph</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

    <span class="token comment">// This gets deleted since `unrelate` list doesn't have 'parent' in it</span>
    <span class="token comment">// and deleting is the default behaviour.</span>
    <span class="token literal-property property">parent</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Kat the Cat is not listed in `pets`. It will get unrelated.</span>
    <span class="token literal-property property">pets</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// It turns out Doggo is a cat. Update it.</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token literal-property property">species</span><span class="token operator">:</span> <span class="token string">'Cat'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Wanderlust is missing from the list. It will NOT get unrelated</span>
    <span class="token comment">// or deleted since `unrelate` list doesn't contain `movies` and `noDelete`</span>
    <span class="token comment">// list does.</span>
    <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

        <span class="token comment">// Upsert graphs can be arbitrarily deep. This modifies the</span>
        <span class="token comment">// reviews of &quot;Horrible Bosses&quot;.</span>
        <span class="token literal-property property">reviews</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token comment">// Update a review.</span>
            <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Even more Meh'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token comment">// And insert another one.</span>
            <span class="token literal-property property">stars</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'Loved it'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">text</span><span class="token operator">:</span> <span class="token string">'Best movie ever'</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token comment">// This is some existing movie that isn't currently related to Jennifer.</span>
        <span class="token comment">// It will get related.</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1253</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  options
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can disable updates, inserts, deletes etc. for the whole <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> operation or for individual relations by using the <code>noUpdate</code>, <code>noInsert</code>, <code>noDelete</code> etc. options. See <a href="/objection.js/api/types/#type-upsertgraphoptions">UpsertGraphOptions</a> docs for more info.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/objection.js/guide/relations.html" class="prev">
        Relations
      </a></span> <span class="next"><a href="/objection.js/guide/transactions.html">
        Transactions
      </a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/objection.js/assets/js/app.aac9f1d1.js" defer></script><script src="/objection.js/assets/js/2.95f20b73.js" defer></script><script src="/objection.js/assets/js/1.317fd1a4.js" defer></script><script src="/objection.js/assets/js/48.f94e2444.js" defer></script>
  </body>
</html>
