<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Indexing PostgreSQL JSONB columns | Objection.js</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.8b2ca500.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.c58599d4.js" as="script"><link rel="preload" href="/objection.js/assets/js/6.16d8453b.js" as="script"><link rel="preload" href="/objection.js/assets/js/7.4cbcc556.js" as="script"><link rel="preload" href="/objection.js/assets/js/44.b4629294.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/1.a73121c3.js"><link rel="prefetch" href="/objection.js/assets/js/10.212b4ab4.js"><link rel="prefetch" href="/objection.js/assets/js/11.d4d6118f.js"><link rel="prefetch" href="/objection.js/assets/js/12.f327ad1f.js"><link rel="prefetch" href="/objection.js/assets/js/13.dfd93186.js"><link rel="prefetch" href="/objection.js/assets/js/14.864602dd.js"><link rel="prefetch" href="/objection.js/assets/js/15.d817083d.js"><link rel="prefetch" href="/objection.js/assets/js/16.a6c9d1b4.js"><link rel="prefetch" href="/objection.js/assets/js/17.233a3da5.js"><link rel="prefetch" href="/objection.js/assets/js/18.7fc00e95.js"><link rel="prefetch" href="/objection.js/assets/js/19.fbf8992a.js"><link rel="prefetch" href="/objection.js/assets/js/2.d0c72ae2.js"><link rel="prefetch" href="/objection.js/assets/js/20.3fa51eab.js"><link rel="prefetch" href="/objection.js/assets/js/21.7f1adcaa.js"><link rel="prefetch" href="/objection.js/assets/js/22.24785b96.js"><link rel="prefetch" href="/objection.js/assets/js/23.f0f724f0.js"><link rel="prefetch" href="/objection.js/assets/js/24.ee5e48e1.js"><link rel="prefetch" href="/objection.js/assets/js/25.1141a40b.js"><link rel="prefetch" href="/objection.js/assets/js/26.863fbc1e.js"><link rel="prefetch" href="/objection.js/assets/js/27.6f84a8cb.js"><link rel="prefetch" href="/objection.js/assets/js/28.6d490e4c.js"><link rel="prefetch" href="/objection.js/assets/js/29.998144b1.js"><link rel="prefetch" href="/objection.js/assets/js/3.56148735.js"><link rel="prefetch" href="/objection.js/assets/js/30.05a32618.js"><link rel="prefetch" href="/objection.js/assets/js/31.380d7478.js"><link rel="prefetch" href="/objection.js/assets/js/32.344be128.js"><link rel="prefetch" href="/objection.js/assets/js/33.0ae141cb.js"><link rel="prefetch" href="/objection.js/assets/js/34.3f91526e.js"><link rel="prefetch" href="/objection.js/assets/js/35.fe74bb27.js"><link rel="prefetch" href="/objection.js/assets/js/36.82e885f0.js"><link rel="prefetch" href="/objection.js/assets/js/37.89665c00.js"><link rel="prefetch" href="/objection.js/assets/js/38.b296b712.js"><link rel="prefetch" href="/objection.js/assets/js/39.03dec9a0.js"><link rel="prefetch" href="/objection.js/assets/js/40.e253fb8c.js"><link rel="prefetch" href="/objection.js/assets/js/41.920d75d5.js"><link rel="prefetch" href="/objection.js/assets/js/42.ee664bd9.js"><link rel="prefetch" href="/objection.js/assets/js/43.dc709913.js"><link rel="prefetch" href="/objection.js/assets/js/45.79b83d16.js"><link rel="prefetch" href="/objection.js/assets/js/46.e435024a.js"><link rel="prefetch" href="/objection.js/assets/js/47.f4d6a9a0.js"><link rel="prefetch" href="/objection.js/assets/js/48.ee5d60fb.js"><link rel="prefetch" href="/objection.js/assets/js/49.7e06c439.js"><link rel="prefetch" href="/objection.js/assets/js/50.df0420d1.js"><link rel="prefetch" href="/objection.js/assets/js/51.7c20e12d.js"><link rel="prefetch" href="/objection.js/assets/js/52.3f06722a.js"><link rel="prefetch" href="/objection.js/assets/js/53.52ea4a3b.js"><link rel="prefetch" href="/objection.js/assets/js/54.4be8a3de.js"><link rel="prefetch" href="/objection.js/assets/js/55.60c0e17b.js"><link rel="prefetch" href="/objection.js/assets/js/56.8412cd34.js"><link rel="prefetch" href="/objection.js/assets/js/57.335c34ab.js"><link rel="prefetch" href="/objection.js/assets/js/58.2c8acae0.js"><link rel="prefetch" href="/objection.js/assets/js/59.de27b3cd.js"><link rel="prefetch" href="/objection.js/assets/js/60.2af623c8.js"><link rel="prefetch" href="/objection.js/assets/js/8.49a12594.js"><link rel="prefetch" href="/objection.js/assets/js/9.dcd09b5d.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.58aff259.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.8b2ca500.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link router-link-active">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" class="nav-link">
  Migration to 2.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐ Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link router-link-active">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" class="nav-link">
  Migration to 2.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐ Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Recipes</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/objection.js/recipes/raw-queries.html" class="sidebar-link">Raw queries</a></li><li><a href="/objection.js/recipes/precedence-and-parentheses.html" class="sidebar-link">Precedence and parentheses</a></li><li><a href="/objection.js/recipes/subqueries.html" class="sidebar-link">Subqueries</a></li><li><a href="/objection.js/recipes/relation-subqueries.html" class="sidebar-link">Relation subqueries</a></li><li><a href="/objection.js/recipes/joins.html" class="sidebar-link">Joins</a></li><li><a href="/objection.js/recipes/modifiers.html" class="sidebar-link">Modifiers</a></li><li><a href="/objection.js/recipes/composite-keys.html" class="sidebar-link">Composite keys</a></li><li><a href="/objection.js/recipes/polymorphic-associations.html" class="sidebar-link">Polymorphic associations</a></li><li><a href="/objection.js/recipes/json-queries.html" class="sidebar-link">JSON queries</a></li><li><a href="/objection.js/recipes/custom-id-column.html" class="sidebar-link">Custom id column</a></li><li><a href="/objection.js/recipes/extra-properties.html" class="sidebar-link">Join table extra properties</a></li><li><a href="/objection.js/recipes/custom-validation.html" class="sidebar-link">Custom validation</a></li><li><a href="/objection.js/recipes/snake-case-to-camel-case-conversion.html" class="sidebar-link">Snake case to camel case conversion</a></li><li><a href="/objection.js/recipes/paging.html" class="sidebar-link">Paging</a></li><li><a href="/objection.js/recipes/returning-tricks.html" class="sidebar-link">PostgreSQL &quot;returning&quot; tricks</a></li><li><a href="/objection.js/recipes/timestamps.html" class="sidebar-link">Timestamps</a></li><li><a href="/objection.js/recipes/custom-query-builder.html" class="sidebar-link">Custom query builder (extending the query builder)</a></li><li><a href="/objection.js/recipes/multitenancy-using-multiple-databases.html" class="sidebar-link">Multitenancy using multiple databases</a></li><li><a href="/objection.js/recipes/default-values.html" class="sidebar-link">Default values</a></li><li><a href="/objection.js/recipes/error-handling.html" class="sidebar-link">Error handling</a></li><li><a href="/objection.js/recipes/ternary-relationships.html" class="sidebar-link">Ternary relationships</a></li><li><a href="/objection.js/recipes/indexing-postgresql-jsonb-columns.html" aria-current="page" class="active sidebar-link">Indexing PostgreSQL JSONB columns</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/recipes/indexing-postgresql-jsonb-columns.html#general-inverted-indexes-a-k-a-gin" class="sidebar-link">General Inverted Indexes a.k.a. GIN</a></li><li class="sidebar-sub-header"><a href="/objection.js/recipes/indexing-postgresql-jsonb-columns.html#index-on-expression" class="sidebar-link">Index on Expression</a></li><li class="sidebar-sub-header"><a href="/objection.js/recipes/indexing-postgresql-jsonb-columns.html#complete-migration-example-and-created-tables-indexes" class="sidebar-link">Complete Migration Example and Created Tables / Indexes</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="indexing-postgresql-jsonb-columns"><a href="#indexing-postgresql-jsonb-columns" class="header-anchor">#</a> Indexing PostgreSQL JSONB columns</h1> <p>Good reading on the subject:</p> <ul><li><a href="https://blog.2ndquadrant.com/jsonb-type-performance-postgresql-9-4/" target="_blank" rel="noopener noreferrer">JSONB type performance in PostgreSQL 9.4<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and</li> <li><a href="http://paquier.xyz/postgresql-2/postgres-9-4-feature-highlight-indexing-jsonb/" target="_blank" rel="noopener noreferrer">Postgres 9.4 feature highlight - Indexing JSON data with jsonb data type<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <h2 id="general-inverted-indexes-a-k-a-gin"><a href="#general-inverted-indexes-a-k-a-gin" class="header-anchor">#</a> General Inverted Indexes a.k.a. GIN</h2> <p>This is the index type which makes all JSONB set operations fast. All <code>isSuperset</code> / <code>isSubset</code> / <code>hasKeys</code> / <code>hasValues</code> etc. queries can use this index to speed ’em up. Usually this is the index you want and it may take around 30% extra space on the DB server.</p> <p>If one likes to use only the subset/superset operators with faster and smaller index one can give an extra <code>path_ops</code> parameter when creating the index: <a href="https://wiki.postgresql.org/wiki/What's_new_in_PostgreSQL_9.4" target="_blank" rel="noopener noreferrer">“The path_ops index supports only the search path operator <code>@&gt;</code> (see below), but produces a smaller and faster index for these kinds of searches.”<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. According to Marco Nenciarini’s post the speed up can be over 600% compared to full GIN index and the size of the index is reduced from ~30% -&gt; ~20%.</p> <p>Full GIN index to speed up all type of json queries:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'CREATE INDEX on ?? USING GIN (??)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hero'</span><span class="token punctuation">,</span> <span class="token string">'details'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>Partial GIN index to speed up all subset / superset type of json queries:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'CREATE INDEX on ?? USING GIN (?? jsonb_path_ops)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Place'</span><span class="token punctuation">,</span> <span class="token string">'details'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="index-on-expression"><a href="#index-on-expression" class="header-anchor">#</a> Index on Expression</h2> <p>Another type of index one may use for JSONB field is to create an expression index for example for a certain JSON field inside a column.</p> <p>You might want to use these if you are using lots of <code>.where(ref('jsonColumn:details.name').castText(), 'marilyn')</code> type of queries, which cannot be sped up with GIN index.</p> <p>Use of these indexes are more limited, but they are also somewhat faster than using GIN and querying e.g. <code>{ field: value }</code> with subset operator. GIN indices also takes a lot of space in compared to expression index for certain field. So if you want to make just certain query to go extra fast you may consider using index on expression.</p> <p>An expression index referring an internal <code>details.name</code> attribute of an object stored in <code>jsonColumn</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE INDEX on ?? ((??#&gt;&gt;'{details,name}'))&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hero'</span><span class="token punctuation">,</span> <span class="token string">'jsonColumn'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="complete-migration-example-and-created-tables-indexes"><a href="#complete-migration-example-and-created-tables-indexes" class="header-anchor">#</a> Complete Migration Example and Created Tables / Indexes</h2> <p>Complete example how to try out different index choices.</p> <p>Migration:</p> <div class="language-js extra-class"><pre class="language-js"><code>exports<span class="token punctuation">.</span><span class="token function-variable function">up</span> <span class="token operator">=</span> <span class="token parameter">knex</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> knex<span class="token punctuation">.</span>schema
    <span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'Hero'</span><span class="token punctuation">,</span> <span class="token parameter">table</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">jsonb</span><span class="token punctuation">(</span><span class="token string">'details'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table
        <span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token string">'homeId'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unsigned</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">references</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">inTable</span><span class="token punctuation">(</span><span class="token string">'Place'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'CREATE INDEX on ?? USING GIN (??)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hero'</span><span class="token punctuation">,</span> <span class="token string">'details'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">&quot;CREATE INDEX on ?? ((??#&gt;&gt;'{type}'))&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'Hero'</span><span class="token punctuation">,</span> <span class="token string">'details'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">createTable</span><span class="token punctuation">(</span><span class="token string">'Place'</span><span class="token punctuation">,</span> <span class="token parameter">table</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      table<span class="token punctuation">.</span><span class="token function">increments</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      table<span class="token punctuation">.</span><span class="token function">jsonb</span><span class="token punctuation">(</span><span class="token string">'details'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'CREATE INDEX on ?? USING GIN (?? jsonb_path_ops)'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>
      <span class="token string">'Place'</span><span class="token punctuation">,</span>
      <span class="token string">'details'</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>Results following schema:</p> <div class="language-sql extra-class"><pre class="language-sql"><code>objection<span class="token operator">-</span>jsonb<span class="token operator">-</span>example<span class="token operator">=</span><span class="token comment"># \d &quot;Hero&quot;</span>
            <span class="token keyword">Table</span> <span class="token string">&quot;public.Hero&quot;</span>
 <span class="token keyword">Column</span>  <span class="token operator">|</span>          <span class="token keyword">Type</span>
<span class="token comment">---------+------------------------</span>
 id      <span class="token operator">|</span> <span class="token keyword">integer</span>
 name    <span class="token operator">|</span> <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
 details <span class="token operator">|</span> jsonb
 homeId  <span class="token operator">|</span> <span class="token keyword">integer</span>
Indexes:
    <span class="token string">&quot;Hero_pkey&quot;</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span> <span class="token keyword">btree</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token string">&quot;Hero_details_idx&quot;</span> gin <span class="token punctuation">(</span>details<span class="token punctuation">)</span>
    <span class="token string">&quot;Hero_expr_idx&quot;</span> <span class="token keyword">btree</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>details <span class="token comment">#&gt;&gt; '{type}'::text[]))</span>

objection<span class="token operator">-</span>jsonb<span class="token operator">-</span>example<span class="token operator">=</span><span class="token comment"># \d &quot;Place&quot;</span>
           <span class="token keyword">Table</span> <span class="token string">&quot;public.Place&quot;</span>
 <span class="token keyword">Column</span>  <span class="token operator">|</span>          <span class="token keyword">Type</span>
<span class="token comment">---------+------------------------</span>
 id      <span class="token operator">|</span> <span class="token keyword">integer</span>
 name    <span class="token operator">|</span> <span class="token keyword">character</span> <span class="token keyword">varying</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span>
 details <span class="token operator">|</span> jsonb
Indexes:
    <span class="token string">&quot;Place_pkey&quot;</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span> <span class="token keyword">btree</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token string">&quot;Place_details_idx&quot;</span> gin <span class="token punctuation">(</span>details jsonb_path_ops<span class="token punctuation">)</span>
</code></pre></div><p>Expression index is used for example for following query:</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;Hero&quot;</span> <span class="token keyword">where</span> details<span class="token comment">#&gt;&gt;'{type}' = 'Hero';</span>

                           QUERY <span class="token keyword">PLAN</span>
<span class="token comment">----------------------------------------------------------------</span>
 <span class="token keyword">Index</span> Scan <span class="token keyword">using</span> <span class="token string">&quot;Hero_expr_idx&quot;</span> <span class="token keyword">on</span> <span class="token string">&quot;Hero&quot;</span>
   <span class="token keyword">Index</span> Cond: <span class="token punctuation">(</span><span class="token punctuation">(</span>details <span class="token comment">#&gt;&gt; '{type}'::text[]) = 'Hero'::text)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/objection.js/recipes/ternary-relationships.html" class="prev">
        Ternary relationships
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/objection.js/assets/js/app.c58599d4.js" defer></script><script src="/objection.js/assets/js/6.16d8453b.js" defer></script><script src="/objection.js/assets/js/7.4cbcc556.js" defer></script><script src="/objection.js/assets/js/44.b4629294.js" defer></script>
  </body>
</html>
