<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Multitenancy using multiple databases | Objection.js</title>
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.887cf860.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.a45db35f.js" as="script"><link rel="preload" href="/objection.js/assets/js/41.bf9e2264.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/1.1300c266.js"><link rel="prefetch" href="/objection.js/assets/js/10.239be4a3.js"><link rel="prefetch" href="/objection.js/assets/js/11.7a51e2ad.js"><link rel="prefetch" href="/objection.js/assets/js/12.e611bd5c.js"><link rel="prefetch" href="/objection.js/assets/js/13.eb93f29d.js"><link rel="prefetch" href="/objection.js/assets/js/14.d77fabaa.js"><link rel="prefetch" href="/objection.js/assets/js/15.895cf103.js"><link rel="prefetch" href="/objection.js/assets/js/16.3509e569.js"><link rel="prefetch" href="/objection.js/assets/js/17.7b452395.js"><link rel="prefetch" href="/objection.js/assets/js/18.24dd75d2.js"><link rel="prefetch" href="/objection.js/assets/js/19.7467d510.js"><link rel="prefetch" href="/objection.js/assets/js/2.b3112ac3.js"><link rel="prefetch" href="/objection.js/assets/js/20.abce9fb3.js"><link rel="prefetch" href="/objection.js/assets/js/21.472df454.js"><link rel="prefetch" href="/objection.js/assets/js/22.a6b4a72d.js"><link rel="prefetch" href="/objection.js/assets/js/23.84d018d4.js"><link rel="prefetch" href="/objection.js/assets/js/24.ca239af0.js"><link rel="prefetch" href="/objection.js/assets/js/25.7f3b0cd6.js"><link rel="prefetch" href="/objection.js/assets/js/26.250f021f.js"><link rel="prefetch" href="/objection.js/assets/js/27.ce4d158c.js"><link rel="prefetch" href="/objection.js/assets/js/28.51c3c69b.js"><link rel="prefetch" href="/objection.js/assets/js/29.18df49fe.js"><link rel="prefetch" href="/objection.js/assets/js/3.4219ca8c.js"><link rel="prefetch" href="/objection.js/assets/js/30.d15fd35b.js"><link rel="prefetch" href="/objection.js/assets/js/31.145a53a9.js"><link rel="prefetch" href="/objection.js/assets/js/32.8c6dbc57.js"><link rel="prefetch" href="/objection.js/assets/js/33.7659df30.js"><link rel="prefetch" href="/objection.js/assets/js/34.cfd603c8.js"><link rel="prefetch" href="/objection.js/assets/js/35.816cbd36.js"><link rel="prefetch" href="/objection.js/assets/js/36.fc3faeb5.js"><link rel="prefetch" href="/objection.js/assets/js/37.8055b716.js"><link rel="prefetch" href="/objection.js/assets/js/38.67a4e462.js"><link rel="prefetch" href="/objection.js/assets/js/39.974a5ff8.js"><link rel="prefetch" href="/objection.js/assets/js/40.9d747df9.js"><link rel="prefetch" href="/objection.js/assets/js/42.aeefdd1c.js"><link rel="prefetch" href="/objection.js/assets/js/43.e8e6004c.js"><link rel="prefetch" href="/objection.js/assets/js/44.baaceb97.js"><link rel="prefetch" href="/objection.js/assets/js/45.f9eb9619.js"><link rel="prefetch" href="/objection.js/assets/js/46.f02f5dca.js"><link rel="prefetch" href="/objection.js/assets/js/47.16ad7941.js"><link rel="prefetch" href="/objection.js/assets/js/48.a2d3984b.js"><link rel="prefetch" href="/objection.js/assets/js/49.236052f1.js"><link rel="prefetch" href="/objection.js/assets/js/50.e254f379.js"><link rel="prefetch" href="/objection.js/assets/js/51.8edc0045.js"><link rel="prefetch" href="/objection.js/assets/js/52.0f39d9e5.js"><link rel="prefetch" href="/objection.js/assets/js/6.1f2cd6a7.js"><link rel="prefetch" href="/objection.js/assets/js/7.20cecf4f.js"><link rel="prefetch" href="/objection.js/assets/js/8.83363aa3.js"><link rel="prefetch" href="/objection.js/assets/js/9.d651b3b8.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.22f43628.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.887cf860.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links" style="max-width:nullpx;"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">Main Module</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">Query Builder</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">Model</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">Types</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link router-link-active">Recipe Book</a></div><div class="nav-item"><a href="/objection.js/changelog/" class="nav-link">Changelog</a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">Main Module</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">Query Builder</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">Model</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">Types</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link router-link-active">Recipe Book</a></div><div class="nav-item"><a href="/objection.js/changelog/" class="nav-link">Changelog</a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Recipes</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/objection.js/recipes/raw-queries.html" class="sidebar-link">Raw queries</a></li><li><a href="/objection.js/recipes/precedence-and-parentheses.html" class="sidebar-link">Precedence and parentheses</a></li><li><a href="/objection.js/recipes/subqueries.html" class="sidebar-link">Subqueries</a></li><li><a href="/objection.js/recipes/relation-subqueries.html" class="sidebar-link">Relation subqueries</a></li><li><a href="/objection.js/recipes/joins.html" class="sidebar-link">Joins</a></li><li><a href="/objection.js/recipes/composite-keys.html" class="sidebar-link">Composite keys</a></li><li><a href="/objection.js/recipes/polymorphic-associations.html" class="sidebar-link">Polymorphic associations</a></li><li><a href="/objection.js/recipes/json-queries.html" class="sidebar-link">JSON queries</a></li><li><a href="/objection.js/recipes/custom-id-column.html" class="sidebar-link">Custom id column</a></li><li><a href="/objection.js/recipes/extra-properties.html" class="sidebar-link">Join table extra properties</a></li><li><a href="/objection.js/recipes/custom-validation.html" class="sidebar-link">Custom validation</a></li><li><a href="/objection.js/recipes/snake-case-to-camel-case-conversion.html" class="sidebar-link">Snake case to camel case conversion</a></li><li><a href="/objection.js/recipes/paging.html" class="sidebar-link">Paging</a></li><li><a href="/objection.js/recipes/returning-tricks.html" class="sidebar-link">PostgreSQL &quot;returning&quot; tricks</a></li><li><a href="/objection.js/recipes/timestamps.html" class="sidebar-link">Timestamps</a></li><li><a href="/objection.js/recipes/custom-query-builder.html" class="sidebar-link">Custom query builder</a></li><li><a href="/objection.js/recipes/multitenancy-using-multiple-databases.html" class="active sidebar-link">Multitenancy using multiple databases</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/recipes/multitenancy-using-multiple-databases.html#model-binding-pattern" class="sidebar-link">Model binding pattern</a></li><li class="sidebar-sub-header"><a href="/objection.js/recipes/multitenancy-using-multiple-databases.html#knex-passing-pattern" class="sidebar-link">Knex passing pattern</a></li></ul></li><li><a href="/objection.js/recipes/default-values.html" class="sidebar-link">Default values</a></li><li><a href="/objection.js/recipes/error-handling.html" class="sidebar-link">Error handling</a></li><li><a href="/objection.js/recipes/ternary-relationships.html" class="sidebar-link">Ternary relationships</a></li><li><a href="/objection.js/recipes/indexing-postgresql-jsonb-columns.html" class="sidebar-link">Indexing PostgreSQL JSONB columns</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="multitenancy-using-multiple-databases"><a href="#multitenancy-using-multiple-databases" aria-hidden="true" class="header-anchor">#</a> Multitenancy using multiple databases</h1> <p>By default, the examples guide you to setup the database connection by calling <a href="/objection.js/api/model/static-methods.html#static-knex">Model.knex(knex)</a>. This doesn't fly if you want to select the database based on the request as it sets the connection globally. There are (at least) two patterns for dealing with this kind of setup:</p> <h2 id="model-binding-pattern"><a href="#model-binding-pattern" aria-hidden="true" class="header-anchor">#</a> Model binding pattern</h2> <p>If you have a different database for each tenant, a useful pattern is to add a middleware that adds the models to <code>req.models</code> hash and then <em>always</em> use the models through <code>req.models</code> instead of requiring them directly. What <a href="/objection.js/api/model/static-properties.html#static-bindknex">bindKnex</a> method actually does is that it creates an anonymous subclass of the model class and sets its knex connection. That way the database connection doesn't change for the other requests that are currently being executed.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Knex <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'knex'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> knexCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Function that parses the tenant id from path, header, query parameter etc.</span>
  <span class="token comment">// and returns an instance of knex. You should cache the knex instances and</span>
  <span class="token comment">// not create a new one for each query. Knex takes care of connection pooling.</span>
  <span class="token keyword">const</span> knex <span class="token operator">=</span> <span class="token function">getKnexForRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> knexCache<span class="token punctuation">)</span><span class="token punctuation">;</span>

  req<span class="token punctuation">.</span>models <span class="token operator">=</span> <span class="token punctuation">{</span>
    Person<span class="token punctuation">:</span> Person<span class="token punctuation">.</span><span class="token function">bindKnex</span><span class="token punctuation">(</span>knex<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Movie<span class="token punctuation">:</span> Movie<span class="token punctuation">.</span><span class="token function">bindKnex</span><span class="token punctuation">(</span>knex<span class="token punctuation">)</span><span class="token punctuation">,</span>
    Animal<span class="token punctuation">:</span> Animal<span class="token punctuation">.</span><span class="token function">bindKnex</span><span class="token punctuation">(</span>knex<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getKnexForRequest</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> knexCache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// If you pass the tenantIs a query parameter, you would do something</span>
  <span class="token comment">// like this.</span>
  <span class="token keyword">let</span> tenantId <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>tenantId<span class="token punctuation">;</span>
  <span class="token keyword">let</span> knex <span class="token operator">=</span> knexCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>knex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    knex <span class="token operator">=</span> <span class="token function">Knex</span><span class="token punctuation">(</span><span class="token function">knexConfigForTenant</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    knexCache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>tenantId<span class="token punctuation">,</span> knex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> knex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">knexConfigForTenant</span><span class="token punctuation">(</span><span class="token parameter">tenantId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// The correct knex config object for the given tenant.</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/people'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> Person <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>models<span class="token punctuation">;</span>

  <span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="knex-passing-pattern"><a href="#knex-passing-pattern" aria-hidden="true" class="header-anchor">#</a> Knex passing pattern</h2> <p>Another option is to add the knex instance to the request using a middleware and not bind models at all (not even using <a href="/objection.js/api/model/static-methods.html#static-knex">Model.knex()</a>). The knex instance can be passed to <a href="/objection.js/api/model/static-methods.html#static-query">query</a>, <a href="/objection.js/api/model/instance-methods.html#query">$query</a>, and <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> methods as the last argument. This pattern forces you to design your services and helper methods in a way that you always need to pass in a knex instance. A great thing about this is that you can pass a transaction object instead. (the knex/objection transaction object is a query builder just like the normal knex instance). This gives you a fine grained control over your transactions.</p> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// This function is defined in the previous example.</span>
  req<span class="token punctuation">.</span>knex <span class="token operator">=</span> <span class="token function">getKnexForRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/people'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>knex<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/objection.js/recipes/custom-query-builder.html" class="prev">
          Custom query builder
        </a></span> <span class="next"><a href="/objection.js/recipes/default-values.html">
          Default values
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/objection.js/assets/js/app.a45db35f.js" defer></script><script src="/objection.js/assets/js/41.bf9e2264.js" defer></script>
  </body>
</html>
