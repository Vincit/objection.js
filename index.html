<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Objection.js</title>

    <link href="stylesheets/screen.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script src="javascripts/all.js" type="text/javascript"></script>

  </head>

  <body class="index">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo.png" />
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='https://github.com/Vincit/objection.js/'>Github repository</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <p><a href="https://github.com/Vincit/objection.js"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a></p>

<h1 id="introduction">Introduction</h1>

<p><a href="https://travis-ci.org/Vincit/objection.js"><img alt="Build Status" src="https://travis-ci.org/Vincit/objection.js.svg?branch=master" /></a> <a href="https://coveralls.io/github/Vincit/objection.js?branch=master"><img alt="Coverage Status" src="https://coveralls.io/repos/Vincit/objection.js/badge.svg?branch=master&amp;service=github" /></a> <a href="https://gitter.im/Vincit/objection.js?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img alt="Join the chat at https://gitter.im/Vincit/objection.js" src="https://badges.gitter.im/Vincit/objection.js.svg" /></a></p>

<p>Objection.js is an <a href="https://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> for <a href="https://nodejs.org/">Node.js</a>
that aims to stay out of your way and make it as easy as possible to use the full power of SQL and the underlying
database engine while keeping magic to a minimum.</p>

<p>Objection.js is built on an SQL query builder called <a href="http://knexjs.org">knex</a>. All databases supported by knex
are supported by objection.js. <strong>SQLite3</strong>, <strong>Postgres</strong> and <strong>MySQL</strong> are <a href="https://travis-ci.org/Vincit/objection.js">thoroughly tested</a>.</p>

<p>What objection.js gives you:</p>

<ul>
<li><strong>An easy declarative way of <a href="#models">defining models</a> and relationships between them</strong></li>
<li><strong>Simple and fun way to <a href="#query-examples">fetch, insert, update and delete</a> objects using the full power of SQL</strong></li>
<li><strong>Powerful mechanisms for <a href="#eager-loading">eager loading</a> and <a href="#graph-inserts">inserting object graphs</a></strong></li>
<li><strong>A way to <a href="#documents">store complex documents</a> as single rows</strong></li>
<li><strong>Completely <a href="https://github.com/petkaantonov/bluebird">Promise</a> based API</strong></li>
<li><strong>Easy to use <a href="#transactions">transactions</a></strong></li>
<li><strong>Optional <a href="#validation">JSON schema</a> validation</strong></li>
</ul>

<p>What objection.js <strong>doesn&rsquo;t</strong> give you:</p>

<ul>
<li><strong>A custom query DSL. SQL is used as a query language.</strong></li>
<li><strong>Automatic database schema creation and migration.</strong>
For simple things it is useful that the database schema is automatically generated from the model definitions,
but usually just gets in your way when doing anything non-trivial. Objection.js leaves the schema related things
to you. knex has a great <a href="http://knexjs.org/#Migrations">migration tool</a> that we recommend for this job. Check
out the <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es6">example project</a>.</li>
</ul>

<p>Objection.js uses Promises and coding practices that make it ready for the future. We use Well known
<a href="https://en.wikipedia.org/wiki/Object-oriented_programming">OOP</a> techniques and ES2015 compatible classes and inheritance
in the codebase. You can use things like <a href="http://jakearchibald.com/2014/es7-async-functions/">async/await</a>
using a transpiler such as <a href="https://babeljs.io/">Babel</a>. Check out our <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es6">ES2015</a>
and <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es7">ESNext</a> example projects.</p>

<p>Blog posts and tutorials:</p>

<ul>
<li><a href="https://www.vincit.fi/en/blog/introducing-moron-js-a-new-orm-for-node-js/">Introduction</a> (objection.js was originally called moron.js)</li>
<li><a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/">Eager loading</a></li>
<li><a href="https://www.vincit.fi/en/blog/by-the-power-of-json-queries/">Postgres JSON queries</a></li>
</ul>

<h1 id="installation">Installation</h1>
<pre class="highlight shell"><code>npm install knex objection
</code></pre>
<blockquote>
<p>You also need to install one of the following depending on the database you want to use:</p>
</blockquote>
<pre class="highlight shell"><code>npm install pg
npm install sqlite3
npm install mysql
npm install mysql2
npm install mariasql
</code></pre>
<blockquote>
<p>You can use the <code class="prettyprint">next</code> tag to install an alpha/beta/RC version:</p>
</blockquote>
<pre class="highlight shell"><code>npm install objection@next
</code></pre>
<p>Objection.js can be installed using <code class="prettyprint">npm</code>.</p>

<h1 id="getting-started">Getting started</h1>

<blockquote>
<p>Install example project:</p>
</blockquote>
<pre class="highlight shell"><code>git clone git@github.com:Vincit/objection.js.git objection
<span class="nb">cd </span>objection/examples/express-es6
npm install
<span class="c"># We use knex for migrations in this example.</span>
npm install knex -g
knex migrate:latest
npm start
</code></pre>
<blockquote>
<p>If installing the example project seems like too much work, here is a simple standalone example. Just copy this into a file and run it:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// run the following command to install:</span>
<span class="c1">// npm install objection knex sqlite3</span>

<span class="kr">const</span> <span class="nx">objection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">objection</span><span class="p">.</span><span class="nx">Model</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">Knex</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'knex'</span><span class="p">);</span>

<span class="c1">// Initialize knex connection.</span>
<span class="kr">const</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">Knex</span><span class="p">({</span>
  <span class="na">client</span><span class="p">:</span> <span class="s1">'sqlite3'</span><span class="p">,</span>
  <span class="na">useNullAsDefault</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'example.db'</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Give the connection to objection.</span>
<span class="nx">Model</span><span class="p">.</span><span class="nx">knex</span><span class="p">(</span><span class="nx">knex</span><span class="p">);</span>

<span class="c1">// Create database schema. You should use knex migration files to do this. We</span>
<span class="c1">// create it here for simplicity.</span>
<span class="kr">const</span> <span class="nx">schemaPromise</span> <span class="o">=</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">createTableIfNotExists</span><span class="p">(</span><span class="s1">'Person'</span><span class="p">,</span> <span class="nx">table</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
  <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Person model.</span>
<span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">tableName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'Person'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">schemaPromise</span><span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="c1">// Create a person.</span>
  <span class="k">return</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sylvester'</span><span class="p">});</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">person</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'created:'</span><span class="p">,</span> <span class="nx">person</span><span class="p">.</span><span class="nx">firstName</span><span class="p">,</span> <span class="s1">'id:'</span><span class="p">,</span> <span class="nx">person</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="c1">// Fetch all people named Sylvester.</span>
  <span class="k">return</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'Sylvester'</span><span class="p">);</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">sylvesters</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'sylvesters:'</span><span class="p">,</span> <span class="nx">sylvesters</span><span class="p">);</span>

<span class="p">});</span>
</code></pre>
<p>To use objection.js all you need to do is <a href="http://knexjs.org/#Installation-node">initialize knex</a> and give the
connection to objection.js using <a href="#knex"><code class="prettyprint">Model.knex(knex)</code></a>. Doing this installs the knex connection globally for all models.
If you need to use multiple databases check out our <a href="#multi-tenancy">multi-tenancy recipe</a>.</p>

<p>The next step is to create some migrations and models and start using objection.js. The best way to get started is to
check out the <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es6">example project</a>. The <code class="prettyprint">express</code>
example project is a simple express server. The <code class="prettyprint">example-requests.sh</code> file contains a bunch of curl commands for you to
start playing with the REST API.</p>

<p>We also have an <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es7">ESNext version of the example project</a>
that uses <a href="https://babeljs.io/">Babel</a> for ESNext &ndash;&gt; ES5 transpiling and a <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-ts">typescript version</a>.</p>

<p>Also check out our <a href="#api-reference">API reference</a> and <a href="#recipe-book">recipe book</a>.</p>

<p>Blog posts and tutorials:</p>

<ul>
<li><a href="https://www.vincit.fi/en/blog/introducing-moron-js-a-new-orm-for-node-js/">Introduction</a> (objection.js was originally called moron.js)</li>
<li><a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/">Eager loading</a></li>
<li><a href="https://www.vincit.fi/en/blog/by-the-power-of-json-queries/">Postgres JSON queries</a></li>
</ul>

<h1 id="models">Models</h1>

<blockquote>
<p>A working model with minimal amount of code:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MinimalModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">tableName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'SomeTableName'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">MinimalModel</span><span class="p">;</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">Model</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'objection'</span><span class="p">;</span>

<span class="kr">export</span> <span class="k">default</span> <span class="kr">class</span> <span class="nx">MinimalModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="s1">'SomeTableName'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Model with custom methods, json schema validation and relations. This model is used in the examples:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>

  <span class="c1">// Table name is the only required property.</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">tableName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'Person'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">fullName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Optional JSON schema. This is not the database schema!</span>
  <span class="c1">// Nothing is generated based on this. This is only used</span>
  <span class="c1">// for validation. Whenever a model instance is created</span>
  <span class="c1">// it is checked against this schema.</span>
  <span class="c1">// http://json-schema.org/.</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">jsonSchema</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
      <span class="na">required</span><span class="p">:</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">],</span>

      <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'integer'</span><span class="p">},</span>
        <span class="na">parentId</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="s1">'integer'</span><span class="p">,</span> <span class="s1">'null'</span><span class="p">]},</span>
        <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
        <span class="na">lastName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
        <span class="na">age</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'number'</span><span class="p">},</span>

        <span class="c1">// Properties defined as objects or arrays are</span>
        <span class="c1">// automatically converted to JSON strings when</span>
        <span class="c1">// writing to database and back to objects and arrays</span>
        <span class="c1">// when reading from database. To override this</span>
        <span class="c1">// behaviour, you can override the</span>
        <span class="c1">// Person.jsonAttributes property.</span>
        <span class="na">address</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
          <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">street</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
            <span class="na">city</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
            <span class="na">zipCode</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="c1">// This object defines the relations to other models.</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="c1">// The related model. This can be either a Model</span>
        <span class="c1">// subclass constructor or an absolute file path</span>
        <span class="c1">// to a module that exports one. We use the file</span>
        <span class="c1">// path version here to prevent require loops.</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/Animal'</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Animal.ownerId'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">movies</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ManyToManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/Movie'</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="c1">// ManyToMany relation needs the `through` object</span>
          <span class="c1">// to describe the join table.</span>
          <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1">// If you have a model class for the join table</span>
            <span class="c1">// you need to specify it like this:</span>
            <span class="c1">// modelClass: PersonMovie,</span>
            <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.personId'</span><span class="p">,</span>
            <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>
          <span class="p">},</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">children</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.parentId'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">parent</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.parentId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.id'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="c1">// Table name is the only required property.</span>
  <span class="kr">static</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="s1">'Person'</span><span class="p">;</span>

  <span class="nx">fullName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Optional JSON schema. This is not the database schema!</span>
  <span class="c1">// Nothing is generated based on this. This is only used</span>
  <span class="c1">// for validation. Whenever a model instance is created</span>
  <span class="c1">// it is checked against this schema.</span>
  <span class="c1">// http://json-schema.org/.</span>
  <span class="kr">static</span> <span class="nx">jsonSchema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
    <span class="na">required</span><span class="p">:</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">],</span>

    <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'integer'</span><span class="p">},</span>
      <span class="na">parentId</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="s1">'integer'</span><span class="p">,</span> <span class="s1">'null'</span><span class="p">]},</span>
      <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
      <span class="na">lastName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
      <span class="na">age</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'number'</span><span class="p">},</span>

      <span class="c1">// Properties defined as objects or arrays are</span>
      <span class="c1">// automatically converted to JSON strings when</span>
      <span class="c1">// writing to database and back to objects and arrays</span>
      <span class="c1">// when reading from database. To override this</span>
      <span class="c1">// behaviour, you can override the</span>
      <span class="c1">// Person.jsonAttributes property.</span>
      <span class="na">address</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
        <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">street</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
          <span class="na">city</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
          <span class="na">zipCode</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">// This object defines the relations to other models.</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
      <span class="c1">// The related model. This can be either a Model</span>
      <span class="c1">// subclass constructor or an absolute file path</span>
      <span class="c1">// to a module that exports one. We use the file</span>
      <span class="c1">// path version here to prevent require loops.</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/Animal'</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Animal.ownerId'</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ManyToManyRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/Movie'</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="c1">// ManyToMany relation needs the `through` object</span>
        <span class="c1">// to describe the join table.</span>
        <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
          <span class="c1">// If you have a model class for the join table</span>
          <span class="c1">// you need to specify it like this:</span>
          <span class="c1">// modelClass: PersonMovie,</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.personId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>
        <span class="p">},</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="na">children</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.parentId'</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="na">parent</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.parentId'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.id'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>
<p>Models are created by inheriting from the <a href="#model"><code class="prettyprint">Model</code></a> base class.</p>

<h1 id="relations">Relations</h1>

<blockquote>
<p><code class="prettyprint">BelongsToOneRelation</code>: Use this relation when the source model has the foreign key</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Animal</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">owner</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'animal.ownerId'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'person.id'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">HasManyRelation</code>: Use this relation when the related model has the foreign key</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">animals</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'person.id'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'animal.ownerId'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">HasOneRelation</code>: Just like <code class="prettyprint">HasManyRelation</code> but for one related row</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">animals</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasOneRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'person.id'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'animal.ownerId'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">ManyToManyRelation</code>: Use this relation when the model is related to a list of other models through a join table</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">movies</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ManyToManyRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Movie</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
          <span class="c1">// Person_Movie is the join table.</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.personId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>
        <span class="p">},</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">HasOneThroughRelation</code>: Use this relation when the model is related to a single model through a join table</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">movie</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasOneThroughRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Movie</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
          <span class="c1">// Person_Movie is the join table.</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.personId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>
        <span class="p">},</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>We already went through how to create relations in the <a href="#models">models</a> section but here&rsquo;s a list of all the
available relation types in a nicely searchable place. See the <a href="#relationmapping">this</a> API doc section for full
documentation of the relation mapping parameters.</p>

<p>Vocabulary for the relation descriptions:</p>

<ul>
<li>source model: The model for which you are writing the <code class="prettyprint">relationMapping</code> for.</li>
<li>related model: The model at the other end of the relation.</li>
</ul>

<h1 id="query-examples">Query examples</h1>

<p>The <code class="prettyprint">Person</code> model used in the examples is defined <a href="#models">here</a>.</p>

<p>All queries are started with one of the <a href="#model"><code class="prettyprint">Model</code></a> methods <a href="#query"><code class="prettyprint">query</code></a>, <a href="#_s_query"><code class="prettyprint">$query</code></a> or <a href="#_s_relatedquery"><code class="prettyprint">$relatedQuery</code></a>.
All these methods return a <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> instance that can be used just like a <a href="http://knexjs.org/#Builder">knex QueryBuilder</a>.</p>

<h2 id="table-queries">Table queries</h2>

<p>Each model class inherits the static <a href="#query"><code class="prettyprint">query</code></a> method from the <a href="#model"><code class="prettyprint">Model</code></a> base class. Use <a href="#query"><code class="prettyprint">query</code></a> to create queries
to the table the model class represents. The return value of the <a href="#query"><code class="prettyprint">query</code></a> method is an instance of <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>
that has all the methods a <a href="http://knexjs.org/#Builder">knex QueryBuilder</a> has and more.</p>

<h3 id="fetch-queries">Fetch queries</h3>

<blockquote>
<p>Fetch all people from the database:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Person</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'there are'</span><span class="p">,</span> <span class="nx">people</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">'People in total'</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'oh noes'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Person"</span>
</code></pre>
<blockquote>
<p>The return value of the <a href="#query"><code class="prettyprint">query</code></a> method is an instance of <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>
that has all the methods a <a href="http://knexjs.org/#Builder">knex QueryBuilder</a> has. Here is a simple example
that uses some of them:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&lt;'</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'Jennifer'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'lastName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">middleAgedJennifers</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'The last name of the first middle aged Jennifer is'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">middleAgedJennifers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lastName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Person"</span>
<span class="k">where</span> <span class="nv">"age"</span> <span class="o">&gt;</span> <span class="mi">40</span>
<span class="k">and</span> <span class="nv">"age"</span> <span class="o">&lt;</span> <span class="mi">60</span>
<span class="k">and</span> <span class="nv">"firstName"</span> <span class="o">=</span> <span class="s1">'Jennifer'</span>
<span class="k">order</span> <span class="k">by</span> <span class="nv">"lastName"</span> <span class="k">asc</span>
</code></pre>
<blockquote>
<p>In addition to knex methods, the <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> has a lot of helpers for dealing with
relations like the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'parent:parent.name as grandParentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'parent.parent'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">grandParentName</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">select</span> <span class="nv">"parent:parent"</span><span class="p">.</span><span class="nv">"firstName"</span> <span class="k">as</span> <span class="nv">"grandParentName"</span>
<span class="k">from</span> <span class="nv">"Person"</span>
<span class="k">inner</span> <span class="k">join</span> <span class="nv">"Person"</span> <span class="k">as</span> <span class="nv">"parent"</span> <span class="k">on</span> <span class="nv">"parent"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="nv">"Person"</span><span class="p">.</span><span class="nv">"parentId"</span>
<span class="k">inner</span> <span class="k">join</span> <span class="nv">"Person"</span> <span class="k">as</span> <span class="nv">"parent:parent"</span> <span class="k">on</span> <span class="nv">"parent:parent"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="nv">"parent"</span><span class="p">.</span><span class="nv">"parentId"</span>
</code></pre>
<blockquote>
<p>The next example shows how easy it is to build complex queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'Person.*'</span><span class="p">,</span> <span class="s1">'Parent.firstName as parentFirstName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'Person as Parent'</span><span class="p">,</span> <span class="s1">'Person.parentId'</span><span class="p">,</span> <span class="s1">'Parent.id'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'Person.age'</span><span class="p">,</span> <span class="s1">'&lt;'</span><span class="p">,</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'Person.age'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">whereExists</span><span class="p">(</span><span class="nx">Animal</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">select</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">whereRef</span><span class="p">(</span><span class="s1">'Person.id'</span><span class="p">,</span> <span class="s1">'Animal.ownerId'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'Person.lastName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentFirstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">select</span> <span class="nv">"Person"</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="nv">"Parent"</span><span class="p">.</span><span class="nv">"firstName"</span> <span class="k">as</span> <span class="nv">"parentFirstName"</span>
<span class="k">from</span> <span class="nv">"Person"</span>
<span class="k">inner</span> <span class="k">join</span> <span class="nv">"Person"</span> <span class="k">as</span> <span class="nv">"Parent"</span> <span class="k">on</span> <span class="nv">"Person"</span><span class="p">.</span><span class="nv">"parentId"</span> <span class="o">=</span> <span class="nv">"Parent"</span><span class="p">.</span><span class="nv">"id"</span>
<span class="k">where</span> <span class="nv">"Person"</span><span class="p">.</span><span class="nv">"age"</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="nv">"Person"</span><span class="p">.</span><span class="nv">"age"</span><span class="p">)</span> <span class="k">from</span> <span class="nv">"Person"</span><span class="p">)</span>
<span class="k">and</span> <span class="k">exists</span> <span class="p">(</span><span class="k">select</span> <span class="mi">1</span> <span class="k">from</span> <span class="nv">"Animal"</span> <span class="k">where</span> <span class="nv">"Person"</span><span class="p">.</span><span class="nv">"id"</span> <span class="o">=</span> <span class="nv">"Animal"</span><span class="p">.</span><span class="nv">"ownerId"</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="nv">"Person"</span><span class="p">.</span><span class="nv">"lastName"</span> <span class="k">asc</span>
</code></pre>
<p>Fetch queries can be created simply by calling <a href="#query"><code class="prettyprint">Model.query()</code></a> and chaining query builder methods for the returned
<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> instance. The query is executed by calling the <a href="#then"><code class="prettyprint">then</code></a> method, which converts the query
into a <a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>.</p>

<h3 id="insert-queries">Insert queries</h3>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span> <span class="k">instanceof</span> <span class="nx">Person</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span> <span class="c1">// --&gt; 'Jennifer'</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">fullName</span><span class="p">());</span> <span class="c1">// --&gt; 'Jennifer Lawrence'</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'oh noes'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">insert</span> <span class="k">into</span> <span class="nv">"Person"</span> <span class="p">(</span><span class="nv">"firstName"</span><span class="p">,</span> <span class="nv">"lastName"</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Jennifer'</span><span class="p">,</span> <span class="s1">'Lawrence'</span><span class="p">)</span>
</code></pre>
<p>Insert queries are created by chaining the <a href="#insert"><code class="prettyprint">insert</code></a> method to the query. See the <a href="#insertgraph"><code class="prettyprint">insertGraph</code></a> method
for inserting object graphs.</p>

<h3 id="update-queries">Update queries</h3>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">lastName</span><span class="p">:</span> <span class="s1">'Dinosaur'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numUpdated</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'all people over 60 years old are now dinosaurs'</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">numUpdated</span><span class="p">,</span> <span class="s1">'people were updated'</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">update</span> <span class="nv">"Person"</span> <span class="k">set</span> <span class="nv">"lastName"</span> <span class="o">=</span> <span class="s1">'Dinosaur'</span> <span class="k">where</span> <span class="nv">"age"</span> <span class="o">&gt;</span> <span class="mi">60</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patchAndFetchById</span><span class="p">(</span><span class="mi">246</span><span class="p">,</span> <span class="p">{</span><span class="na">lastName</span><span class="p">:</span> <span class="s1">'Updated'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updated</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">updated</span><span class="p">.</span><span class="nx">lastName</span><span class="p">);</span> <span class="c1">// --&gt; Updated.</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">update</span> <span class="nv">"Person"</span> <span class="k">set</span> <span class="nv">"lastName"</span> <span class="o">=</span> <span class="s1">'Updated'</span> <span class="k">where</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="mi">246</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Person"</span> <span class="k">where</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="mi">246</span>
</code></pre>
<p>Update queries are created by chaining the <a href="#update"><code class="prettyprint">update</code></a> or <a href="#patch"><code class="prettyprint">patch</code></a> method to the query. The <a href="#patch"><code class="prettyprint">patch</code></a> and <a href="#update"><code class="prettyprint">update</code></a>
methods return the number of updated rows. If you want the freshly updated model as a result you can use the helper
method <a href="#patchandfetchbyid"><code class="prettyprint">patchAndFetchById</code></a> and <a href="#updateandfetchbyid"><code class="prettyprint">updateAndFetchById</code></a>. On postgresql you can
simply chain <code class="prettyprint">.returning(&#39;*&#39;)</code> or take a look at <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for more ideas.</p>

<h3 id="delete-queries">Delete queries</h3>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'lower("firstName")'</span><span class="p">),</span> <span class="s1">'like'</span><span class="p">,</span> <span class="s1">'%ennif%'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numDeleted</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">numDeleted</span><span class="p">,</span> <span class="s1">'people were deleted'</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">delete</span> <span class="k">from</span> <span class="nv">"Person"</span> <span class="k">where</span> <span class="k">lower</span><span class="p">(</span><span class="nv">"firstName"</span><span class="p">)</span> <span class="k">like</span> <span class="s1">'%ennif%'</span>
</code></pre>
<p>Delete queries are created by chaining the <a href="#delete"><code class="prettyprint">delete</code></a> method to the query.<br>
NOTE: The return value of the query will be the number of deleted rows. <em>If you&rsquo;re using Postgres take a look at <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> if you&rsquo;d like the deleted rows to be returned as Model instances</em>.</p>

<h2 id="relation-queries">Relation queries</h2>

<p>While the static <a href="#query"><code class="prettyprint">query</code></a> method can be used to create a query to a whole table <a href="#_s_relatedquery"><code class="prettyprint">$relatedQuery</code></a>
method can be used to query a single relation. <a href="#_s_relatedquery"><code class="prettyprint">$relatedQuery</code></a> returns an instance of <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>
just like the <a href="#query"><code class="prettyprint">query</code></a> method.</p>

<h3 id="fetch-queries">Fetch queries</h3>
<pre class="highlight javascript"><code><span class="c1">// `person` is an instance of `Person` model.</span>
<span class="nx">person</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">pets</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">pets</span> <span class="o">===</span> <span class="nx">pets</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Animal</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Animal"</span>
<span class="k">where</span> <span class="nv">"species"</span> <span class="o">=</span> <span class="s1">'dog'</span>
<span class="k">and</span> <span class="nv">"Animal"</span><span class="p">.</span><span class="nv">"ownerId"</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">order</span> <span class="k">by</span> <span class="nv">"name"</span> <span class="k">asc</span>
</code></pre>
<p>Simply call <a href="#_s_relatedquery"><code class="prettyprint">$relatedQuery(&#39;pets&#39;)</code></a> for a model <em>instance</em> to fetch a relation for it. The relation name is
given as the only argument. The return value is a <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> so you once again have all the query methods
at your disposal. In many cases it&rsquo;s more convenient to use <a href="#eager-loading"><code class="prettyprint">eager loading</code></a> to fetch relations.</p>

<h3 id="insert-queries">Insert queries</h3>

<blockquote>
<p>Add a pet for a person:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// `person` is an instance of `Person` model.</span>
<span class="nx">person</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">fluffy</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fluffy</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">insert</span> <span class="k">into</span> <span class="nv">"Animal"</span> <span class="p">(</span><span class="nv">"name"</span><span class="p">,</span> <span class="nv">"ownerId"</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'Fluffy'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>If you want to write columns to the join table of a many-to-many relation you first need to specify the columns in
the <code class="prettyprint">extra</code> array of the <code class="prettyprint">through</code> object in <a href="#relationmappings"><code class="prettyprint">relationMappings</code></a> (see the examples behind the link).
For example, if you specified an array <code class="prettyprint">extra: [&#39;awesomeness&#39;]</code> in <code class="prettyprint">relationMappings</code> then <code class="prettyprint">awesomeness</code> is written to
the join table in the following example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// `person` is an instance of `Person` model.</span>
<span class="nx">person</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'The room'</span><span class="p">,</span> <span class="na">awesomeness</span><span class="p">:</span> <span class="mi">9001</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">movie</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'best movie ever was added'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight sql"><code><span class="k">insert</span> <span class="k">into</span> <span class="nv">"Movie"</span> <span class="p">(</span><span class="nv">"name"</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="s1">'The room'</span><span class="p">)</span>
<span class="k">insert</span> <span class="k">into</span> <span class="nv">"Person_Movie"</span> <span class="p">(</span><span class="nv">"movieId"</span><span class="p">,</span> <span class="nv">"personId"</span><span class="p">,</span> <span class="nv">"awesomeness"</span><span class="p">)</span> <span class="k">values</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">9001</span><span class="p">)</span>
</code></pre>
<p>Chain the <a href="#insert"><code class="prettyprint">insert</code></a> method to the <a href="#_s_relatedquery"><code class="prettyprint">$relatedQuery(&#39;pets&#39;)</code></a> call to insert a related object for a model
<em>instance</em>. The query inserts the new object to the related table and updates the needed tables to create the relation.
In case of many-to-many relation a row is inserted to the join table etc.</p>

<h3 id="update-queries">Update queries</h3>

<p>See the <a href="#update">API documentation</a> of <code class="prettyprint">update</code> method.</p>

<h3 id="delete-queries">Delete queries</h3>

<p>See the <a href="#delete">API documentation</a> of <code class="prettyprint">delete</code> method.</p>

<h3 id="relate-queries">Relate queries</h3>

<p>See the <a href="#relate">API documentation</a> of <code class="prettyprint">relate</code> method.</p>

<h3 id="unrelate-queries">Unrelate queries</h3>

<p>See the <a href="#unrelate">API documentation</a> of <code class="prettyprint">unrelate</code> method.</p>

<h1 id="eager-queries">Eager queries</h1>

<h2 id="eager-loading">Eager loading</h2>

<blockquote>
<p>Fetch the <code class="prettyprint">pets</code> relation for all results of a query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Each person has the `.pets` property populated with Animal objects related</span>
    <span class="c1">// through `pets` relation.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Animal</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Fetch multiple relations on multiple levels:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[pets, children.[pets, children]]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Each person has the `.pets` property populated with Animal objects related</span>
    <span class="c1">// through `pets` relation. The `.children` property contains the Person's</span>
    <span class="c1">// children. Each child also has the `pets` and `children` relations eagerly</span>
    <span class="c1">// fetched.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Fetch one relation recursively:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[pets, children.^]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// The children relation is from Person to Person. If we want to fetch the whole</span>
    <span class="c1">// descendant tree of a person we can just say "fetch this relation recursively"</span>
    <span class="c1">// using the `.^` notation.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Limit recursion to 3 levels:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[pets, children.^3]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Relations can be filtered using the <a href="#modifyeager"><code class="prettyprint">modifyEager</code></a> method:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[children.[pets, movies], movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'children.pets'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Only select pets older than 10 years old for children.</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">})</span>
</code></pre>
<blockquote>
<p>Relations can also be filtered using named filters like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[pets(orderByName, onlyDogs), children(orderByAge).[pets, children]]'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">orderByName</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">orderByAge</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'age'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">onlyDogs</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Example usage for <a href="#alloweager"><code class="prettyprint">allowEager</code></a> in an express route:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">expressApp</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/people'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">Person</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">allowEager</span><span class="p">(</span><span class="s1">'[pets, children.pets]'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">eager</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">people</span><span class="p">))</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Eager loading algorithm can be changed using the <a href="#eageralgorithm"><code class="prettyprint">eagerAlgorithm</code></a> method:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eagerAlgorithm</span><span class="p">(</span><span class="nx">Model</span><span class="p">.</span><span class="nx">JoinEagerAlgorithm</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[pets, children.pets]'</span><span class="p">);</span>
</code></pre>
<p>You can fetch an arbitrary graph of relations for the results of any query by chaining the <a href="#eager"><code class="prettyprint">eager</code></a> method.
<a href="#eager"><code class="prettyprint">eager</code></a> takes a <a href="#relationexpression">relation expression</a> string as a parameter. In addition to making your
life easier, eager queries avoid the &ldquo;select N+1&rdquo; problem and provide a great performance.</p>

<p>Because the eager expressions are strings they can be easily passed for example as a query parameter of an HTTP
request. However, allowing the client to pass expressions like this without any limitations is not very secure.
Therefore the <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> has the <a href="#alloweager"><code class="prettyprint">allowEager</code></a> method. <a href="#alloweager"><code class="prettyprint">allowEager</code></a>
can be used to  limit the allowed eager expression to a certain subset.</p>

<p>By giving expression <code class="prettyprint">[pets, children.pets]</code> for <a href="#alloweager"><code class="prettyprint">allowEager</code></a> the value passed to <a href="#eager"><code class="prettyprint">eager</code></a> is allowed
to be one of:</p>

<ul>
<li><code class="prettyprint">&#39;pets&#39;</code></li>
<li><code class="prettyprint">&#39;children&#39;</code></li>
<li><code class="prettyprint">&#39;children.pets&#39;</code></li>
<li><code class="prettyprint">&#39;[pets, children]&#39;</code></li>
<li><code class="prettyprint">&#39;[pets, children.pets]&#39;</code></li>
</ul>

<p>Examples of expressions that would cause the query to be rejected:</p>

<ul>
<li><code class="prettyprint">&#39;movies&#39;</code></li>
<li><code class="prettyprint">&#39;children.children&#39;</code></li>
<li><code class="prettyprint">&#39;[pets, children.children]&#39;</code></li>
<li><code class="prettyprint">&#39;notEvenAnExistingRelation&#39;</code></li>
</ul>

<p>In addition to the <a href="#eager"><code class="prettyprint">eager</code></a> method, relations can be fetched using the <a href="#loadrelated"><code class="prettyprint">loadRelated</code></a> and
<a href="#_s_loadrelated"><code class="prettyprint">$loadRelated</code></a> methods.</p>

<p>By default eager loading is done using multiple separate queries (for details see <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/">this blog post</a>).
You can choose to use a join based eager loading algorithm that only performs one single query to fetch thw whole
eager tree. You can select which algorithm to use per query using <a href="#eageralgorithm"><code class="prettyprint">eagerAlgorithm</code></a> method or
per model by setting the <a href="#defaulteageralgorithm"><code class="prettyprint">defaultEagerAlgorithm</code></a> property. Both algorithms
have their strengths and weaknesses, which are discussed in detail <a href="#eager">here</a>.</p>

<h2 id="graph-inserts">Graph inserts</h2>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sylvester'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Stallone'</span><span class="p">,</span>

    <span class="na">children</span><span class="p">:</span> <span class="p">[{</span>
      <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sage'</span><span class="p">,</span>
      <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Stallone'</span><span class="p">,</span>

      <span class="na">pets</span><span class="p">:</span> <span class="p">[{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy'</span><span class="p">,</span>
        <span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span>
      <span class="p">}]</span>
    <span class="p">}]</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>The query above will insert &lsquo;Sylvester&rsquo;, &#39;Sage&rsquo; and &#39;Fluffy&rsquo; into db and create relationships between them as defined
in the <a href="#relationmappings"><code class="prettyprint">relationMappings</code></a> of the models. Technically <a href="#insertgraph"><code class="prettyprint">insertGraph</code></a>
builds a dependency graph from the object graph and inserts the models that don&rsquo;t depend on any other models until
the whole graph is inserted.</p>

<p>If you need to refer to the same model in multiple places you can use the special properties <code class="prettyprint">#id</code> and <code class="prettyprint">#ref</code> like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">([{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">[{</span>
      <span class="s2">"#id"</span><span class="p">:</span> <span class="s1">'silverLiningsPlaybook'</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'Silver Linings Playbook'</span><span class="p">,</span>
      <span class="na">duration</span><span class="p">:</span> <span class="mi">122</span>
    <span class="p">}]</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Bradley'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Cooper'</span><span class="p">,</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">[{</span>
      <span class="s2">"#ref"</span><span class="p">:</span> <span class="s1">'silverLiningsPlaybook'</span>
    <span class="p">}]</span>
  <span class="p">}]);</span>
</code></pre>
<blockquote>
<p>The query above will insert only one movie (the &#39;Silver Linings Playbook&rsquo;) but both &#39;Jennifer&rsquo; and &#39;Bradley&rsquo; will have
the movie related to them through the many-to-many relation <code class="prettyprint">movies</code>. The <code class="prettyprint">#id</code> can be any string. There are no format
or length requirements for them. It is quite easy to create circular dependencies using <code class="prettyprint">#id</code> and <code class="prettyprint">#ref</code>. Luckily
<a href="#insertgraph"><code class="prettyprint">insertGraph</code></a> detects them and rejects the query with a clear error message.</p>

<p>You can refer to the properties of other models anywhere in the graph using expressions of format <code class="prettyprint">#ref{&lt;id&gt;.&lt;property&gt;}</code>
as long as the reference doesn&rsquo;t create a circular dependency. For example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">([{</span>
    <span class="s2">"#id"</span><span class="p">:</span> <span class="s1">'jenniLaw'</span><span class="p">,</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>

    <span class="na">pets</span><span class="p">:</span> <span class="p">[{</span>
      <span class="na">name</span><span class="p">:</span> <span class="s2">"I am the dog of #ref{jenniLaw.firstName} whose id is #ref{jenniLaw.id}"</span><span class="p">,</span>
      <span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span>
    <span class="p">}]</span>
  <span class="p">}]);</span>
</code></pre>
<blockquote>
<p>The query above will insert a pet named <code class="prettyprint">I am the dog of Jennifer whose id is 523</code> for Jennifer. If <code class="prettyprint">#ref{}</code> is used
within a string, the references are replaced with the referred values inside the string. If the reference string
contains nothing but the reference, the referred value is copied to it&rsquo;s place preserving its type.</p>
</blockquote>

<p>Arbitrary relation graphs can be inserted using the <a href="#insertgraph"><code class="prettyprint">insertGraph</code></a> method. This is best explained using
examples, so check them out ➔.</p>

<p>See the <a href="#allowinsert"><code class="prettyprint">allowInsert</code></a> method if you need to limit  which relations can be inserted using
<a href="#insertgraph"><code class="prettyprint">insertGraph</code></a> method to avoid security issues. <a href="#allowinsert"><code class="prettyprint">allowInsert</code></a>
works like <a href="#allowinsert"><code class="prettyprint">allowEager</code></a>.</p>

<p>If you are using Postgres the inserts are done in batches for maximum performance. On other databases the rows need to
be inserted one at a time. This is because postgresql is the only database engine that returns the identifiers of all
inserted rows and not just the first or the last one.</p>

<p>You can read more about graph inserts from <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/">this blog post</a>.</p>

<h1 id="transactions">Transactions</h1>

<p>There are two ways to work with transactions in objection:</p>

<ol>
<li><a href="#passing-around-a-transaction-object">Passing around a transaction object</a></li>
<li><a href="#binding-models-to-a-transaction">Binding models to a transaction</a></li>
</ol>

<h2 id="passing-around-a-transaction-object">Passing around a transaction object</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">knex</span><span class="p">();</span>

<span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">knex</span><span class="p">,</span> <span class="nx">trx</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Person</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">trx</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">jennifer</span>
        <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">,</span> <span class="nx">trx</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">});</span>
    <span class="p">});</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">scrappy</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer and Scrappy were successfully inserted'</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>ESNext</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">knex</span><span class="p">();</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">scrappy</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">knex</span><span class="p">,</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">trx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">jennifer</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">Person</span>
      <span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">trx</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>

    <span class="k">return</span> <span class="nx">await</span> <span class="nx">jennifer</span>
      <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">,</span> <span class="nx">trx</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer and Scrappy were successfully inserted'</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Note that you can pass either a normal knex instance or a transaction to <code class="prettyprint">query</code>, <code class="prettyprint">$relatedQuery</code> etc.
allowing you to build helper functions and services that can be used with or without a transaction.
When a transation is not wanted, just pass in the normal knex instance:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// `db` can be either a transaction or a knex instance or even</span>
<span class="c1">// `null` or `undefined` if you have globally set the knex </span>
<span class="c1">// instance using `Model.knex(knex)`.</span>
<span class="kd">function</span> <span class="nx">insertPersonAndPet</span><span class="p">(</span><span class="nx">person</span><span class="p">,</span> <span class="nx">pet</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">Person</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">person</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">person</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">person</span>
        <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">pet</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre>
<p>A transaction is started by calling <code class="prettyprint">objection.transaction</code> method. You need to pass a knex instance as the first argument.
If you don&rsquo;t have the knex instance otherwise available you can always access it through any <code class="prettyprint">Model</code> using <code class="prettyprint">Model.knex()</code>
provided that you have set the knex instance globally using <code class="prettyprint">Model.knex(knex)</code> at some point.</p>

<p>The second argument is a callback that gets passed a transaction object. The transaction object is actually just a
<a href="http://knexjs.org/#Transactions">knex transaction object</a> and you can start the transaction just as well using
<code class="prettyprint">knex.transaction</code> function. You then need to pass the transaction to all queries you want to execute in that
transaction. <a href="#query">query</a>, <a href="#_s_query">$query</a> and <a href="#_s_relatedquery">$relatedQuery</a> accept a transaction
as their last argument.</p>

<p>The transaction is committed if the promise returned from the callback is resolved successfully. If the returned Promise
is rejected or an error is thrown inside the callback the transaction is rolled back.</p>

<p>Transactions in javascript are a bit of a PITA if you are used to threaded frameworks and languages like java. In those
a single chain of operations (for example a single request) is handled in a dedicated thread. Transactions are usually 
started for the whole thread and every database operation you perform after the start automatically takes part in the<br>
transaction because they can access the thread local transaction and the framework can be sure that no other chain of
operations (no other request) uses the same transaction.</p>

<p>In javascript there are no threads. We need to explicitly take care that our operations are executed in the correct
transaction. Based on our experience the most transparent and least error-prone way to do this is to explicitly pass
a transaction object to each operation explicitly.</p>

<h2 id="binding-models-to-a-transaction">Binding models to a transaction</h2>
<pre class="highlight javascript"><code><span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">Animal</span><span class="p">,</span> <span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">Animal</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Person and Animal inside this function are bound to a newly</span>
  <span class="c1">// created transaction. The Person and Animal outside this function</span>
  <span class="c1">// are not! Even if you do `require('./models/Person')` inside this</span>
  <span class="c1">// function and start a query using the required `Person` it will</span>
  <span class="c1">// NOT take part in the tranaction. Only the actual objects passed</span>
  <span class="c1">// to this function are bound to the transaction.</span>

  <span class="k">return</span> <span class="nx">Person</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">Animal</span>
        <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">});</span>
    <span class="p">});</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">scrappy</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer and Scrappy were successfully inserted'</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>You only need to give the <a href="#transaction"><code class="prettyprint">transaction</code></a> function the model classes you use explicitly. All the
related model classes are implicitly bound to the same transaction:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">Person</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">Person</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// This creates a query using the `Animal` model class but we</span>
      <span class="c1">// don't need to give `Animal` as one of the arguments to the</span>
      <span class="c1">// transaction function because `jennifer` is an instance of</span>
      <span class="c1">// the `Person` that is bound to a transaction.</span>
      <span class="k">return</span> <span class="nx">jennifer</span>
        <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">});</span>
    <span class="p">});</span>

<span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">scrappy</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer and Scrappy were successfully inserted'</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>The only way you can mess up with the transactions is if you <em>explicitly</em> start a query using a model class
that is not bound to the transaction:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">Person</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/Person'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">Animal</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/Animal'</span><span class="p">);</span>

<span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">BoundPerson</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="c1">// This will be executed inside the transaction.</span>
  <span class="k">return</span> <span class="nx">BoundPerson</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// OH NO! This query is executed outside the transaction</span>
      <span class="c1">// since the `Animal` class is not bound to the transaction.</span>
      <span class="k">return</span> <span class="nx">Animal</span>
        <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">});</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// OH NO! This query is executed outside the transaction</span>
      <span class="c1">// since the `Person` class is not bound to the transaction.</span>
      <span class="c1">// BoundPerson !== Person.</span>
      <span class="k">return</span> <span class="nx">Person</span>
        <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Bradley'</span><span class="p">});</span>
    <span class="p">});</span>

<span class="p">});</span>
</code></pre>
<blockquote>
<p>The transaction object is always passed as the last argument to the callback:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">trx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// `trx` is the knex transaction object.</span>
  <span class="c1">// It can be passed to `transacting`, `query` etc.</span>
  <span class="c1">// methods, or used as a knex query builder.</span>

  <span class="kd">var</span> <span class="nx">q1</span> <span class="o">=</span> <span class="nx">trx</span><span class="p">(</span><span class="s1">'Person'</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">});</span>
  <span class="kd">var</span> <span class="nx">q2</span> <span class="o">=</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">trx</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">});</span>
  <span class="kd">var</span> <span class="nx">q3</span> <span class="o">=</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">transacting</span><span class="p">(</span><span class="nx">trx</span><span class="p">).</span><span class="nx">insert</span><span class="p">({</span><span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy'</span><span class="p">});</span>

  <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">q1</span><span class="p">,</span> <span class="nx">q2</span><span class="p">,</span> <span class="nx">q3</span><span class="p">]);</span>

<span class="p">}).</span><span class="nx">spread</span><span class="p">((</span><span class="nx">jennifer</span><span class="p">,</span> <span class="nx">scrappy</span><span class="p">,</span> <span class="nx">fluffy</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer, Scrappy and Fluffy were successfully inserted'</span><span class="p">);</span>
<span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Something went wrong. Jennifer, Scrappy and Fluffy were not inserted'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>The second way to use transactions avoids passing around a transaction object by &ldquo;binding&rdquo; model
classes to a transaction. You pass all models you want to bind as arguments to the <code class="prettyprint">objection.transaction</code> 
method and as the last argument you provide a callback that receives <strong>copies</strong> of the models that have 
been bound to a newly started transaction. All queries started through the bound copies take part in the 
transaction and you don&rsquo;t need to pass around a transaction object. Note that the models passed to the 
callback are actual copies of the models passed as arguments to <code class="prettyprint">objection.transaction</code> and starting a 
query through any other object will <strong>not</strong> be executed inside a transaction.</p>

<p>Originally we advertised this way of doing transactions as a remedy to the transaction passing
plaque but it has turned out to be pretty error-prone. This approach is handy for single inline
functions that do a handful of operations, but becomes tricky when you have to call services
and helper methods that also perform database queries. To get the helpers and service functions
to participate in the transaction you need to pass around the bound copies of the model classes.
If you <code class="prettyprint">require</code> the same models in the helpers and start queries through them, they will <strong>not</strong>
be executed in the transaction since the required models are not the bound copies, but the original
models from which the copies were taken.</p>

<h1 id="documents">Documents</h1>

<blockquote>
<p>The <code class="prettyprint">address</code> property of the Person model is defined as an object in the <a href="#models">Person.jsonSchema</a>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
    <span class="na">address</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">street</span><span class="p">:</span> <span class="s1">'Somestreet 10'</span><span class="p">,</span>
      <span class="na">zipCode</span><span class="p">:</span> <span class="s1">'123456'</span><span class="p">,</span>
      <span class="na">city</span><span class="p">:</span> <span class="s1">'Tampere'</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">city</span><span class="p">);</span> <span class="c1">// --&gt; Tampere</span>
    <span class="k">return</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jenniferFromDb</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jenniferFromDb</span><span class="p">.</span><span class="nx">address</span><span class="p">.</span><span class="nx">city</span><span class="p">);</span> <span class="c1">// --&gt; Tampere</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'oh noes'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Objection.js makes it easy to store non-flat documents as table rows. All properties of a model that are marked as
objects or arrays in the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> are automatically converted to JSON strings in the database and
back to objects when read from the database. The database columns for the object properties can be normal
text columns. Postgresql has the <code class="prettyprint">json</code> and <code class="prettyprint">jsonb</code> data types that can be used instead for better performance
and possibility to <a href="http://www.postgresql.org/docs/9.4/static/functions-json.html">write queries</a> to the documents.</p>

<h1 id="validation">Validation</h1>

<blockquote>
<p>All these will trigger the validation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">});</span>
<span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">});</span>
<span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">update</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">}).</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="c1">// Patch operation ignores the `required` property of the schema and only validates the</span>
<span class="c1">// given properties. This allows a subset of model's properties to be updated.</span>
<span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">patch</span><span class="p">({</span><span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">}).</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&lt;'</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Validation errors provide detailed error message:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'jennifer'</span><span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span> <span class="k">instanceof</span> <span class="nx">objection</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span> <span class="c1">// --&gt; {lastName: [{message: 'required property missing', ...}]}</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Error parameters returned by <a href="#validationerror"><code class="prettyprint">ValidationError</code></a> could be used to provide custom error messages:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'jennifer'</span><span class="p">}).</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">lastNameErrors</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="s1">'lastName'</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">lastNameErrors</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">lastNameError</span> <span class="o">=</span> <span class="nx">lastNameErrors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">lastNameError</span><span class="p">.</span><span class="nx">keyword</span> <span class="o">===</span> <span class="s2">"required"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'This field is required!'</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">lastNameError</span><span class="p">.</span><span class="nx">keyword</span> <span class="o">===</span> <span class="s2">"minLength"</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Must be longer than '</span> <span class="o">+</span> <span class="nx">lastNameError</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">limit</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">lastNameError</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span> <span class="c1">// Fallback to default error message</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<p><a href="http://json-schema.org/">JSON schema</a> validation can be enabled by setting the <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> property
of a model class. The validation is ran each time a <a href="#model"><code class="prettyprint">Model</code></a> instance is created.</p>

<p>You rarely need to call <a href="#_s_validate"><code class="prettyprint">$validate</code></a> method explicitly, but you can do it when needed. If validation fails a
<a href="#validationerror"><code class="prettyprint">ValidationError</code></a> will be thrown. Since we use Promises, this usually means that a promise will be rejected
with an instance of <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>See <a href="#custom-validation">the recipe book</a> for instructions if you want to use some other validation library.</p>

<h1 id="plugins">Plugins</h1>

<h2 id="list-of-plugins-and-modules-for-objection">List of plugins and modules for objection</h2>

<p>A curated list of good plugins and modules for objection. Only plugins that follow <a href="#plugin-development-best-practices">the best practices</a> 
are accepted on this list. Other modules like plugins for other frameworks and things that cannot be implemented following the best 
practices are an exception to this rule. If you are a developer or otherwise know of a good plugin/module for objection, please 
create a pull request or an issue to get it added to this list.</p>

<ul>
    <li>
        <a href="https://github.com/scoutforpets/objection-password" target="_blank">objection-password</a> -
        automatic password hashing for your models
    </li>
</ul>

<h2 id="plugin-development-best-practices">Plugin development best practices</h2>

<blockquote>
<p>Mixin is just a function that takes a class and returns an extended subclass.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">SomeMixin</span><span class="p">(</span><span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">SomeExtendedModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
    <span class="c1">// Your modifications.</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Mixins can be then applied like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">SomeMixin</span><span class="p">(</span><span class="nx">Model</span><span class="p">)</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre>
<blockquote>
<p>Multiple mixins:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">SomeMixin</span><span class="p">(</span><span class="nx">SomeOtherMixin</span><span class="p">(</span><span class="nx">Model</span><span class="p">))</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre>
<p>When possible, objection.js plugins should be implemented as <a href="http://justinfagnani.com/2015/12/21/real-mixins-with-javascript-classes/">class mixins</a>. 
A mixin is simply a function that takes a class as an argument and returns a subclass. Plugins should 
avoid modifying <code class="prettyprint">objection.Model</code>, <code class="prettyprint">objection.QueryBuilder</code> or any other global variables directly.
See the <a href="https://github.com/Vincit/objection.js/tree/master/examples/plugin">example plugin</a> for more
info. There is also <a href="https://github.com/Vincit/objection.js/tree/master/examples/plugin-with-options">another example</a>
that should be followed if your plugin needs options or configuration parameters.</p>

<h1 id="contribution-guide">Contribution guide</h1>

<h2 id="issues">Issues</h2>

<p>You can use <a href="https://github.com/Vincit/objection.js/issues">github issues</a> to request features and file bug reports.
An issue is also a good place to ask questions. We are happy to help out if you have reached a dead end, but please try
to solve the problem yourself first. The <a href="https://gitter.im/Vincit/objection.js">gitter chat</a> is also a good place to
ask for help.</p>

<p>When creating an issue there are couple of things you need to remember:</p>

<ol>
<li><p><strong>Update to the latest version of objection if possible and see if the problem remains.</strong> If updating is not an
option you can still request critical bug fixes for older versions.</p></li>
<li><p><strong>Describe your problem.</strong> What is happening and what you expect to happen.</p></li>
<li><p><strong>Provide enough information about the problem for others to reproduce it.</strong> The fastest way to get your bug fixed or
problem solved is to create a simple standalone app or a test case that demonstrates your problem. If that&rsquo;s too much
work then at least provide the code that fails with enough context and any possible stack traces. Please bear in mind
that objection has hundreds of tests and if you run into a problem, say with <code class="prettyprint">insert</code> function, it probably doesn&rsquo;t mean
that <code class="prettyprint">insert</code> is totally and completely broken, but some small part of it you are using is. That&rsquo;s why enough context
is necessary.</p></li>
</ol>

<h2 id="pull-requests">Pull requests</h2>

<p>If you have found a bug or want to add a feature, pull requests are always welcome! It&rsquo;s better to create an issue
first to open a discussion if the feature is something that should be added to objection. In case of bugfixes it&rsquo;s also
a good idea to open an issue indicating that you are working on a fix.</p>

<p>For a pull request to get merged it needs to have the following things:</p>

<ol>
<li><p>A good description of what the PR fixes or adds. You can just add a link to the corresponding issue.</p></li>
<li><p>Test(s) that verifies the fix/feature. It&rsquo;s possible to create a PR without tests and ask for someone else to write
them but in that case it may take a long time or forever until someone finds time to do it. Untested code will never get
merged!</p></li>
<li><p>For features you also need to write documentation.</p></li>
</ol>

<h2 id="development-guide">Development guide</h2>

<h3 id="development-setup">Development setup</h3>

<blockquote>
<p>clone</p>
</blockquote>
<pre class="highlight shell"><code>git clone git@github.com:&lt;your-account&gt;/objection.js.git objection
</code></pre>
<blockquote>
<p>create users and databases</p>
</blockquote>
<pre class="highlight shell"><code>psql -U postgres -c <span class="s2">"CREATE USER objection SUPERUSER"</span>
psql -U postgres -c <span class="s2">"CREATE DATABASE objection_test"</span>
mysql -u root -e <span class="s2">"CREATE USER objection"</span>
mysql -u root -e <span class="s2">"GRANT ALL PRIVILEGES ON *.* TO objection"</span>
mysql -u root -e <span class="s2">"CREATE DATABASE objection_test"</span>
</code></pre>
<ol>
<li><p>Fork objection in github</p></li>
<li><p>Clone objection</p></li>
<li><p>Install MySQL and PostgreSQL</p></li>
<li><p>Create test users and databases</p></li>
<li><p>Run <code class="prettyprint">npm test</code> in objection&rsquo;s root to see if everything works.</p></li>
</ol>

<h3 id="develop">Develop</h3>

<p>Code and tests need to be written in ES2015 subset supported by node 4.0.0. The best way to make sure of this is
to develop with the correct node version. <a href="https://github.com/creationix/nvm">nvm</a> is a great tool for swapping
between node versions.</p>

          <h1 id="recipe-book">Recipe book</h1>

<h2 id="raw-queries">Raw queries</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">raw</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">);</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'coalesce(sum(??), 0) as ??'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'childAgeSum'</span><span class="p">]))</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s2">`?? || ' ' || ??`</span><span class="p">,</span> <span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">),</span> <span class="s1">'Arnold Schwarzenegger'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'random()'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">childAgeSums</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">childAgeSums</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childAgeSum</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'coalesce(sum(??), 0) as ??'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'childAgeSum'</span><span class="p">]))</span>
  <span class="p">.</span><span class="nx">groupBy</span><span class="p">(</span><span class="s1">'parentId'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">childAgeSums</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">childAgeSums</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childAgeSum</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>To mix raw SQL with queries, use the <a href="#raw"><code class="prettyprint">raw</code></a> function from the main module 
or the <code class="prettyprint">raw</code> method of any <a href="#model"><code class="prettyprint">Model</code></a> subclass. The only difference between
these two is that the <code class="prettyprint">raw</code> function from the main module doesn&rsquo;t depend on knex
where as <code class="prettyprint">Model.raw()</code> will throw if the model doesn&rsquo;t have a knex instance installed.
Both of these functions work just like the <a href="http://knexjs.org/#Raw">knex&rsquo;s raw method</a>. 
And of course you can just use <code class="prettyprint">knex.raw()</code>.</p>

<p>There are also some helper methods such as <a href="#whereraw"><code class="prettyprint">whereRaw</code></a> in the <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>.</p>

<h2 id="json-queries">JSON queries</h2>
<pre class="highlight javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">ref</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'objection'</span><span class="p">;</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">([</span>
    <span class="s1">'id'</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">(</span><span class="s1">'jsonColumn:details.name'</span><span class="p">).</span><span class="nx">castText</span><span class="p">().</span><span class="nx">as</span><span class="p">(</span><span class="s1">'name'</span><span class="p">),</span>
    <span class="nx">ref</span><span class="p">(</span><span class="s1">'jsonColumn:details.age'</span><span class="p">).</span><span class="nx">castInt</span><span class="p">().</span><span class="nx">as</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span>
  <span class="p">])</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'Animal'</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Person.jsonColumn:details.name'</span><span class="p">).</span><span class="nx">castText</span><span class="p">(),</span> <span class="s1">'='</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Animal.name'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Animal.jsonData:details.ageLimit'</span><span class="p">));</span>
</code></pre>
<blockquote>
<p>Individual json fields can be updated like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
    <span class="s1">'jsonColumn:details.name'</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="s1">'jsonColumn:details.age'</span><span class="p">:</span> <span class="mi">29</span>
  <span class="p">});</span>
</code></pre>
<p>You can use the <a href="#ref"><code class="prettyprint">ref</code></a> function from the main module to refer to json columns
in queries. There is also a bunch of query building methods that have <code class="prettyprint">Json</code> in their
names. Check them out too.</p>

<p>See <a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a> for more information about how to refer to
json fields.</p>

<p>Json queries currently only work with postgres.</p>

<h2 id="change-id-column">Change id column</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">idColumn</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'person_id'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Name of the identifier column can be changed by setting the static <a href="#idcolumn"><code class="prettyprint">idColumn</code></a> property of a model class.
Composite key can be defined by using an array of column names.</p>

<h2 id="custom-validation">Custom validation</h2>

<blockquote>
<p>Additional validation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">beforeInsert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">objection</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">({</span>
        <span class="na">id</span><span class="p">:</span> <span class="p">[{</span>
          <span class="na">message</span><span class="p">:</span> <span class="s1">'identifier should not be defined before insert'</span>
          <span class="na">keyword</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
          <span class="na">params</span><span class="p">:</span> <span class="kc">null</span>
        <span class="p">}]</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Modifying the <a href="https://github.com/epoberezkin/ajv">Ajv</a> based <code class="prettyprint">jsonSchema</code> validation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">AjvValidator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">AjvValidator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">AjvValidator</span><span class="p">({</span>
      <span class="na">onCreateAjv</span><span class="p">:</span> <span class="p">(</span><span class="nx">ajv</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Here you can modify the `Ajv` instance.</span>
      <span class="p">},</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">allErrors</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">validateSchema</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">ownProperties</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">v5</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Replace <code class="prettyprint">jsonSchema</code> validation with any other validation scheme by
implementing a custom <a href="#validator"><code class="prettyprint">Validator</code></a>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// MyCustomValidator.js</span>

<span class="kr">const</span> <span class="nx">Validator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Validator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MyCustomValidator</span> <span class="kr">extends</span> <span class="nx">Validator</span> <span class="p">{</span>
  <span class="nx">validate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The model instance. May be empty at this point.</span>
    <span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>

    <span class="c1">// The properties to validate. After validation these values will</span>
    <span class="c1">// be merged into `model` by objection.</span>
    <span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">json</span><span class="p">;</span>

    <span class="c1">// `ModelOptions` object. If your custom validator sets default</span>
    <span class="c1">// values, you need to check the `opt.patch` boolean. If it is true</span>
    <span class="c1">// we are validating a patch object, the defaults should not be set.</span>
    <span class="kr">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>

    <span class="c1">// A context object shared between the validation methods. A new</span>
    <span class="c1">// object is created for each validation operation.</span>
    <span class="kr">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ctx</span><span class="p">;</span>

    <span class="c1">// Do your validation here and throw any exception if the</span>
    <span class="c1">// validation fails.</span>
    <span class="nx">doSomeValidationAndThrowIfFails</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>

    <span class="c1">// You need to return the (possibly modified) json.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">beforeValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Takes the same arguments as `validate`. Usually there is no need</span>
    <span class="c1">// to override this.</span>
    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">beforeValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">afterValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Takes the same arguments as `validate`. Usually there is no need</span>
    <span class="c1">// to override this.</span>
    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">afterValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// BaseModel.js</span>

<span class="kr">const</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">;</span>

<span class="c1">// Override the `createValidator` method of a `Model` to use the</span>
<span class="c1">// custom validator.</span>
<span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyCustomValidator</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>If you want to use the json schema validation but add some custom validation on top of it you can override the
<a href="#_s_beforevalidate"><code class="prettyprint">$beforeValidate</code></a> or <a href="#_s_aftervalidate"><code class="prettyprint">$afterValidate</code></a> method.</p>

<p>If you need to do validation on insert or update you can throw exceptions from the
<a href="#_s_beforeinsert"><code class="prettyprint">$beforeInsert</code></a> and <a href="#_s_beforeupdate"><code class="prettyprint">$beforeUpdate</code></a> methods.</p>

<p>If you don&rsquo;t want to use the built-in json schema validation, you can just ignore the <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> property.
It is completely optional. If you want to use some other validation library you need to implement a custom <a href="#validator"><code class="prettyprint">Validator</code></a>
(see the example).</p>

<h2 id="map-column-names-to-different-property-names">Map column names to different property names</h2>

<blockquote>
<p>snake_case/camelCase conversion:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// It's a good idea to memoize the conversion functions.</span>
<span class="kr">const</span> <span class="nx">snakeCase</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">snakeCase</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">camelCase</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">memoize</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">camelCase</span><span class="p">);</span>

<span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="c1">// This is called when an object is serialized to database format.</span>
  <span class="nx">$formatDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$formatDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">mapKeys</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">snakeCase</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// This is called when an object is read from database.</span>
  <span class="nx">$parseDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">mapKeys</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">camelCase</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$parseDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Note that even though column names are mapped when fetching / storing data, one still has to use
db column names when writing queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">await</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">insert</span><span class="p">({</span> <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span> <span class="p">});</span>
<span class="kd">let</span> <span class="nx">jen</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s1">'first_name'</span><span class="p">,</span> <span class="s1">'Jennifer'</span><span class="p">);</span>
<span class="nx">expect</span><span class="p">(</span><span class="nx">jen</span><span class="p">.</span><span class="nx">firstName</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'Jennifer'</span><span class="p">);</span>
</code></pre>
<p>Sometimes you may want to use for example snake_cased column names in database tables
and camelCased property names in code. You can use the functions</p>

<ul>
<li><a href="#_s_parsedatabasejson"><code class="prettyprint">$parseDatabaseJson</code></a></li>
<li><a href="#_s_formatdatabasejson"><code class="prettyprint">$formatDatabaseJson</code></a></li>
<li><a href="#_s_parsejson"><code class="prettyprint">$parseJson</code></a></li>
<li><a href="#_s_formatjson"><code class="prettyprint">$formatJson</code></a></li>
</ul>

<p>to convert data between database and &ldquo;external&rdquo; representations.</p>

<h2 id="paging">Paging</h2>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 100</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span> <span class="c1">// --&gt; 3341</span>
  <span class="p">});</span>
</code></pre>
<p>Any query can be paged using the <a href="#page"><code class="prettyprint">page</code></a> or <a href="#range"><code class="prettyprint">range</code></a> method.</p>

<h2 id="subqueries">Subqueries</h2>

<blockquote>
<p>You can use functions:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">).</span><span class="nx">from</span><span class="p">(</span><span class="s1">'Person'</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Or <code class="prettyprint">QueryBuilder</code>s:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">peopleOlderThanAverage</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Subqueries can be written just like in knex: by passing a function in place of a value. A bunch of query building
methods accept a function. See the knex.js documentation or just try it out. A function is accepted in most places
you would expect. You can also pass <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> instances or knex queries instead of functions.</p>

<h2 id="joins">Joins</h2>

<blockquote>
<p>Normal knex-style join:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'Person.*'</span><span class="p">,</span> <span class="s1">'Parent.firstName as parentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'Person as Parent'</span><span class="p">,</span> <span class="s1">'Person.parentId'</span><span class="p">,</span> <span class="s1">'Parent.id'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p><a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> helper for joining relation graphs:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'parent:parent.name as grandParentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'parent.parent'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">grandParentName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Again, <a href="http://knexjs.org/#Builder-join">do as you would with a knex query builder</a>. Objection also has helpers like
the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method family.</p>

<h2 id="postgresql-quot-returning-quot-tricks">PostgreSQL &ldquo;returning&rdquo; tricks</h2>

<blockquote>
<p>Insert and return a Model instance in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">createdAt</span><span class="p">);</span> <span class="c1">// NOW()-ish</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="c1">// Sequence ID</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Update a single row by ID and return the updated Model instance in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jenn'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span> <span class="c1">// Ensures we're returned a single row in the promise resolution</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">);</span> <span class="c1">// NOW()-ish</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span> <span class="c1">// "Jenn"</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Patch a Model instance and receive DB updates to Model instance in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'J.'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span> <span class="c1">// Ensures we're returned a single row in the promise resolution</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">updatedAt</span><span class="p">);</span> <span class="c1">// NOW()-ish</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span> <span class="c1">// "J."</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Delete all Persons named Jennifer and return the deleted rows as Model instances in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jenn'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">deletedJennifers</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">deletedJennifers</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// However many Jennifers there were</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">deletedJennifers</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">lastName</span><span class="p">);</span> <span class="c1">// Maybe "Lawrence"</span>
  <span class="p">});</span>

</code></pre>
<blockquote>
<p>Delete all of Jennifer&rsquo;s dogs and return the deleted Model instances in 1 query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">({</span><span class="s1">'species'</span><span class="p">:</span> <span class="s1">'dog'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">returning</span><span class="p">(</span><span class="s1">'*'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennsDeletedDogs</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennsDeletedDogs</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// However many dogs Jennifer had</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennsDeletedDogs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// Maybe "Fido"</span>
  <span class="p">});</span>

</code></pre>
<p>Because PostgreSQL (and some others) support <code class="prettyprint">returning(&#39;*&#39;)</code> chaining, you can actually <code class="prettyprint">insert</code> a row, or
<code class="prettyprint">update</code> / <code class="prettyprint">patch</code> / <code class="prettyprint">delete</code> (an) existing row(s), <strong>and</strong> receive the affected row(s) as Model instances in a single query, thus improving efficiency. See the examples for more clarity.</p>

<h2 id="polymorphic-associations">Polymorphic associations</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Issue</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">comments</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Comment</span><span class="p">,</span>
        <span class="na">filter</span><span class="p">:</span> <span class="p">{</span><span class="na">commentableType</span><span class="p">:</span> <span class="s1">'Issue'</span><span class="p">},</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Issue.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Comment.commentableId'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">PullRequest</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">comments</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Comment</span><span class="p">,</span>
        <span class="na">filter</span><span class="p">:</span> <span class="p">{</span><span class="na">commentableType</span><span class="p">:</span> <span class="s1">'PullRequest'</span><span class="p">},</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'PullRequest.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Comment.commentableId'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>The <code class="prettyprint">{commentableType: &#39;Type&#39;}</code> filter adds a <code class="prettyprint">WHERE &quot;commentableType&quot; = &#39;Type&#39;</code> clause to the relation fetch
query. It doesn&rsquo;t automatically set the type when you insert a new comment. You have to set the <code class="prettyprint">commentableType</code>
manually:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">someIssue</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'comments'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">text</span><span class="p">:</span> <span class="s1">'blaa'</span><span class="p">,</span> <span class="na">commentableType</span><span class="p">:</span> <span class="s1">'Issue'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(...)</span>
</code></pre>
<p>Creating polymorphic associations isn&rsquo;t as easy as it could be at the moment, but it can be done using
custom filters for relations. Let&rsquo;s assume we have tables <code class="prettyprint">Comment</code>, <code class="prettyprint">Issue</code> and <code class="prettyprint">PullRequest</code>. Both
<code class="prettyprint">Issue</code> and <code class="prettyprint">PullRequest</code> can have a list of comments. <code class="prettyprint">Comment</code> has a column <code class="prettyprint">commentableId</code> to hold
the foreign key and <code class="prettyprint">commentableType</code> to hold the related model type. Check out the first example for
how to create relations for this setup ➔</p>

<h2 id="timestamps">Timestamps</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeInsert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">created_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">$beforeUpdate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">updated_at</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can implement the <code class="prettyprint">$beforeInsert</code> and <code class="prettyprint">$beforeUpdate</code> methods to set the timestamps. If you want to do this for all
your models, you can simply create common base class that implements these methods.</p>

<h2 id="custom-query-builder">Custom query builder</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">QueryBuilder</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">QueryBuilder</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MyQueryBuilder</span> <span class="kr">extends</span> <span class="nx">QueryBuilder</span> <span class="p">{</span>
  <span class="c1">// Some custom method.</span>
  <span class="nx">upsert</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">).</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">QueryBuilder</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">MyQueryBuilder</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Now you can do this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">upsert</span><span class="p">(</span><span class="nx">person</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">});</span>
</code></pre>
<p>You can extend the <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> returned by <a href="#query"><code class="prettyprint">Model.query()</code></a>, <a href="#_s_relatedquery"><code class="prettyprint">modelInstance.$relatedQuery()</code></a>
and <a href="#_s_query"><code class="prettyprint">modelInstance.$query()</code></a> methods by setting the model class&rsquo;s static <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>.</p>

<p>If you want to set the custom query builder for all model classes you can just set the <code class="prettyprint">QueryBuilder</code>
property of the <a href="#model"><code class="prettyprint">Model</code></a> base class. A cleaner option would be to create your own Model subclass, set its <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>
property and inherit all your models from the custom Model class.</p>

<h2 id="multi-tenancy">Multi-tenancy</h2>
<pre class="highlight javascript"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Function that parses the tenant id from path, header, query parameter etc.</span>
  <span class="c1">// and returns an instance of knex. You should cache the knex instances and</span>
  <span class="c1">// not create a new one for each query.</span>
  <span class="kd">var</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">getDatabaseForRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>

  <span class="nx">req</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">Person</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex</span><span class="p">),</span>
    <span class="na">Movie</span><span class="p">:</span> <span class="nx">Movie</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex</span><span class="p">),</span>
    <span class="na">Animal</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex</span><span class="p">)</span>
  <span class="p">};</span>

  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>
</code></pre>
<p>By default, the examples guide you to setup the database connection by setting the knex object of the <a href="#model"><code class="prettyprint">Model</code></a> base
class. This doesn&rsquo;t fly if you want to select the database based on the request as it sets the connection globally.</p>

<p>If you have a different database for each tenant, a useful pattern is to add a middleware that adds the models to
<code class="prettyprint">req.models</code> hash and then <em>always</em> use the models through <code class="prettyprint">req.models</code> instead of requiring them directly. What
<a href="#bindknex"><code class="prettyprint">bindKnex</code></a> method actually does is that it creates an anonymous subclass of the model class and sets its
knex connection. That way the database connection doesn&rsquo;t change for the other requests that are currently being executed.</p>

<h2 id="sql-clause-precedence-and-parentheses">SQL clause precedence and parentheses</h2>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="mi">2</span><span class="p">).</span><span class="nx">orWhere</span><span class="p">(</span><span class="s1">'bar'</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>SQL:</p>
</blockquote>
<pre class="highlight sql"><code><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Person"</span> <span class="k">where</span> <span class="nv">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">and</span> <span class="p">(</span><span class="nv">"foo"</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">or</span> <span class="nv">"bar"</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</code></pre>
<p>You can add parentheses to queries by passing a function to the <a href="#where"><code class="prettyprint">where</code></a> method.</p>

<h2 id="default-values">Default values</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">jsonSchema</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
      <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">gender</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span>
          <span class="na">enum</span><span class="p">:</span> <span class="p">[</span><span class="s1">'Male'</span><span class="p">,</span> <span class="s1">'Female'</span><span class="p">,</span> <span class="s1">'Other'</span><span class="p">],</span>
          <span class="na">default</span><span class="p">:</span> <span class="s1">'Female'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>You can set the default values for properties using the <code class="prettyprint">default</code> property in <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a>.</p>

<h2 id="composite-keys">Composite keys</h2>

<blockquote>
<p>Specifying a composite primary key for a model:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">idColumn</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">,</span> <span class="s1">'dateOfBirth'</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Specifying a relation using a composite primary key and a composite foreign key:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">'Person.firstName'</span><span class="p">,</span>
            <span class="s1">'Person.lastName'</span><span class="p">,</span>
            <span class="s1">'Person.dateOfBirth'</span>
          <span class="p">],</span>
          <span class="na">to</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">'Animal.ownerFirstName'</span><span class="p">,</span>
            <span class="s1">'Animal.ownerLastName'</span><span class="p">,</span>
            <span class="s1">'Animal.ownerDateOfBirth'</span>
          <span class="p">]</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>Compound keys are fully supported. Just give an array of columns where you would normally give a single column name.
Composite primary key can be specified by setting an array of column names to the <a href="#idcolumn"><code class="prettyprint">idColumn</code></a> of a model
class.</p>

<p>Here&rsquo;s a list of methods that may help working with composite keys:</p>

<ul>
<li><a href="#wherecomposite"><code class="prettyprint">whereComposite</code></a></li>
<li><a href="#whereincomposite"><code class="prettyprint">whereInComposite</code></a></li>
<li><a href="#findbyid"><code class="prettyprint">findById</code></a></li>
<li><a href="#deletebyid"><code class="prettyprint">deleteById</code></a></li>
<li><a href="#updateandfetchbyid"><code class="prettyprint">updateAndFetchById</code></a></li>
<li><a href="#patchandfetchbyid"><code class="prettyprint">patchAndFetchById</code></a></li>
<li><a href="#_s_id"><code class="prettyprint">$id</code></a></li>
<li><a href="#_s_values"><code class="prettyprint">$values</code></a></li>
</ul>

<h2 id="indexing-postgresql-jsonb-columns">Indexing PostgreSQL JSONB columns</h2>

<p>Good reading on the subject:</p>

<ul>
<li><a href="https://blog.2ndquadrant.com/jsonb-type-performance-postgresql-9-4/">JSONB type performance in PostgreSQL 9.4</a> and</li>
<li><a href="http://paquier.xyz/postgresql-2/postgres-9-4-feature-highlight-indexing-jsonb/">Postgres 9.4 feature highlight - Indexing JSON data with jsonb data type</a>.</li>
</ul>

<h3 id="general-inverted-indexes-a-k-a-gin">General Inverted Indexes a.k.a. GIN</h3>

<p>This is the index type which makes all JSONB set operations fast. All <code class="prettyprint">isSuperset</code> / <code class="prettyprint">isSubset</code> / <code class="prettyprint">hasKeys</code> / <code class="prettyprint">hasValues</code> etc. queries can use this index to speed ’em up. Usually this is the index you want and it may take around 30% extra space on the DB server.</p>

<p>If one likes to use only the subset/superset operators with faster and smaller index one can give an extra <code class="prettyprint">path_ops</code> parameter when creating the index: <a href="https://wiki.postgresql.org/wiki/What's_new_in_PostgreSQL_9.4">“The path_ops index supports only the search path operator <code class="prettyprint">@&gt;</code> (see below), but produces a smaller and faster index for these kinds of searches.”</a>. According to Marco Nenciarini’s post the speed up can be over 600% compared to full GIN index and the size of the index is reduced from ~30% -&gt; ~20%.</p>

<blockquote>
<p>Full GIN index to speed up all type of json queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'CREATE INDEX on ?? USING GIN (??)'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">])</span>
</code></pre>
<blockquote>
<p>Partial GIN index to speed up all subset / superset type of json queries:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'CREATE INDEX on ?? USING GIN (?? jsonb_path_ops)'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Place'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">])</span>
</code></pre>
<h3 id="index-on-expression">Index on Expression</h3>

<p>Another type of index one may use for JSONB field is to create an expression index for example for a certain JSON field inside a column.</p>

<p>You might want to use these if you are using lots of <code class="prettyprint">.where(ref(&#39;jsonColumn:details.name&#39;).castText(), &#39;marilyn&#39;)</code> type of queries, which cannot be sped up with GIN index.</p>

<p>Use of these indexes are more limited, but they are also somewhat faster than using GIN and querying e.g. <code class="prettyprint">{ field: value }</code> with subset operator. GIN indices also takes a lot of space in compared to expression index for certain field. So if you want to make just certain query to go extra fast you may consider using index on expression.</p>

<blockquote>
<p>An expression index referring an internal <code class="prettyprint">details.name</code> attribute of an object stored in <code class="prettyprint">jsonColumn</code>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"CREATE INDEX on ?? ((??#&gt;&gt;'{details,name}'))"</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'jsonColumn'</span><span class="p">])</span>
</code></pre>
<h3 id="complete-migration-example-and-created-tables-indexes">Complete Migration Example and Created Tables / Indexes</h3>

<p>Complete example how to try out different index choices.</p>

<blockquote>
<p>Migration:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">up</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">knex</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">knex</span><span class="p">.</span><span class="nx">schema</span>
    <span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">jsonb</span><span class="p">(</span><span class="s1">'details'</span><span class="p">);</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">integer</span><span class="p">(</span><span class="s1">'homeId'</span><span class="p">).</span><span class="nx">unsigned</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">references</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">inTable</span><span class="p">(</span><span class="s1">'Place'</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">raw</span><span class="p">(</span>
      <span class="s1">'CREATE INDEX on ?? USING GIN (??)'</span><span class="p">,</span>
      <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="nx">raw</span><span class="p">(</span>
      <span class="s2">"CREATE INDEX on ?? ((??#&gt;&gt;'{type}'))"</span><span class="p">,</span>
      <span class="p">[</span><span class="s1">'Hero'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="p">.</span><span class="nx">createTable</span><span class="p">(</span><span class="s1">'Place'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">increments</span><span class="p">(</span><span class="s1">'id'</span><span class="p">).</span><span class="nx">primary</span><span class="p">();</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">string</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
      <span class="nx">table</span><span class="p">.</span><span class="nx">jsonb</span><span class="p">(</span><span class="s1">'details'</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">raw</span><span class="p">(</span>
      <span class="s1">'CREATE INDEX on ?? USING GIN (?? jsonb_path_ops)'</span><span class="p">,</span>
      <span class="p">[</span><span class="s1">'Place'</span><span class="p">,</span> <span class="s1">'details'</span><span class="p">]</span>
    <span class="p">);</span>
<span class="p">};</span>
</code></pre>
<blockquote>
<p>Results following schema:</p>
</blockquote>
<pre class="highlight sql"><code><span class="n">objection</span><span class="o">-</span><span class="n">jsonb</span><span class="o">-</span><span class="n">example</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="nv">"Hero"</span>
            <span class="k">Table</span> <span class="nv">"public.Hero"</span>
 <span class="k">Column</span>  <span class="o">|</span>          <span class="k">Type</span>
<span class="c1">---------+------------------------</span>
 <span class="n">id</span>      <span class="o">|</span> <span class="n">integer</span>
 <span class="n">name</span>    <span class="o">|</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
 <span class="n">details</span> <span class="o">|</span> <span class="n">jsonb</span>
 <span class="n">homeId</span>  <span class="o">|</span> <span class="n">integer</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="nv">"Hero_pkey"</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="nv">"Hero_details_idx"</span> <span class="n">gin</span> <span class="p">(</span><span class="n">details</span><span class="p">)</span>
    <span class="nv">"Hero_expr_idx"</span> <span class="n">btree</span> <span class="p">((</span><span class="n">details</span> <span class="o">#&gt;&gt;</span> <span class="s1">'{type}'</span><span class="p">::</span><span class="n">text</span><span class="p">[]))</span>

<span class="n">objection</span><span class="o">-</span><span class="n">jsonb</span><span class="o">-</span><span class="n">example</span><span class="o">=#</span> <span class="err">\</span><span class="n">d</span> <span class="nv">"Place"</span>
           <span class="k">Table</span> <span class="nv">"public.Place"</span>
 <span class="k">Column</span>  <span class="o">|</span>          <span class="k">Type</span>
<span class="c1">---------+------------------------</span>
 <span class="n">id</span>      <span class="o">|</span> <span class="n">integer</span>
 <span class="n">name</span>    <span class="o">|</span> <span class="n">character</span> <span class="n">varying</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span>
 <span class="n">details</span> <span class="o">|</span> <span class="n">jsonb</span>
<span class="n">Indexes</span><span class="p">:</span>
    <span class="nv">"Place_pkey"</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span> <span class="n">btree</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
    <span class="nv">"Place_details_idx"</span> <span class="n">gin</span> <span class="p">(</span><span class="n">details</span> <span class="n">jsonb_path_ops</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Expression index is used for example for following query:</p>
</blockquote>
<pre class="highlight sql"><code><span class="k">explain</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="nv">"Hero"</span> <span class="k">where</span> <span class="n">details</span><span class="o">#&gt;&gt;</span><span class="s1">'{type}'</span> <span class="o">=</span> <span class="s1">'Hero'</span><span class="p">;</span>

                           <span class="n">QUERY</span> <span class="n">PLAN</span>
<span class="c1">----------------------------------------------------------------</span>
 <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="nv">"Hero_expr_idx"</span> <span class="k">on</span> <span class="nv">"Hero"</span>
   <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">((</span><span class="n">details</span> <span class="o">#&gt;&gt;</span> <span class="s1">'{type}'</span><span class="p">::</span><span class="n">text</span><span class="p">[])</span> <span class="o">=</span> <span class="s1">'Hero'</span><span class="p">::</span><span class="n">text</span><span class="p">)</span>
</code></pre>
          <h1 id="api-reference">API reference</h1>

<h2 id="querybuilder">QueryBuilder</h2>

<p>Query builder for Models.</p>

<p>This class is a wrapper around <a href="http://knexjs.org#Builder">knex QueryBuilder</a>. QueryBuilder has all the methods a
knex QueryBuilder has and more. While knex QueryBuilder returns plain javascript objects, QueryBuilder returns Model
subclass instances.</p>

<p>QueryBuilder is thenable, meaning that it can be used like a promise. You can
return query builder from a <a href="#then"><code class="prettyprint">then</code></a> method of a promise and it gets chained just like
a normal promise would.</p>

<p>The query is executed when one of its promise methods <a href="#then"><code class="prettyprint">then()</code></a>, <a href="#catch"><code class="prettyprint">catch()</code></a>, <a href="#map"><code class="prettyprint">map()</code></a>,
<a href="#bind"><code class="prettyprint">bind()</code></a> or <a href="#return"><code class="prettyprint">return()</code></a> is called.</p>

<h3 id="static-methods">Static methods</h3>

<h4 id="forclass">forClass</h4>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">QueryBuilder</span><span class="p">.</span><span class="nx">forClass</span><span class="p">(</span><span class="nx">modelClass</span><span class="p">);</span>
</code></pre>
<p>Create QueryBuilder for a Model subclass. You rarely need to call this. Query builders are created using the
<a href="#query"><code class="prettyprint">Model.query()</code></a> and other query methods.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelClass</td>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>A Model class constructor</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>The created query builder</td>
</tr>
</tbody></table>

<h3 id="global-query-building-helpers">Global query building helpers</h3>

<h4 id="ref">ref</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">ref</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">ref</span><span class="p">;</span>
</code></pre>
<p>Factory function that returns a <code class="prettyprint">ReferenceBuilder</code> instance, that makes it easier to refer
to tables, columns, json attributes and add casting to referred columns wihtout need to use
raw queries.</p>

<p>See <a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a> for more information about how to refer to
json fields.</p>
<pre class="highlight javascript"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">ref</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'objection'</span><span class="p">;</span>

<span class="nx">Model</span><span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">([</span>
    <span class="s1">'id'</span><span class="p">,</span>
    <span class="nx">ref</span><span class="p">(</span><span class="s1">'Model.jsonColumn:details.name'</span><span class="p">).</span><span class="nx">castText</span><span class="p">().</span><span class="nx">as</span><span class="p">(</span><span class="s1">'name'</span><span class="p">),</span>
    <span class="nx">ref</span><span class="p">(</span><span class="s1">'Model.jsonColumn:details.age'</span><span class="p">).</span><span class="nx">castInt</span><span class="p">().</span><span class="nx">as</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span>
  <span class="p">])</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'OtherModel'</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'Model.jsonColumn:details.name'</span><span class="p">).</span><span class="nx">castText</span><span class="p">(),</span> <span class="s1">'='</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'OtherModel.name'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'OtherModel.ageLimit'</span><span class="p">));</span>
</code></pre>
<h4 id="referencebuilder-methods">ReferenceBuilder methods</h4>

<h5 id="casttext">castText()</h5>

<p>Cast reference to sql type <code class="prettyprint">text</code>.</p>

<h5 id="castint">castInt()</h5>

<p>Cast reference to sql type <code class="prettyprint">integer</code>.</p>

<h5 id="castbigint">castBigInt()</h5>

<p>Cast reference to sql type <code class="prettyprint">bigint</code>.</p>

<h5 id="castfloat">castFloat()</h5>

<p>Cast reference to sql type <code class="prettyprint">float</code>.</p>

<h5 id="castdecimal">castDecimal()</h5>

<p>Cast reference to sql type <code class="prettyprint">decimal</code>.</p>

<h5 id="castreal">castReal()</h5>

<p>Cast reference to sql type <code class="prettyprint">real</code>.</p>

<h5 id="castbool">castBool()</h5>

<p>Cast reference to sql type <code class="prettyprint">boolean</code>.</p>

<h5 id="casttype-sqltype">castType(sqlType)</h5>

<p>Give custom casting type to which referenced value is casted to.</p>

<p><code class="prettyprint">.castType(&#39;mytype&#39;) =&gt; CAST(?? as mytype)</code></p>

<h5 id="castjson">castJson()</h5>

<p>In addition to other casts wrap reference to_jsonb() function so that final value
reference will be json type.</p>

<h5 id="as-as">as(as)</h5>

<p>As format to tell which name will be used for reference for example in <code class="prettyprint">.select(ref(&#39;age&#39;).as(&#39;yougness&#39;))</code></p>

<h4 id="lit-not-implemented-yet">lit() (Not implemented yet)</h4>

<p>The same as <code class="prettyprint">ref()</code> but allows one to tell in which format certain javascript literal
should be passed to database engine.</p>

<h4 id="raw">raw</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="p">{</span> <span class="nx">raw</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">);</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'coalesce(sum(??), 0) as ??'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'childAgeSum'</span><span class="p">]))</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s2">`?? || ' ' || ??`</span><span class="p">,</span> <span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">),</span> <span class="s1">'Arnold Schwarzenegger'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="nx">raw</span><span class="p">(</span><span class="s1">'random()'</span><span class="p">))</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">childAgeSums</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">childAgeSums</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">childAgeSum</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Wrapper for knex raw query that doens&rsquo;t depend on knex. Instances returned by
<code class="prettyprint">raw</code> are converted to knex raw instances when the query is executed.</p>

<h3 id="query-building-methods">Query building methods</h3>

<h4 id="findbyid">findById</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">findById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">findById</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Composite key:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">findById</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'10'</span><span class="p">]);</span>
</code></pre>
<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>any&#124; Array.&lt;any&gt;</td>
<td></td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="insert">insert</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">modelsOrObjects</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Batch insert (Only works on Postgres):</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">someMovie</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'actors'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">([</span>
    <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">},</span>
    <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Bradley'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Cooper'</span><span class="p">}</span>
  <span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">actors</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">actors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">firstName</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">actors</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions and subqueries as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">),</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Fields marked as <code class="prettyprint">extras</code> for many-to-many relations in <a href="#relationmappings"><code class="prettyprint">relationMappings</code></a> are automatically
written to the join table instead of the target table. The <code class="prettyprint">someExtra</code> field in the following example is written
to the join table if the <code class="prettyprint">extra</code> array of the relation mapping contains the string <code class="prettyprint">&#39;someExtra&#39;</code>.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">someMovie</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'actors'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>
    <span class="na">someExtra</span><span class="p">:</span> <span class="s2">"I'll be written to the join table"</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">someExtra</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Creates an insert query.</p>

<p>The inserted objects are validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a>. If validation fails
the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>NOTE: The return value of the insert query <em>only</em> contains the properties given to the insert
method plus the identifier. This is because we don&rsquo;t make an additional fetch query after
the insert. Using postgres you can chain <a href="#returning"><code class="prettyprint">returning(&#39;*&#39;)</code></a> to the query to get all
properties - see <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for some examples. On other databases you
can use the <a href="#insertandfetch"><code class="prettyprint">insertAndFetch</code></a> method.</p>

<p>The batch insert only works on Postgres because Postgres is the only database engine
that returns the identifiers of <em>all</em> inserted rows. knex supports batch inserts on
other databases also, but you only get the id of the first (or last) inserted object
as a result. If you need batch insert on other databases you can use knex directly
through <a href="#knexquery"><code class="prettyprint">YourModel.knexQuery()</code></a>.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelsOrObjects</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a>&#124;Array.&lt;Object&gt;&#124;Array.&lt;<a href="#model"><code class="prettyprint">Model</code></a>&gt;</td>
<td>Objects to insert</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="insertandfetch">insertAndFetch</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">insertAndFetch</span><span class="p">(</span><span class="nx">modelsOrObjects</span><span class="p">);</span>
</code></pre>
<p>Just like <a href="#insert"><code class="prettyprint">insert</code></a> but also fetches the model afterwards.</p>

<p>Note that on postgresql you can just chain <a href="#returning"><code class="prettyprint">returning(&#39;*&#39;)</code></a> to the normal insert method
to get the same result without an additional query. See <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for some examples.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelsOrObjects</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a>&#124;Array.&lt;Object&gt;&#124;Array.&lt;<a href="#model"><code class="prettyprint">Model</code></a>&gt;</td>
<td>Objects to insert</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="insertgraph">insertGraph</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">insertGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>You can insert any asyclic graph of models like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sylvester'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Stallone'</span><span class="p">,</span>

    <span class="na">children</span><span class="p">:</span> <span class="p">[{</span>
      <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sage'</span><span class="p">,</span>
      <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Stallone'</span><span class="p">,</span>

      <span class="na">pets</span><span class="p">:</span> <span class="p">[{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy'</span><span class="p">,</span>
        <span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span>
      <span class="p">}]</span>
    <span class="p">}]</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>The query above will insert &lsquo;Sylvester&rsquo;, &#39;Sage&rsquo; and &#39;Fluffy&rsquo; into db and create
relationships between them as defined in the <code class="prettyprint">relationMappings</code> of the models.</p>

<p>If you need to refer to the same model in multiple places you can use the
special properties <code class="prettyprint">#id</code> and <code class="prettyprint">#ref</code> like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">([{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">[{</span>
      <span class="s2">"#id"</span><span class="p">:</span> <span class="s1">'Silver Linings Playbook'</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'Silver Linings Playbook'</span><span class="p">,</span>
      <span class="na">duration</span><span class="p">:</span> <span class="mi">122</span>
    <span class="p">}]</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Bradley'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Cooper'</span><span class="p">,</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">[{</span>
      <span class="s2">"#ref"</span><span class="p">:</span> <span class="s1">'Silver Linings Playbook'</span>
    <span class="p">}]</span>
  <span class="p">}]);</span>
</code></pre>
<blockquote>
<p>The query above will insert only one movie (the &#39;Silver Linings Playbook&rsquo;) but
both &#39;Jennifer&rsquo; and &#39;Bradley&rsquo; will have the movie related to them through the
many-to-many relation <code class="prettyprint">movies</code>.</p>

<p>If you need to refer to a model already in the database from a many-to-many relation
you can use special properties <code class="prettyprint">#dbRef</code> like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">([{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">[{</span>
      <span class="s2">"#id"</span><span class="p">:</span> <span class="s1">'Silver Linings Playbook'</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'Silver Linings Playbook'</span><span class="p">,</span>
      <span class="na">duration</span><span class="p">:</span> <span class="mi">122</span>
    <span class="p">}]</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Bradley'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Cooper'</span><span class="p">,</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">[{</span>
      <span class="s2">"#dbRef"</span><span class="p">:</span> <span class="mi">1536</span>
    <span class="p">},</span> <span class="p">{</span>
      <span class="s2">"#dbRef"</span><span class="p">:</span> <span class="mi">6527</span>
    <span class="p">}]</span>
  <span class="p">}]);</span>
</code></pre>
<blockquote>
<p>You can refer to the properties of other models in the graph using expressions
of format <code class="prettyprint">#ref{&lt;id&gt;.&lt;property&gt;}</code> for example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">([{</span>
    <span class="s2">"#id"</span><span class="p">:</span> <span class="s1">'jenniLaw'</span><span class="p">,</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>

    <span class="na">pets</span><span class="p">:</span> <span class="p">[{</span>
      <span class="na">name</span><span class="p">:</span> <span class="s2">"I am the dog of #ref{jenniLaw.firstName} #ref{jenniLaw.lastName}"</span><span class="p">,</span>
      <span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span>
    <span class="p">}]</span>
  <span class="p">}]);</span>
</code></pre>
<blockquote>
<p>The query above will insert a pet named <code class="prettyprint">I am the dog of Jennifer Lawrence</code> for Jennifer.</p>
</blockquote>

<p>Insert models with relations. This method is best explained with examples ➔</p>

<p>See the <a href="#allowinsert"><code class="prettyprint">allowInsert</code></a> method if you need to limit which relations can be inserted using
this method to avoid security issues.</p>

<p>By the way, if you are using Postgres the inserts are done in batches for maximum performance.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>graph</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a>&#124;Array.&lt;Object&gt;&#124;Array.&lt;<a href="#model"><code class="prettyprint">Model</code></a>&gt;</td>
<td>Objects to insert</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="insertgraphandfetch">insertGraphAndFetch</h4>

<p>Exactly like <a href="#insertgraph">insertGraph</a> but also fetches the graph from the db after insert.</p>

<h4 id="insertwithrelated">insertWithRelated</h4>

<p>Alias for <a href="#insertgraph">insertGraph</a>.</p>

<h4 id="insertwithrelatedandfetch">insertWithRelatedAndFetch</h4>

<p>Alias for <a href="#insertgraphandfetch">insertGraphAndFetch</a>.</p>

<h4 id="update">update</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">modelOrObject</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">134</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numberOfAffectedRows</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">numberOfAffectedRows</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions, subqueries and <code class="prettyprint">ref()</code> as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">),</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">),</span>
    <span class="na">oldLastName</span><span class="p">:</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'lastName'</span><span class="p">)</span> <span class="c1">// same as knex.raw('??', ['lastName'])</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Updating single value inside json column and referring attributes inside json columns (only with postgres) etc.:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">({</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'someJsonColumn:mother.lastName'</span><span class="p">).</span><span class="nx">castText</span><span class="p">(),</span>
    <span class="s1">'detailsJsonColumn:address.street'</span><span class="p">:</span> <span class="s1">'Elm street'</span>
  <span class="p">});</span>
</code></pre>
<p>Creates an update query.</p>

<p>The update object is validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a>. If validation fails
the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>This method is meant for updating <em>whole</em> objects with all required properties. If you
want to update a subset of properties use the <a href="#patch"><code class="prettyprint">patch</code></a> method.</p>

<p>NOTE: The return value of the query will be the number of affected rows. If you want to update a single row and
retrieve the updated row as a result, you may want to use the <a href="#updateandfetchbyid"><code class="prettyprint">updateAndFetchById</code></a> method
or <em>take a look at <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> if you&rsquo;re using Postgres</em>.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelOrObject</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The update object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="updateandfetchbyid">updateAndFetchById</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">updateAndFetchById</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">modelOrObject</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">updateAndFetchById</span><span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedModel</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">updatedModel</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions and subqueries as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">updateAndFetchById</span><span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">),</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre>
<p>Updates a single model by id and fetches it from the database afterwards.</p>

<p>The update object is validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a>. If validation fails
the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>This method is meant for updating <em>whole</em> objects with all required properties. If you
want to update a subset of properties use the <a href="#patchandfetchbyid"><code class="prettyprint">patchAndFetchById</code></a> method.</p>

<p>NOTE: On postgresql you can just chain <a href="#first"><code class="prettyprint">first()</code></a> and <a href="#returning"><code class="prettyprint">returning(&#39;*&#39;)</code></a> to the normal <a href="#update"><code class="prettyprint">update</code></a> method
to get the same result without an additional query. See <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for some examples.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>string&#124;number</td>
<td>Identifier of the model to update</td>
</tr>
<tr>
<td>modelOrObject</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The update object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="updateandfetch">updateAndFetch</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">updateAndFetch</span><span class="p">(</span><span class="nx">modelOrObject</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">person</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">updateAndFetch</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedModel</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">updatedModel</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions and subqueries as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">updateAndFetch</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">),</span>
    <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre>
<p>Updates a single model and fetches it from the database afterwards. This only works with instance queries
started with <a href="#_s_query"><code class="prettyprint">$query()</code></a> method.</p>

<p>The update object is validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a>. If validation fails
the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>This method is meant for updating <em>whole</em> objects with all required properties. If you
want to update a subset of properties use the <a href="#patchandfetch"><code class="prettyprint">patchAndFetch</code></a> method.</p>

<p>NOTE: On postgresql you can just chain <a href="#first"><code class="prettyprint">first()</code></a> and <a href="#returning"><code class="prettyprint">returning(&#39;*&#39;)</code></a> to the normal <a href="#update"><code class="prettyprint">update</code></a> method
to get the same result without an additional query. See <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for some examples.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelOrObject</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The update object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="patch">patch</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="nx">modelOrObject</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">134</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numberOfAffectedRows</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">numberOfAffectedRows</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions, subqueries and <code class="prettyprint">ref()</code> as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">),</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">),</span>
    <span class="na">oldLastName</span><span class="p">:</span> <span class="nx">ref</span><span class="p">(</span><span class="s1">'lastName'</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre>
<p>Creates a patch query.</p>

<p>The patch object is validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> <em>but</em> the <code class="prettyprint">required</code> property
of the <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> is ignored. This way the properties in the patch object are still validated
but an error isn&rsquo;t thrown if the patch object doesn&rsquo;t contain all required properties.</p>

<p>If validation fails the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>NOTE: The return value of the query will be the number of affected rows. If you want to patch a single row and
retrieve the patched row as a result, you may want to use the <a href="#patchandfetchbyid"><code class="prettyprint">patchAndFetchById</code></a> method
or <em>take a look at <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> if you&rsquo;re using Postgres</em>.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelOrObject</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The patch object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="patchandfetchbyid">patchAndFetchById</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">patchAndFetchById</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">modelOrObject</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patchAndFetchById</span><span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="p">{</span><span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedModel</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">updatedModel</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions and subqueries as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patchAndFetchById</span><span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">),</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre>
<p>Patches a single model by id and fetches it from the database afterwards.</p>

<p>The patch object is validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> <em>but</em> the <code class="prettyprint">required</code> property
of the <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> is ignored. This way the properties in the patch object are still validated
but an error isn&rsquo;t thrown if the patch object doesn&rsquo;t contain all required properties.</p>

<p>If validation fails the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>NOTE: On postgresql you can just chain <a href="#first"><code class="prettyprint">first()</code></a> and <a href="#returning"><code class="prettyprint">returning(&#39;*&#39;)</code></a> to the normal <a href="#patch"><code class="prettyprint">patch</code></a> method
to get the same result without an additional query. See <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for some examples.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>string&#124;number</td>
<td>Identifier of the model to update</td>
</tr>
<tr>
<td>modelOrObject</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The patch object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="patchandfetch">patchAndFetch</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">patchAndFetch</span><span class="p">(</span><span class="nx">modelOrObject</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">person</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patchAndFetch</span><span class="p">({</span><span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedModel</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">updatedModel</span><span class="p">.</span><span class="nx">firstName</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>You can also give raw expressions and subqueries as values like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patchAndFetch</span><span class="p">({</span>
    <span class="na">age</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">avg</span><span class="p">(</span><span class="s1">'age'</span><span class="p">),</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">raw</span><span class="p">(</span><span class="s2">"'Jenni' || 'fer'"</span><span class="p">)</span>
  <span class="p">});</span>
</code></pre>
<p>Patches a single model and fetches it from the database afterwards. This only works with instance queries
started with <a href="#_s_query"><code class="prettyprint">$query()</code></a> method.</p>

<p>The patch object is validated against the model&rsquo;s <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> <em>but</em> the <code class="prettyprint">required</code> property
of the <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> is ignored. This way the properties in the patch object are still validated
but an error isn&rsquo;t thrown if the patch object doesn&rsquo;t contain all required properties.</p>

<p>If validation fails the Promise is rejected with a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a>.</p>

<p>NOTE: On postgresql you can just chain <a href="#first"><code class="prettyprint">first()</code></a> and <a href="#returning"><code class="prettyprint">returning(&#39;*&#39;)</code></a> to the normal <a href="#patch"><code class="prettyprint">patch</code></a> method
to get the same result without an additional query. See <a href="#postgresql-quot-returning-quot-tricks">this recipe</a> for some examples.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelOrObject</td>
<td>Object&#124;<a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The patch object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="delete">delete</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="k">delete</span><span class="p">();</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numberOfDeletedRows</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed'</span><span class="p">,</span> <span class="nx">numberOfDeletedRows</span><span class="p">,</span> <span class="s1">'people'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Creates a delete query.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="deletebyid">deleteById</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">deleteById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">deleteById</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numberOfDeletedRows</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed'</span><span class="p">,</span> <span class="nx">numberOfDeletedRows</span><span class="p">,</span> <span class="s1">'people'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Composite key:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">deleteById</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="s1">'20'</span><span class="p">,</span> <span class="mi">46</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numberOfDeletedRows</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'removed'</span><span class="p">,</span> <span class="nx">numberOfDeletedRows</span><span class="p">,</span> <span class="s1">'people'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Deletes a model by id.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>id</td>
<td>any&#124;Array.&lt;any&gt;</td>
<td></td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="relate">relate</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">relate</span><span class="p">(</span><span class="nx">ids</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">person</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">person</span><span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">).</span><span class="nx">relate</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'movie 50 is now related to person 123 through `movies` relation'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Relate multiple (only works with postgres)</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">relate</span><span class="p">([</span><span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Composite key</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">relate</span><span class="p">({</span><span class="na">foo</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span> <span class="na">bar</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span> <span class="na">baz</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Fields marked as <code class="prettyprint">extras</code> for many-to-many relations in <a href="#relationmappings"><code class="prettyprint">relationMappings</code></a> are automatically
written to the join table. The <code class="prettyprint">someExtra</code> field in the following example is written to the join table if the
<code class="prettyprint">extra</code> array of the relation mapping contains the string <code class="prettyprint">&#39;someExtra&#39;</code>.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">someMovie</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'actors'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">relate</span><span class="p">({</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="na">someExtra</span><span class="p">:</span> <span class="s2">"I'll be written to the join table"</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="p">});</span>
</code></pre>
<p>Relates an existing model to another model.</p>

<p>This method doesn&rsquo;t create a new instance but only updates the foreign keys and in
the case of many-to-many relation, creates a join row to the join table.</p>

<p>On Postgres multiple models can be related by giving an array of identifiers.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>ids</td>
<td>number&#124;string&#124;Array&#124;Object</td>
<td>Identifier(s) of the model(s) to relate</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="unrelate">unrelate</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">unrelate</span><span class="p">();</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">person</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">person</span><span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">).</span><span class="nx">unrelate</span><span class="p">().</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'movie 50 is no longer related to person 123 through `movies` relation'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Removes a connection between two models.</p>

<p>Doesn&rsquo;t delete the models. Only removes the connection. For ManyToMany relations this
deletes the join column from the join table. For other relation types this sets the
join columns to null.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="alias">alias</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="nx">alias</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">alias</span><span class="p">(</span><span class="s1">'p'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'p.id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">'Person as parent'</span><span class="p">,</span> <span class="s1">'parent.id'</span><span class="p">,</span> <span class="s1">'p.parentId'</span><span class="p">)</span>
</code></pre>
<p>Give an alias for the table to be used in the query.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>alias</td>
<td>string</td>
<td>Table alias for the query.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="increment">increment</h4>

<p>See <a href="http://knexjs.org/#Builder-increment">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="decrement">decrement</h4>

<p>See <a href="http://knexjs.org/#Builder-decrement">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="select">select</h4>

<p>See <a href="http://knexjs.org/#Builder-select">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="forupdate">forUpdate</h4>

<p>See <a href="http://knexjs.org/#Builder-forUpdate">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="forshare">forShare</h4>

<p>See <a href="http://knexjs.org/#Builder-forShare">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="as">as</h4>

<p>See <a href="http://knexjs.org/#Builder-as">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="columns">columns</h4>

<p>See <a href="http://knexjs.org/#Builder-columns">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="column">column</h4>

<p>See <a href="http://knexjs.org/#Builder-column">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="from">from</h4>

<p>See <a href="http://knexjs.org/#Builder-from">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="fromjs">fromJS</h4>

<p>See <a href="http://knexjs.org/#Builder-fromJS">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="into">into</h4>

<p>See <a href="http://knexjs.org/#Builder-into">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="withschema">withSchema</h4>

<p>See <a href="http://knexjs.org/#Builder-withSchema">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="table">table</h4>

<p>See <a href="http://knexjs.org/#Builder-table">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="distinct">distinct</h4>

<p>See <a href="http://knexjs.org/#Builder-distinct">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="join">join</h4>

<p>See <a href="http://knexjs.org/#Builder-join">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="joinraw">joinRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-joinRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="innerjoin">innerJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-innerJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="leftjoin">leftJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-leftJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="leftouterjoin">leftOuterJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-leftOuterJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="rightjoin">rightJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-rightJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="rightouterjoin">rightOuterJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-rightOuterJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="outerjoin">outerJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-outerJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="fullouterjoin">fullOuterJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-fullOuterJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="crossjoin">crossJoin</h4>

<p>See <a href="http://knexjs.org/#Builder-crossJoin">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="joinrelation">joinRelation</h4>

<p>Joins a set of relations described by <code class="prettyprint">relationExpression</code>. See the examples for more info.</p>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="nx">relationExpression</span><span class="p">,</span> <span class="nx">opt</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Join one relation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'pets.species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Give an alias for a single relation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">,</span> <span class="p">{</span><span class="na">alias</span><span class="p">:</span> <span class="s1">'p'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'p.species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Join two relations:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'[pets, parent]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'pets.species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'parent.name'</span><span class="p">,</span> <span class="s1">'Arnold'</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Join two multiple and nested relations. Note that when referring to nested relations
<code class="prettyprint">:</code> must be used as a separator instead of <code class="prettyprint">.</code>. This limitation comes from the way
knex parses table references.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'Person.id'</span><span class="p">,</span> <span class="s1">'parent:parent.name as grandParentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'[pets, parent.[pets, parent]]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'parent:pets.species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Give aliases for a bunch of relations:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'Person.id'</span><span class="p">,</span> <span class="s1">'pr:pr.name as grandParentName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">joinRelation</span><span class="p">(</span><span class="s1">'[pets, parent.[pets, parent]]'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">aliases</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">parent</span><span class="p">:</span> <span class="s1">'pr'</span><span class="p">,</span>
      <span class="na">pets</span><span class="p">:</span> <span class="s1">'pt'</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'pr:pt.species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
</code></pre>
<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relationExpression</td>
<td><a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>An expression describing which relations to join.</td>
</tr>
<tr>
<td>opt</td>
<td>object</td>
<td>Optional options. See the examples.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="innerjoinrelation">innerJoinRelation</h4>

<p>Alias for <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a>.</p>

<h4 id="outerjoinrelation">outerJoinRelation</h4>

<p>Outer join version of the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method.</p>

<h4 id="leftjoinrelation">leftJoinRelation</h4>

<p>Left join version of the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method.</p>

<h4 id="leftouterjoinrelation">leftOuterJoinRelation</h4>

<p>Left outer join version of the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method.</p>

<h4 id="rightjoinrelation">rightJoinRelation</h4>

<p>Right join version of the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method.</p>

<h4 id="rightouterjoinrelation">rightOuterJoinRelation</h4>

<p>Left outer join version of the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method.</p>

<h4 id="fullouterjoinrelation">fullOuterJoinRelation</h4>

<p>Full outer join version of the <a href="#joinrelation"><code class="prettyprint">joinRelation</code></a> method.</p>

<h4 id="where">where</h4>

<p>See <a href="http://knexjs.org/#Builder-where">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="andwhere">andWhere</h4>

<p>See <a href="http://knexjs.org/#Builder-where">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwhere">orWhere</h4>

<p>See <a href="http://knexjs.org/#Builder-where">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherenot">whereNot</h4>

<p>See <a href="http://knexjs.org/#Builder-where">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherenot">orWhereNot</h4>

<p>See <a href="http://knexjs.org/#Builder-where">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="whereraw">whereRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-whereRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherewrapped">whereWrapped</h4>

<p>See <a href="http://knexjs.org/#Builder-wheres">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="havingwrapped">havingWrapped</h4>

<p>See <a href="http://knexjs.org/#Builder-having">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwhereraw">orWhereRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-whereRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="whereexists">whereExists</h4>

<p>See <a href="http://knexjs.org/#Builder-whereExists">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwhereexists">orWhereExists</h4>

<p>See <a href="http://knexjs.org/#Builder-whereExists">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherenotexists">whereNotExists</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotExists">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherenotexists">orWhereNotExists</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotExists">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherein">whereIn</h4>

<p>See <a href="http://knexjs.org/#Builder-whereIn">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherein">orWhereIn</h4>

<p>See <a href="http://knexjs.org/#Builder-whereIn">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherenotin">whereNotIn</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotIn">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherenotin">orWhereNotIn</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotIn">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherenull">whereNull</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNull">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherenull">orWhereNull</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNull">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherenotnull">whereNotNull</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotNull">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherenotnull">orWhereNotNull</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotNull">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherebetween">whereBetween</h4>

<p>See <a href="http://knexjs.org/#Builder-whereBetween">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherenotbetween">whereNotBetween</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotBetween">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherebetween">orWhereBetween</h4>

<p>See <a href="http://knexjs.org/#Builder-whereBetween">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherenotbetween">orWhereNotBetween</h4>

<p>See <a href="http://knexjs.org/#Builder-whereNotBetween">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="groupby">groupBy</h4>

<p>See <a href="http://knexjs.org/#Builder-groupBy">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="groupbyraw">groupByRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-groupByRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orderby">orderBy</h4>

<p>See <a href="http://knexjs.org/#Builder-orderBy">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orderbyraw">orderByRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-orderByRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="union">union</h4>

<p>See <a href="http://knexjs.org/#Builder-union">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="unionall">unionAll</h4>

<p>See <a href="http://knexjs.org/#Builder-unionAll">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="having">having</h4>

<p>See <a href="http://knexjs.org/#Builder-having">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="havingraw">havingRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-havingRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orhaving">orHaving</h4>

<p>See <a href="http://knexjs.org/#Builder-having">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orhavingraw">orHavingRaw</h4>

<p>See <a href="http://knexjs.org/#Builder-havingRaw">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="offset">offset</h4>

<p>See <a href="http://knexjs.org/#Builder-offset">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="limit">limit</h4>

<p>See <a href="http://knexjs.org/#Builder-limit">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="count">count</h4>

<p>See <a href="http://knexjs.org/#Builder-count">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="countdistinct">countDistinct</h4>

<p>See <a href="http://knexjs.org/#Builder-count">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="min">min</h4>

<p>See <a href="http://knexjs.org/#Builder-min">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="max">max</h4>

<p>See <a href="http://knexjs.org/#Builder-max">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="sum">sum</h4>

<p>See <a href="http://knexjs.org/#Builder-sum">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="avg">avg</h4>

<p>See <a href="http://knexjs.org/#Builder-avg">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="avgdistinct">avgDistinct</h4>

<p>See <a href="http://knexjs.org/#Builder-avg">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="debug">debug</h4>

<p>See <a href="http://knexjs.org/#Builder-debug">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="returning">returning</h4>

<p>See <a href="http://knexjs.org/#Builder-returning">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="truncate">truncate</h4>

<p>See <a href="http://knexjs.org/#Builder-truncate">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="connection">connection</h4>

<p>See <a href="http://knexjs.org/#Builder-connection">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="modify">modify</h4>

<p>See <a href="http://knexjs.org/#Builder-modify">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="columninfo">columnInfo</h4>

<p>See <a href="http://knexjs.org/#Builder-columnInfo">knex documentation</a></p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="whereref">whereRef</h4>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereRef</span><span class="p">(</span><span class="nx">leftRef</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">rightRef</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereRef</span><span class="p">(</span><span class="s1">'Person.id'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'Animal.ownerId'</span><span class="p">);</span>
</code></pre>
<p>Compares a column reference to another</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwhereref">orWhereRef</h4>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">orWhereRef</span><span class="p">(</span><span class="nx">leftRef</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">rightRef</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">orWhereRef</span><span class="p">(</span><span class="s1">'Person.id'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'Animal.ownerId'</span><span class="p">);</span>
</code></pre>
<p>Compares a column reference to another</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherecomposite">whereComposite</h4>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereComposite</span><span class="p">(</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereComposite</span><span class="p">([</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">],</span> <span class="s1">'='</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">'Jennifer'</span><span class="p">]);</span>
</code></pre>
<blockquote>
<p>This method also works with a single column - value pair:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereComposite</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre>
<p><a href="#where"><code class="prettyprint">where</code></a> for (possibly) composite keys.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="whereincomposite">whereInComposite</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereInComposite</span><span class="p">(</span><span class="nx">columns</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereInComposite</span><span class="p">([</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereInComposite</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]]);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereInComposite</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereInComposite</span><span class="p">([</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">],</span> <span class="nx">SomeModel</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">select</span><span class="p">(</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">));</span>
</code></pre>
<p><a href="#wherein"><code class="prettyprint">whereIn</code></a> for (possibly) composite keys.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="wherejsonequals">whereJsonEquals</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonEquals</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">,</span> <span class="nx">jsonObjectOrFieldExpression</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">whereJsonEquals</span><span class="p">(</span><span class="s1">'additionalData:myDogs'</span><span class="p">,</span> <span class="s1">'additionalData:dogsAtHome'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// oh joy! these people have all their dogs at home!</span>
  <span class="p">});</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">whereJsonEquals</span><span class="p">(</span><span class="s1">'additionalData:myDogs[0]'</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"peter"</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// these people's first dog name is "peter" and the dog has no other</span>
    <span class="c1">// attributes, but its name</span>
  <span class="p">});</span>
</code></pre>
<p>Where jsonb field reference equals jsonb object or other field reference.</p>

<p>Also supports having field expression in both sides of equality.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>Reference to column / json field</td>
</tr>
<tr>
<td>jsonObjectOrFieldExpression</td>
<td>Object&#124;Array&#124;<a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>Reference to column / json field or json object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonequals">orWhereJsonEquals</h4>

<p>See <a href="#wherejsonequals"><code class="prettyprint">whereJsonEquals</code></a></p>

<h4 id="wherejsonnotequals">whereJsonNotEquals</h4>

<p>See <a href="#wherejsonequals"><code class="prettyprint">whereJsonEquals</code></a></p>

<h4 id="orwherejsonnotequals">orWhereJsonNotEquals</h4>

<p>See <a href="#wherejsonequals"><code class="prettyprint">whereJsonEquals</code></a></p>

<h4 id="wherejsonsupersetof">whereJsonSupersetOf</h4>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonSupersetOf</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">,</span> <span class="nx">jsonObjectOrFieldExpression</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">whereJsonSupersetOf</span><span class="p">(</span><span class="s1">'additionalData:myDogs'</span><span class="p">,</span> <span class="s1">'additionalData:dogsAtHome'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// These people have all or some of their dogs at home. Person might have some</span>
    <span class="c1">// additional dogs in their custody since myDogs is supreset of dogsAtHome.</span>
  <span class="p">});</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">whereJsonSupersetOf</span><span class="p">(</span><span class="s1">'additionalData:myDogs[0]'</span><span class="p">,</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="s2">"peter"</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// These people's first dog name is "peter", but the dog might have</span>
    <span class="c1">// additional attributes as well.</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Object and array are always their own supersets.</p>

<p>For arrays this means that left side matches if it has all the elements
listed in the right hand side. e.g.</p>
</blockquote>
<pre class="highlight plaintext"><code>[1,2,3] isSuperSetOf [2] =&gt; true
[1,2,3] isSuperSetOf [2,1,3] =&gt; true
[1,2,3] isSuperSetOf [2,null] =&gt; false
[1,2,3] isSuperSetOf [] =&gt; true
</code></pre>
<blockquote>
<p>The <code class="prettyprint">not</code> variants with jsonb operators behave in a way that they won&rsquo;t match rows, which don&rsquo;t have
the referred json key referred in field expression. e.g. for table</p>
</blockquote>
<pre class="highlight plaintext"><code> id |    jsonObject
----+--------------------------
  1 | {}
  2 | NULL
  3 | {"a": 1}
  4 | {"a": 1, "b": 2}
  5 | {"a": ['3'], "b": ['3']}
</code></pre>
<blockquote>
<p>query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">builder</span><span class="p">.</span><span class="nx">whereJsonNotEquals</span><span class="p">(</span><span class="s2">"jsonObject:a"</span><span class="p">,</span> <span class="s2">"jsonObject:b"</span><span class="p">)</span>
</code></pre>
<blockquote>
<p>Returns only the row <code class="prettyprint">4</code> which has keys <code class="prettyprint">a</code> and <code class="prettyprint">b</code> and <code class="prettyprint">a</code> != <code class="prettyprint">b</code>, but it won&rsquo;t return any rows which
does not have <code class="prettyprint">jsonObject.a</code> or <code class="prettyprint">jsonObject.b</code>.</p>
</blockquote>

<p>Where left hand json field reference is a superset of the right hand json value or reference.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>Reference to column / json field, which is tested for being a superset</td>
</tr>
<tr>
<td>jsonObjectOrFieldExpression</td>
<td>Object&#124;Array&#124;<a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>To which to compare</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonsupersetof">orWhereJsonSupersetOf</h4>

<p>See <a href="#wherejsonsupersetof"><code class="prettyprint">whereJsonSupersetOf</code></a></p>

<h4 id="wherejsonnotsupersetof">whereJsonNotSupersetOf</h4>

<p>See <a href="#wherejsonsupersetof"><code class="prettyprint">whereJsonSupersetOf</code></a></p>

<h4 id="orwherejsonnotsupersetof">orWhereJsonNotSupersetOf</h4>

<p>See <a href="#wherejsonsupersetof"><code class="prettyprint">whereJsonSupersetOf</code></a></p>

<h4 id="wherejsonsubsetof">whereJsonSubsetOf</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonSubsetOf</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">,</span> <span class="nx">jsonObjectOrFieldExpression</span><span class="p">);</span>
</code></pre>
<p>Where left hand json field reference is a subset of the right hand json value or reference.</p>

<p>Object and array are always their own subsets.</p>

<p>See <a href="#wherejsonsupersetof"><code class="prettyprint">whereJsonSupersetOf</code></a></p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>Reference to column / json field, which is tested for being a superset</td>
</tr>
<tr>
<td>jsonObjectOrFieldExpression</td>
<td>Object&#124;Array&#124;<a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>To which to compare</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonsubsetof">orWhereJsonSubsetOf</h4>

<p>See <a href="#wherejsonsubsetof"><code class="prettyprint">whereJsonSubsetOf</code></a></p>

<h4 id="wherejsonnotsubsetof">whereJsonNotSubsetOf</h4>

<p>See <a href="#wherejsonsubsetof"><code class="prettyprint">whereJsonSubsetOf</code></a></p>

<h4 id="orwherejsonnotsubsetof">orWhereJsonNotSubsetOf</h4>

<p>See <a href="#wherejsonsubsetof"><code class="prettyprint">whereJsonSubsetOf</code></a></p>

<h4 id="wherejsonisarray">whereJsonIsArray</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonIsArray</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">);</span>
</code></pre>
<p>Where json field reference is an array.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td></td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonisarray">orWhereJsonIsArray</h4>

<p>See <a href="#wherejsonisarray"><code class="prettyprint">whereJsonIsArray</code></a></p>

<h4 id="wherejsonnotarray">whereJsonNotArray</h4>

<p>See <a href="#wherejsonisarray"><code class="prettyprint">whereJsonIsArray</code></a></p>

<h4 id="orwherejsonnotarray">orWhereJsonNotArray</h4>

<p>See <a href="#wherejsonisarray"><code class="prettyprint">whereJsonIsArray</code></a></p>

<h4 id="wherejsonisobject">whereJsonIsObject</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonIsObject</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">);</span>
</code></pre>
<p>Where json field reference is an object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td></td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonisobject">orWhereJsonIsObject</h4>

<p>See <a href="#wherejsonisobject"><code class="prettyprint">whereJsonIsObject</code></a></p>

<h4 id="wherejsonnotobject">whereJsonNotObject</h4>

<p>See <a href="#wherejsonisobject"><code class="prettyprint">whereJsonIsObject</code></a></p>

<h4 id="orwherejsonnotobject">orWhereJsonNotObject</h4>

<p>See <a href="#wherejsonisobject"><code class="prettyprint">whereJsonIsObject</code></a></p>

<h4 id="wherejsonhasany">whereJsonHasAny</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonHasAny</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">,</span> <span class="nx">keys</span><span class="p">);</span>
</code></pre>
<p>Where any of given strings is found from json object key(s) or array items.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td></td>
</tr>
<tr>
<td>keys</td>
<td>string&#124;Array.&lt;string&gt;</td>
<td>Strings that are looked from object or array</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonhasany">orWhereJsonHasAny</h4>

<p>See <a href="#wherejsonhasany"><code class="prettyprint">whereJsonHasAny</code></a></p>

<h4 id="wherejsonhasall">whereJsonHasAll</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonHasAll</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">,</span> <span class="nx">keys</span><span class="p">);</span>
</code></pre>
<p>Where all of given strings are found from json object key(s) or array items.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td></td>
</tr>
<tr>
<td>keys</td>
<td>string&#124;Array.&lt;string&gt;</td>
<td>Strings that are looked from object or array</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonhasall">orWhereJsonHasAll</h4>

<p>See <a href="#wherejsonhasall"><code class="prettyprint">whereJsonHasAll</code></a></p>

<h4 id="wherejsonfield">whereJsonField</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">whereJsonField</span><span class="p">(</span><span class="nx">fieldExpression</span><span class="p">,</span> <span class="nx">operator</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
</code></pre>
<p>Where referred json field value casted to same type with value fulfill given operand.</p>

<p>Value may be number, string, null, boolean and referred json field is converted
to TEXT, NUMERIC or BOOLEAN sql type for comparison.</p>

<p>If left hand field does not exist rows appear IS null so if one needs to get only
rows, which has key and it&rsquo;s value is null one may use e.g.
<a href="#wherejsonsupersetof"><code class="prettyprint">.whereJsonSupersetOf(&quot;column&quot;, { field: null })</code></a> or check is key exist and
then <a href="#wherejsonfield"><code class="prettyprint">.whereJsonField(&#39;column:field&#39;, &#39;IS&#39;, null)</code></a></p>

<p>For testing against objects or arrays one should see tested with <a href="#wherejsonequal"><code class="prettyprint">whereJsonEqual</code></a>,
<a href="#wherejsonsupersetof"><code class="prettyprint">whereJsonSupersetOf</code></a> and <a href="#wherejsonsubsetof"><code class="prettyprint">whereJsonSubsetOf</code></a> methods.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>fieldExpression</td>
<td><a href="#fieldexpression"><code class="prettyprint">FieldExpression</code></a></td>
<td>Expression pointing to certain value</td>
</tr>
<tr>
<td>operator</td>
<td>string</td>
<td>SQL comparator usually <code class="prettyprint">&lt;</code>, <code class="prettyprint">&gt;</code>, <code class="prettyprint">&lt;&gt;</code>, <code class="prettyprint">=</code> or <code class="prettyprint">!=</code></td>
</tr>
<tr>
<td>value</td>
<td>boolean&#124;number&#124;string&#124;null</td>
<td>Value to which field is compared to</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="orwherejsonfield">orWhereJsonField</h4>

<p>See <a href="#wherejsonfield"><code class="prettyprint">whereJsonField</code></a></p>

<h3 id="other-instance-methods">Other instance methods</h3>

<h4 id="context">context</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">context</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>You can set the context like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">context</span><span class="p">({</span><span class="na">something</span><span class="p">:</span> <span class="s1">'hello'</span><span class="p">});</span>
</code></pre>
<blockquote>
<p>and access the context like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">context</span><span class="p">();</span>
</code></pre>
<blockquote>
<p>You can set any data to the context object. You can also register QueryBuilder lifecycle methods
for <em>all</em> queries that share the context:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">context</span><span class="p">({</span>
    <span class="na">runBefore</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{},</span>
    <span class="na">runAfter</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{},</span>
    <span class="na">onBuild</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{}</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>For example the <code class="prettyprint">eager</code> method causes multiple queries to be executed from a single query builder.
If you wanted to make all of them use the same schema you could write this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[movies, children.movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">context</span><span class="p">({</span>
    <span class="na">onBuild</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">withSchema</span><span class="p">(</span><span class="s1">'someSchema'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</code></pre>
<p>Sets/gets the query context.</p>

<p>Some query builder methods create more than one query. The query context is an object that is
shared with all queries started by a query builder.</p>

<p>The context is also passed to <a href="#_s_beforeinsert"><code class="prettyprint">$beforeInsert</code></a>, <a href="#_s_afterinsert"><code class="prettyprint">$afterInsert</code></a>,
<a href="#_s_beforeupdate"><code class="prettyprint">$beforeUpdate</code></a>, <a href="#_s_afterupdate"><code class="prettyprint">$afterUpdate</code></a>, <a href="#_s_beforeidelete"><code class="prettyprint">$beforeDelete</code></a>,
<a href="#_s_afterdelete"><code class="prettyprint">$afterDelete</code></a> and <a href="#_s_afterget"><code class="prettyprint">$afterGet</code></a> calls that the query creates.</p>

<p>In addition to properties added using this method (and <a href="#mergecontext"><code class="prettyprint">mergeContext</code></a>) the query context
object always has a <code class="prettyprint">transaction</code> property that holds the active transaction. If there is no active transaction
the <code class="prettyprint">transaction</code> property contains the normal knex instance. In both cases the value can be passed anywhere
where a transaction object can be passed so you never need to check for the existence of the <code class="prettyprint">transaction</code>
property.</p>

<p>See the methods <a href="#runbefore"><code class="prettyprint">runBefore</code></a>, <a href="#onbuild"><code class="prettyprint">onBuild</code></a> and <a href="#runafter"><code class="prettyprint">runAfter</code></a>
for more information about the hooks.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The query context object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="mergecontext">mergeContext</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">mergeContext</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">);</span>
</code></pre>
<p>Merges values into the query context.</p>

<p>This method is like <a href="#context"><code class="prettyprint">context</code></a> but instead of replacing the whole context
this method merges the objects.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The object to merge into the query context.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="reject">reject</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">reason</span><span class="p">);</span>
</code></pre>
<p>Skips the database query and &ldquo;fakes&rdquo; an error result.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>reson</td>
<td></td>
<td>The rejection reason</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="resolve">resolve</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</code></pre>
<p>Skips the database query and &ldquo;fakes&rdquo; a result.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>value</td>
<td></td>
<td>The resolve value</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="isexecutable">isExecutable</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">executable</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">isExecutable</span><span class="p">();</span>
</code></pre>
<p>Returns false if this query will never be executed.</p>

<p>This may be true in multiple cases:</p>

<ol>
<li>The query is explicitly resolved or rejected using the <a href="#resolve"><code class="prettyprint">resolve</code></a> or <a href="#reject"><code class="prettyprint">reject</code></a> methods.</li>
<li>The query starts a different query when it is executed.</li>
</ol>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>boolean</td>
<td>false if the query will never be executed.</td>
</tr>
</tbody></table>

<h4 id="runbefore">runBefore</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">runBefore</span><span class="p">(</span><span class="nx">runBefore</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>

<span class="nx">query</span>
 <span class="p">.</span><span class="nx">runBefore</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello 1'</span><span class="p">);</span>

   <span class="k">return</span> <span class="nx">Promise</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello 2'</span><span class="p">);</span>
   <span class="p">});</span>
 <span class="p">})</span>
 <span class="p">.</span><span class="nx">runBefore</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'hello 3'</span><span class="p">);</span>
 <span class="p">});</span>

<span class="nx">query</span><span class="p">.</span><span class="nx">then</span><span class="p">();</span>
<span class="c1">// --&gt; hello 1</span>
<span class="c1">// --&gt; hello 2</span>
<span class="c1">// --&gt; hello 3</span>
</code></pre>
<p>Registers a function to be called before the database query when the builder is executed. Multiple functions can be
chained like <a href="#then"><code class="prettyprint">then</code></a> methods of a promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>runBefore</td>
<td>function(any, <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)</td>
<td>The function to be executed.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="onbuild">onBuild</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">onBuild</span><span class="p">(</span><span class="nx">onBuild</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>

<span class="nx">query</span>
 <span class="p">.</span><span class="nx">onBuild</span><span class="p">(</span><span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
 <span class="p">})</span>
 <span class="p">.</span><span class="nx">onBuild</span><span class="p">(</span><span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">builder</span><span class="p">.</span><span class="nx">orWhere</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
 <span class="p">});</span>
</code></pre>
<p>Functions registered with this method are called each time the query is built into an SQL string. This method is ran
after <a href="#runbefore"><code class="prettyprint">runBefore</code></a> methods but before <a href="#runafter"><code class="prettyprint">runAfter</code></a> methods.</p>

<p>If you need to modify the SQL query at query build time, this is the place to do it. You shouldn&rsquo;t
modify the query in any of the <code class="prettyprint">run</code> methods.</p>

<p>Unlike the run methods these must be synchronous. Also you should not register any run methods
from these. You should <em>only</em> call the query building methods of the builder provided as a parameter.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>onBuild</td>
<td>function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)</td>
<td>The function to be executed.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="runafter">runAfter</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">runAfter</span><span class="p">(</span><span class="nx">runAfter</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>

<span class="nx">query</span>
 <span class="p">.</span><span class="nx">runAfter</span><span class="p">((</span><span class="nx">models</span><span class="p">,</span> <span class="nx">queryBuilder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="k">return</span> <span class="nx">models</span><span class="p">;</span>
 <span class="p">})</span>
 <span class="p">.</span><span class="nx">runAfter</span><span class="p">((</span><span class="nx">models</span><span class="p">,</span> <span class="nx">queryBuilder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">models</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">}));</span>
 <span class="p">});</span>

<span class="nx">query</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">models</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">jennifer</span> <span class="o">=</span> <span class="nx">models</span><span class="p">[</span><span class="nx">models</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">});</span>
</code></pre>
<p>Registers a function to be called when the builder is executed.</p>

<p>These functions are executed as the last thing before any promise handlers
registered using the <a href="#then"><code class="prettyprint">then</code></a> method. Multiple functions can be chained like
<a href="#then"><code class="prettyprint">then</code></a>  methods of a promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>runAfter</td>
<td>function(*, <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)</td>
<td>The function to be executed.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="eageralgorithm">eagerAlgorithm</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">eagerAlgorithm</span><span class="p">(</span><span class="nx">algo</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eagerAlgorithm</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">JoinEagerAlgorithm</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[pets, children]'</span><span class="p">)</span>
</code></pre>
<p>Select the eager loading algorithm for the query. See comparison between
the available algorithms <a href="#eager">here</a>.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>algo</td>
<td>EagerAlgorithm</td>
<td>The eager loading algorithm to use. Either <code class="prettyprint">Model.JoinEagerAlgorithm</code> or <code class="prettyprint">Model.WhereInEagerAlgorithm</code>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="eager">eager</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="nx">relationExpression</span><span class="p">,</span> <span class="nx">filters</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="c1">// Fetch `children` relation for each result Person and `pets` and `movies`</span>
<span class="c1">// relations for all the children.</span>
<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children.[pets, movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Relations can be filtered by giving named filter functions as arguments
to the relations:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children(orderByAge).[pets(onlyDogs, orderByName), movies]'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">orderByAge</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'age'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">orderByName</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">onlyDogs</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Reusable named filters can be defined for a model class using <a href="#namedfilters"><code class="prettyprint">namedFilters</code></a></p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">namedFilters</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">orderByAge</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'age'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">Animal</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">namedFilters</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">orderByName</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
      <span class="p">},</span>
      <span class="na">onlyDogs</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children(orderByAge).[pets(onlyDogs, orderByName), movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Filters can also be registered using the <a href="#modifyeager"><code class="prettyprint">modifyEager</code></a> method:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children.[pets, movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'children'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Order children by age.</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'age'</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'children.[pets, movies]'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Only select `pets` and `movies` whose id &gt; 10 for the children.</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'children.movies]'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Only select 100 first movies for the children.</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>The eager queries are optimized to avoid the N + 1 query problem. Consider this query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children.children'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 10</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 10</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>The person has 10 children and they all have 10 children. The query above will
return 100 database rows but will generate only three database queries when using
<code class="prettyprint">WhereInEagerAlgorithm</code> and only one query when using <code class="prettyprint">JoinEagerAlgorithm</code>.</p>

<p>The loading algorithm can be changed using the <a href="#eageralgorithm"><code class="prettyprint">eagerAlgorithm</code></a> method:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eagerAlgorithm</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">JoinEagerAlgorithm</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[movies, children.pets]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'movies.name'</span><span class="p">,</span> <span class="s1">'like'</span><span class="p">,</span> <span class="s1">'%terminator%'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'children:pets.species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Fetch relations eagerly for the result rows.</p>

<p>See the <a href="#eager-queries">eager queries</a> section for more examples and <a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a>
for more info on the relation expression language.</p>

<p>You can choose the way objection performs the eager loading by using <a href="#eageralgorithm"><code class="prettyprint">eagerAlgorithm</code></a> method
on a query builder or by setting the <a href="#defaulteageralgorithm"><code class="prettyprint">defaultEagerAlgorithm</code></a> property of a model. The
two algorithms currently available are <code class="prettyprint">Model.WhereInEagerAlgorithm</code> (the default) and <code class="prettyprint">Model.JoinEagerAlgorithm</code>.
Both have their strengths and weaknesses. We will go through the main differences below. You can always see the
executed SQL by calling the <a href="#debug"><code class="prettyprint">debug</code></a> method for the query builder.</p>

<p><b>WhereInEagerAlgorithm</b></p>

<p>This algorithm uses multiple queries to fetch the related objects. Objection performs one query per level
in the eager tree. For example only two additional queries will be created for eager expression <code class="prettyprint">children.children</code>
no matter how many children the model has or how many children each of the children have. This algorithm is explained
in detail in <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/">this blog post</a>.</p>

<p>Limitations:</p>

<ul>
<li>Relations cannot be referred in the query because they are not joined.</li>
<li><code class="prettyprint">limit</code> and <code class="prettyprint">page</code> methods will work incorrectly when applied to a relation using <code class="prettyprint">filterEager</code>,
because they will be applied on a query that fetches relations for multiple parents. You can use
<code class="prettyprint">limit</code> and <code class="prettyprint">page</code> for the root query.</li>
</ul>

<p><b>JoinEagerAlgorithm</b></p>

<p>This algorithm uses joins to fetch the whole eager tree using one single query. This allows you to reference the relations
in the root query (see the last example). The related tables can be referred using the relation name. Nested relations
must be separated by <code class="prettyprint">:</code> character (dot is not used because of the way knex parses identifiers).</p>

<p>Limitations:</p>

<ul>
<li><code class="prettyprint">limit</code> and <code class="prettyprint">page</code> methods will work incorrectly because the will limit the result set which contains all the result
rows in a flattened format. For example the result set of the eager expression <code class="prettyprint">children.children</code> will have
<code class="prettyprint">10 * 10 * 10</code> rows assuming the you fetched 10 models that all had 10 children that all had 10 children.</li>
</ul>

<p><b>Performance differences</b></p>

<p><code class="prettyprint">WhereInEagerAlgorithm</code> performs more queries than <code class="prettyprint">JoinEagerAlgorithm</code> which can cause a significant delay especially if
the round trip time to the database server is significant. On the other hand the result from <code class="prettyprint">WhereInEagerAlgorithm</code> is
trivial to parse into a tree structure while the result of <code class="prettyprint">JoinEagerAlgorithm</code> needs some complex parsing which
can lead to a significant performance decrease. Which method is faster depends heavily on the query and the environment.
You should select the algorithm that makes your code cleaner and only consider performance if you have an actual measured
real-life problem. Don&rsquo;t optimize prematurely!</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relationExpression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>The eager expression</td>
</tr>
<tr>
<td>filters</td>
<td>Object&lt;string, function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)&gt;</td>
<td>The named filter functions for the expression</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="mergeeager">mergeEager</h4>

<blockquote>
<p>The following queries are equivalent</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[children.pets, movies]'</span><span class="p">)</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">mergeEager</span><span class="p">(</span><span class="s1">'children.pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">mergeEager</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">)</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children.pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">mergeEager</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">)</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">mergeEager</span><span class="p">(</span><span class="s1">'children.pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">mergeEager</span><span class="p">(</span><span class="s1">'movies'</span><span class="p">)</span>
</code></pre>
<p>Just like <a href="#eager">eager</a> but instead of replacing query builder&rsquo;s eager expression this method merges the given
expression to the existing expression.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relationExpression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>The eager expression</td>
</tr>
<tr>
<td>filters</td>
<td>Object&lt;string, function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)&gt;</td>
<td>The named filter functions for the expression</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="alloweager">allowEager</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">allowEager</span><span class="p">(</span><span class="nx">relationExpression</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">allowEager</span><span class="p">(</span><span class="s1">'[children.pets, movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">eager</span><span class="p">)</span>
</code></pre>
<p>Sets the allowed eager expression.</p>

<p>Any subset of the allowed expression is accepted by <a href="#eager"><code class="prettyprint">eager</code></a> method. For example setting
the allowed expression to <code class="prettyprint">a.b.c</code> expressions <code class="prettyprint">a</code>, <code class="prettyprint">a.b</code> and <code class="prettyprint">a.b.c</code> are accepted by <a href="#eager"><code class="prettyprint">eager</code></a>
method. Setting any other expression will reject the query and cause the promise error handlers
to be called.</p>

<p>This method is useful when the eager expression comes from an untrusted source like query
parameters of a http request.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relationExpression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>The allowed eager expression</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="modifyeager">modifyEager</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="nx">pathExpression</span><span class="p">,</span> <span class="nx">modifier</span><span class="p">);</span>
</code></pre>
<p>Can be used to modify the eager queries.</p>

<p>The <code class="prettyprint">pathExpression</code> is a relation expression that specifies the queries for which the modifier is given.</p>

<blockquote>
<p>The following query would filter out the children&rsquo;s pets that
are &lt;= 10 years old:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[children.[pets, movies], movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'children.pets'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">})</span>
</code></pre>
<blockquote>
<p>The path expression can have multiple targets. The next example sorts both the
pets and movies of the children by id:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[children.[pets, movies], movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'children.[pets, movies]'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
  <span class="p">})</span>
</code></pre>
<blockquote>
<p>This example only selects movies whose name contains the word &#39;Predator&rsquo;:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[children.[pets, movies], movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">modifyEager</span><span class="p">(</span><span class="s1">'[children.movies, movies]'</span><span class="p">,</span> <span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'like'</span><span class="p">,</span> <span class="s1">'%Predator%'</span><span class="p">);</span>
  <span class="p">})</span>
</code></pre>
<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>pathExpression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>Expression that specifies the queries for which to give the filter.</td>
</tr>
<tr>
<td>modifier</td>
<td>function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>The modifier function.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="filtereager">filterEager</h4>

<p>Alias for <a href="#modifyeager">modifyEager</a>.</p>

<h4 id="allowinsert">allowInsert</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">allowInsert</span><span class="p">(</span><span class="nx">relationExpression</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">allowInsert</span><span class="p">(</span><span class="s1">'[children.pets, movies]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insertGraph</span><span class="p">({</span>
    <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sylvester'</span><span class="p">,</span>
    <span class="na">children</span><span class="p">:</span> <span class="p">[{</span>
      <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sage'</span><span class="p">,</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">[{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy'</span>
        <span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span>
      <span class="p">},</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'Scrappy'</span><span class="p">,</span>
        <span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span>
      <span class="p">}]</span>
    <span class="p">}]</span>
  <span class="p">})</span>
</code></pre>
<p>Sets the allowed tree of relations to insert using <a href="#insertgraph"><code class="prettyprint">insertGraph</code></a> method.</p>

<p>If the model tree given to the <a href="#insertgraph"><code class="prettyprint">insertGraph</code></a> method isn&rsquo;t a subtree of the
given expression, the query is rejected.</p>

<p>See methods <a href="#eager"><code class="prettyprint">eager</code></a>, <a href="#alloweager"><code class="prettyprint">allowEager</code></a>, <a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a> and the
section about <a href="#eager-queries">eager queries</a> for more information on relation expressions.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relationExpression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>The allowed eager expression</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining.</td>
</tr>
</tbody></table>

<h4 id="modelclass">modelClass</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">modelClass</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">modelClass</span><span class="p">();</span>
</code></pre>
<p>Gets the Model subclass this builder is bound to.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The Model subclass this builder is bound to</td>
</tr>
</tbody></table>

<h4 id="tostring">toString</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">sql</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</code></pre>
<p>Returns the SQL string. If this query builder executes multiple queries, only the first query&rsquo;s SQL is returned.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>string</td>
<td>The SQL this query builder will build</td>
</tr>
</tbody></table>

<h4 id="tosql">toSql</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">sql</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">toSql</span><span class="p">();</span>
</code></pre>
<p>Returns the SQL string. If this query builder executes multiple queries, only the first query&rsquo;s SQL is returned.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>string</td>
<td>The SQL this query builder will build</td>
</tr>
</tbody></table>

<h4 id="skipundefined">skipUndefined</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">skipUndefined</span><span class="p">();</span>
</code></pre>
<p>If this method is called for a builder then undefined values passed to the query builder methods don&rsquo;t cause
an exception but are ignored instead.</p>

<blockquote>
<p>For example the following query will return all <code class="prettyprint">Person</code> rows if <code class="prettyprint">req.query.firstName</code> is <code class="prettyprint">undefined</code>.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">skipUndefined</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">firstName</span><span class="p">)</span>
</code></pre>
<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="transacting">transacting</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">transacting</span><span class="p">(</span><span class="nx">transaction</span><span class="p">);</span>
</code></pre>
<p>Sets the transaction for a query.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>transaction</td>
<td>object</td>
<td>A transaction object</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="clone">clone</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
</code></pre>
<p>Create a clone of this builder.</p>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>Clone of the query builder</td>
</tr>
</tbody></table>

<h4 id="execute">execute</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">execute</span><span class="p">();</span>
</code></pre>
<p>Executes the query and returns a Promise.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="then">then</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">successHandler</span><span class="p">,</span> <span class="nx">errorHandler</span><span class="p">);</span>
</code></pre>
<p>Executes the query and returns a Promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>successHandler</td>
<td>function</td>
<td>identity</td>
<td>Promise success handler</td>
</tr>
<tr>
<td>errorHandler</td>
<td>function</td>
<td>identity</td>
<td>Promise error handler</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="map">map</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">mapper</span><span class="p">);</span>
</code></pre>
<p>Executes the query and calls <code class="prettyprint">map(mapper)</code> for the returned promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>mapper</td>
<td>function</td>
<td>identity</td>
<td>Mapper function</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="catch">catch</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">errorHandler</span><span class="p">);</span>
</code></pre>
<p>Executes the query and calls <code class="prettyprint">catch(errorHandler)</code> for the returned promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>errorHandler</td>
<td>function</td>
<td>identity</td>
<td>Error handler</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="return">return</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="k">return</span><span class="p">(</span><span class="nx">returnValue</span><span class="p">);</span>
</code></pre>
<p>Executes the query and calls <code class="prettyprint">return(returnValue)</code> for the returned promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>returnValue</td>
<td></td>
<td>undefined</td>
<td>Return value</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="bind">bind</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">returnValue</span><span class="p">);</span>
</code></pre>
<p>Executes the query and calls <code class="prettyprint">bind(context)</code> for the returned promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>context</td>
<td></td>
<td>undefined</td>
<td>Bind context</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="ascallback">asCallback</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">asCallback</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</code></pre>
<p>Executes the query and calls <code class="prettyprint">asCallback(callback)</code> for the returned promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>callback</td>
<td>function</td>
<td>undefined</td>
<td>Node style callback</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="nodeify">nodeify</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">nodeify</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</code></pre>
<p>Executes the query and calls <code class="prettyprint">nodeify(callback)</code> for the returned promise.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>callback</td>
<td>function</td>
<td>undefined</td>
<td>Node style callback</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result of the query.</td>
</tr>
</tbody></table>

<h4 id="resultsize">resultSize</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">resultSize</span><span class="p">();</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">query</span> <span class="o">=</span> <span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

<span class="nx">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
  <span class="nx">query</span><span class="p">.</span><span class="nx">resultSize</span><span class="p">(),</span>
  <span class="nx">query</span><span class="p">.</span><span class="nx">offset</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="p">]).</span><span class="nx">spread</span><span class="p">((</span><span class="nx">total</span><span class="p">,</span> <span class="nx">models</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">});</span>
</code></pre>
<p>Returns the amount of rows the current query would produce without <a href="#limit"><code class="prettyprint">limit</code></a> and <a href="#offset"><code class="prettyprint">offset</code></a> applied.
Note that this executes a query (not the one we are building) and returns a Promise.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a></td>
<td>Promise the will be resolved with the result size.</td>
</tr>
</tbody></table>

<h4 id="page">page</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="nx">page</span><span class="p">,</span> <span class="nx">pageSize</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">page</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 100</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span> <span class="c1">// --&gt; 3341</span>
  <span class="p">});</span>
</code></pre>
<p>Two queries queries are performed by this method: the actual query and a query to get the <code class="prettyprint">total</code> count.</p>

<p>Mysql has the <code class="prettyprint">SQL_CALC_FOUND_ROWS</code> option and <code class="prettyprint">FOUND_ROWS()</code> function that can be used to calculate the result size,
but according to my tests and <a href="http://www.google.com/search?q=SQL_CALC_FOUND_ROWS+performance">the interwebs</a> the
performance is significantly worse than just executing a separate count query.</p>

<p>Postgresql has window functions that can be used to get the total count like this <code class="prettyprint">select count(*) over () as total</code>.
The problem with this is that if the result set is empty, we don&rsquo;t get the total count either.
(If someone can figure out a way around this, a PR is very welcome).</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>page</td>
<td>number</td>
<td>The index of the page to return</td>
</tr>
<tr>
<td>pageSize</td>
<td>number</td>
<td>The page size</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="range">range</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 101</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span> <span class="c1">// --&gt; 3341</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">range</code> can be called without arguments if you want to specify the limit and offset explicitly:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">range</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span> <span class="c1">// --&gt; 101</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span> <span class="c1">// --&gt; 3341</span>
  <span class="p">});</span>
</code></pre>
<p>Only returns the given range of results.</p>

<p>Two queries queries are performed by this method: the actual query and a query to get the <code class="prettyprint">total</code> count.</p>

<p>Mysql has the <code class="prettyprint">SQL_CALC_FOUND_ROWS</code> option and <code class="prettyprint">FOUND_ROWS()</code> function that can be used to calculate the result size,
but according to my tests and <a href="http://www.google.com/search?q=SQL_CALC_FOUND_ROWS+performance">the interwebs</a> the
performance is significantly worse than just executing a separate count query.</p>

<p>Postgresql has window functions that can be used to get the total count like this <code class="prettyprint">select count(*) over () as total</code>.
The problem with this is that if the result set is empty, we don&rsquo;t get the total count either.
(If someone can figure out a way around this, a PR is very welcome).</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>start</td>
<td>number</td>
<td>The index of the first result (inclusive)</td>
</tr>
<tr>
<td>end</td>
<td>number</td>
<td>The index of the last result (inclusive)</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="pluck">pluck</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">propertyName</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">firstNames</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">firstNames</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="c1">// --&gt; string</span>
  <span class="p">});</span>
</code></pre>
<p>If the result is an array, plucks a property from each object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>propertyName</td>
<td>string</td>
<td>The name of the property to pluck</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="first">first</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">first</span><span class="p">();</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">first</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">firstPerson</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">age</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>If the result is an array, selects the first item.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="throwifnotfound">throwIfNotFound</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">throwIfNotFound</span><span class="p">();</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Language</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'Java'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">andWhere</span><span class="p">(</span><span class="s1">'isModern'</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">throwIfNotFound</span><span class="p">()</span>
  <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// No results found.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span> <span class="k">instanceof</span> <span class="nx">Language</span><span class="p">.</span><span class="nx">NotFoundError</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
  <span class="p">});</span>
</code></pre>
<p>Causes a <a href="#notfounderror"><code class="prettyprint">Model.NotFoundError</code></a> to be thrown if the query result is empty.</p>

<p>You can replace <code class="prettyprint">Model.NotFoundError</code> with your own error by implementing the static 
<a href="#createnotfounderror"><code class="prettyprint">Model.createNotFoundError(ctx)</code></a> method.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="traverse">traverse</h4>
<pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">traverse</span><span class="p">(</span><span class="nx">modelClass</span><span class="p">,</span> <span class="nx">traverser</span><span class="p">);</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">traverse</span><span class="p">((</span><span class="nx">model</span><span class="p">,</span> <span class="nx">parentModel</span><span class="p">,</span> <span class="nx">relationName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span> <span class="c1">// --&gt; undefined</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span> <span class="c1">// --&gt; undefined</span>
  <span class="p">});</span>
</code></pre><pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">traverse</span><span class="p">(</span><span class="nx">Animal</span><span class="p">,</span> <span class="p">(</span><span class="nx">animal</span><span class="p">,</span> <span class="nx">parentModel</span><span class="p">,</span> <span class="nx">relationName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">animal</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">persons</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">persons</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span> <span class="c1">// --&gt; 1</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">persons</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span> <span class="c1">// --&gt; undefined</span>
  <span class="p">});</span>
</code></pre>
<p>Traverses through all models in the result, including the eagerly loaded relations.</p>

<p>The optional first parameter can be a constructor. If given, the traverser
function is only called for the models of that class.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelClass</td>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The optional model class filter. If given, the traverser function is only called for models of this class.</td>
</tr>
<tr>
<td>traverser</td>
<td>function(<a href="#model"><code class="prettyprint">Model</code></a>, <a href="#model"><code class="prettyprint">Model</code></a>, string)</td>
<td>The traverser function that is called for each model. The first argument is the model itself. If the model is in a relation of some other model the second argument is the parent model and the third argument is the name of the relation.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="pick">pick</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">modelClass</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>There are two ways to call this methods:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">).</span>
  <span class="p">.</span><span class="nx">pick</span><span class="p">([</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">]);</span>
</code></pre>
<blockquote>
<p>and</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'firstName'</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">Animal</span><span class="p">,</span> <span class="p">[</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'name'</span><span class="p">]);</span>
</code></pre>
<p>Pick properties from result models.</p>

<p>The first example goes through all models (including relations) and discards all
properties but <code class="prettyprint">id</code> and <code class="prettyprint">name</code>. The second example also traverses the whole model
tree and discards all but <code class="prettyprint">id</code> and <code class="prettyprint">firstName</code> properties of all <code class="prettyprint">Person</code>
instances and <code class="prettyprint">id</code> and <code class="prettyprint">name</code> properties of all <code class="prettyprint">Animal</code> instances.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelClass</td>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The optional model class filter</td>
</tr>
<tr>
<td>properties</td>
<td>Array.&lt;string&gt;</td>
<td>The properties to pick</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h4 id="omit">omit</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">queryBuilder</span><span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">modelClass</span><span class="p">,</span> <span class="nx">properties</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>There are two ways to call this methods:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">).</span>
  <span class="p">.</span><span class="nx">omit</span><span class="p">([</span><span class="s1">'parentId'</span><span class="p">,</span> <span class="s1">'ownerId'</span><span class="p">]);</span>
</code></pre>
<blockquote>
<p>and</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="p">[</span><span class="s1">'parentId'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">omit</span><span class="p">(</span><span class="nx">Animal</span><span class="p">,</span> <span class="p">[</span><span class="s1">'ownerId'</span><span class="p">,</span> <span class="s1">'species'</span><span class="p">]);</span>
</code></pre>
<p>Omit properties of result models.</p>

<p>The first example goes through all models (including relations) and omits the properties
<code class="prettyprint">parentId</code> and <code class="prettyprint">ownerId</code>. The second example also traverses the whole model tree and
omits the properties <code class="prettyprint">parentId</code> and <code class="prettyprint">age</code> from all <code class="prettyprint">Person</code> instances and <code class="prettyprint">ownerId</code>
and <code class="prettyprint">species</code> properties of all <code class="prettyprint">Animal</code> instances.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>modelClass</td>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The optional model class filter</td>
</tr>
<tr>
<td>properties</td>
<td>Array.&lt;string&gt;</td>
<td>The properties to omit</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td><code class="prettyprint">this</code> query builder for chaining</td>
</tr>
</tbody></table>

<h2 id="model">Model</h2>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="c1">// Table name is the only required property.</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">tableName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'Person'</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Optional JSON schema. This is not the database schema!</span>
  <span class="c1">// Nothing is generated based on this. This is only used</span>
  <span class="c1">// for validation. Whenever a model instance is created</span>
  <span class="c1">// it is checked against this schema.</span>
  <span class="c1">// http://json-schema.org/.</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">jsonSchema</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
      <span class="na">required</span><span class="p">:</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">],</span>

      <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'integer'</span><span class="p">},</span>
        <span class="na">parentId</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="s1">'integer'</span><span class="p">,</span> <span class="s1">'null'</span><span class="p">]},</span>
        <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
        <span class="na">lastName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
        <span class="na">age</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'number'</span><span class="p">},</span>

        <span class="c1">// Properties defined as objects or arrays are</span>
        <span class="c1">// automatically converted to JSON strings when</span>
        <span class="c1">// writing to database and back to objects and arrays</span>
        <span class="c1">// when reading from database. To override this</span>
        <span class="c1">// behaviour, you can override the</span>
        <span class="c1">// Person.jsonAttributes property.</span>
        <span class="na">address</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
          <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">street</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
            <span class="na">city</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
            <span class="na">zipCode</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="c1">// This object defines the relations to other models.</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="c1">// The related model. This can be either a Model</span>
        <span class="c1">// subclass constructor or an absolute file path</span>
        <span class="c1">// to a module that exports one. We use the file</span>
        <span class="c1">// path version here to prevent require loops.</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/Animal'</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Animal.ownerId'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">movies</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ManyToManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/Movie'</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="c1">// ManyToMany relation needs the `through` object</span>
          <span class="c1">// to describe the join table.</span>
          <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.actorId'</span><span class="p">,</span>
            <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>

            <span class="c1">// If you have a model class for the join table</span>
            <span class="c1">// you can specify it like this:</span>
            <span class="c1">//</span>
            <span class="c1">// modelClass: PersonMovie,</span>

            <span class="c1">// Columns listed here are automatically joined</span>
            <span class="c1">// to the related models on read and written to</span>
            <span class="c1">// the join table instead of the related table</span>
            <span class="c1">// on insert.</span>
            <span class="c1">//</span>
            <span class="c1">// extra: ['someExtra']</span>
          <span class="p">},</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">children</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.parentId'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">parent</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.parentId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.id'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Subclasses of this class represent database tables.</p>

<h5 id="model-lifecycle">Model lifecycle</h5>

<p>For the purposes of this explanation, let&rsquo;s define three data layouts:</p>

<ol>
<li><code class="prettyprint">database</code>: The data layout returned by the database.</li>
<li><code class="prettyprint">internal</code>: The data layout of a model instance.</li>
<li><code class="prettyprint">external</code>: The data layout after calling <code class="prettyprint">model.toJSON()</code>.</li>
</ol>

<p>Whenever data is converted from on layout to another, converter methods are called:</p>

<ol>
<li><code class="prettyprint">database</code> -&gt; <a href="#_s_parsedatabasejson"><code class="prettyprint">$parseDatabaseJson</code></a> -&gt; <code class="prettyprint">internal</code></li>
<li><code class="prettyprint">internal</code> -&gt; <a href="#_s_formatdatabasejson"><code class="prettyprint">$formatDatabaseJson</code></a> -&gt; <code class="prettyprint">database</code></li>
<li><code class="prettyprint">external</code> -&gt; <a href="#_s_parsejson"><code class="prettyprint">$parseJson</code></a> -&gt; <code class="prettyprint">internal</code></li>
<li><code class="prettyprint">internal</code> -&gt; <a href="#_s_formatjson"><code class="prettyprint">$formatJson</code></a> -&gt; <code class="prettyprint">external</code></li>
</ol>

<p>So for example when the results of a query are read from the database the data goes through the
<a href="#_s_parsedatabasejson"><code class="prettyprint">$parseDatabaseJson</code></a> method. When data is written to database it goes through
the <a href="#_s_formatdatabasejson"><code class="prettyprint">$formatDatabaseJson</code></a> method.</p>

<p>Similarly when you give data for a query (for example <a href="#insert"><code class="prettyprint">query().insert(req.body)</code></a>) or create a model
explicitly using <a href="#fromjson"><code class="prettyprint">Model.fromJson(obj)</code></a> the <a href="#_s_parsejson"><code class="prettyprint">$parseJson</code></a> method is invoked. When you call
<a href="#tojson"><code class="prettyprint">model.toJSON()</code></a> or <a href="#_s_tojson"><code class="prettyprint">model.$toJson()</code></a> the <a href="#_s_formatjson"><code class="prettyprint">$formatJson</code></a> is called.</p>

<p>Note: Most libraries like <a href="http://expressjs.com/en/index.html">express</a> automatically call the <a href="#tojson"><code class="prettyprint">toJSON</code></a>
method when you pass the model to methods like <code class="prettyprint">response.json(model)</code>. You rarely need to call
<a href="#tojson"><code class="prettyprint">toJSON()</code></a>  or <a href="#_s_tojson"><code class="prettyprint">$toJson()</code></a> explicitly.</p>

<p>By overriding the lifecycle methods, you can have different layouts for the data in database and when exposed to the
outside world. See <a href="#map-column-names-to-different-property-names">this recipe</a> for an example usage of the lifecycle
methods.</p>

<p>All instance methods of models are prefixed with <code class="prettyprint">$</code> letter so that they won&rsquo;t overlap with database
properties. All properties that start with <code class="prettyprint">$</code> are also removed from <code class="prettyprint">database</code> and <code class="prettyprint">external</code> layouts.</p>

<h3 id="static-properties">Static properties</h3>

<h4 id="tablename">tableName</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">tableName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'Person'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">tableName</span> <span class="o">=</span> <span class="s1">'Person'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Name of the database table for this model.</p>

<p>Each model must set this.</p>

<h4 id="jsonschema">jsonSchema</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">jsonSchema</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
      <span class="na">required</span><span class="p">:</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">],</span>

      <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">id</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'integer'</span><span class="p">},</span>
        <span class="na">parentId</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="s1">'integer'</span><span class="p">,</span> <span class="s1">'null'</span><span class="p">]},</span>
        <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
        <span class="na">lastName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
        <span class="na">age</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'number'</span><span class="p">},</span>

        <span class="c1">// Properties defined as objects or arrays are</span>
        <span class="c1">// automatically converted to JSON strings when</span>
        <span class="c1">// writing to database and back to objects and arrays</span>
        <span class="c1">// when reading from database. To override this</span>
        <span class="c1">// behaviour, you can override the</span>
        <span class="c1">// Person.jsonAttributes property.</span>
        <span class="na">address</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
          <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">street</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
            <span class="na">city</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
            <span class="na">zipCode</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">jsonSchema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
    <span class="na">required</span><span class="p">:</span> <span class="p">[</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">],</span>

    <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'integer'</span><span class="p">},</span>
      <span class="na">parentId</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="p">[</span><span class="s1">'integer'</span><span class="p">,</span> <span class="s1">'null'</span><span class="p">]},</span>
      <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
      <span class="na">lastName</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span> <span class="na">minLength</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">maxLength</span><span class="p">:</span> <span class="mi">255</span><span class="p">},</span>
      <span class="na">age</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'number'</span><span class="p">},</span>

      <span class="c1">// Properties defined as objects or arrays are</span>
      <span class="c1">// automatically converted to JSON strings when</span>
      <span class="c1">// writing to database and back to objects and arrays</span>
      <span class="c1">// when reading from database. To override this</span>
      <span class="c1">// behaviour, you can override the</span>
      <span class="c1">// Person.jsonAttributes property.</span>
      <span class="na">address</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">type</span><span class="p">:</span> <span class="s1">'object'</span><span class="p">,</span>
        <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">street</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
          <span class="na">city</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">},</span>
          <span class="na">zipCode</span><span class="p">:</span> <span class="p">{</span><span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>
<p>The optional schema against which the JSON is validated.</p>

<p>The jsonSchema can be dynamically modified in the <a href="#_s_beforevalidate"><code class="prettyprint">$beforeValidate</code></a> method.</p>

<p>Must follow http://json-schema.org specification. If null no validation is done.</p>

<p>Read more:</p>

<ul>
<li><a href="#_s_beforevalidate"><code class="prettyprint">$beforeValidate</code></a></li>
<li><a href="#_s_validate"><code class="prettyprint">$validate</code></a></li>
<li><a href="#_s_aftervalidate"><code class="prettyprint">$afterValidate</code></a></li>
<li><a href="#jsonattributes"><code class="prettyprint">jsonAttributes</code></a></li>
<li><a href="#custom-validation">custom validation recipe</a></li>
</ul>

<h4 id="idcolumn">idColumn</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">idColumn</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'some_column_name'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">idColumn</span> <span class="o">=</span> <span class="s1">'some_column_name'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Name of the primary key column in the database table.</p>

<p>Composite id can be specified by giving an array of column names.</p>

<p>Defaults to &#39;id&rsquo;.</p>

<h4 id="modelpaths">modelPaths</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">modelPaths</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">__dirname</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">modelPaths</span> <span class="o">=</span> <span class="p">[</span><span class="nx">__dirname</span><span class="p">];</span>
<span class="p">}</span>
</code></pre>
<p>A list of paths from which to search for models for relations.</p>

<p>A model class can be defined for a relation in <a href="#relationmappings"><code class="prettyprint">relationMappings</code></a> as</p>

<ol>
<li>A model class constructor</li>
<li>An absolute path to a module that exports a model class</li>
<li>A path relative to one of the paths in <code class="prettyprint">modelPaths</code> array.</li>
</ol>

<h4 id="relationmappings">relationMappings</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Animal.ownerId'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">father</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.fatherId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.id'</span>
        <span class="p">}</span>
      <span class="p">},</span>

      <span class="na">movies</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ManyToManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Movie</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.actorId'</span><span class="p">,</span>
            <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>

            <span class="c1">// If you have a model class for the join table</span>
            <span class="c1">// you can specify it like this:</span>
            <span class="c1">//</span>
            <span class="c1">// modelClass: PersonMovie,</span>

            <span class="c1">// Columns listed here are automatically joined</span>
            <span class="c1">// to the related models on read and written to</span>
            <span class="c1">// the join table instead of the related table</span>
            <span class="c1">// on insert.</span>
            <span class="c1">//</span>
            <span class="c1">// extra: ['someExtra']</span>
          <span class="p">},</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">relationMappings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Animal.ownerId'</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="na">father</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">BelongsToOneRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Person</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.fatherId'</span><span class="p">,</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Person.id'</span>
      <span class="p">}</span>
    <span class="p">},</span>

    <span class="na">movies</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">ManyToManyRelation</span><span class="p">,</span>
      <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Movie</span><span class="p">,</span>
      <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
        <span class="na">through</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person_Movie.actorId'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Person_Movie.movieId'</span>

          <span class="c1">// If you have a model class for the join table</span>
          <span class="c1">// you can specify it like this:</span>
          <span class="c1">//</span>
          <span class="c1">// modelClass: PersonMovie,</span>

          <span class="c1">// Columns listed here are automatically joined</span>
          <span class="c1">// to the related models on read and written to</span>
          <span class="c1">// the join table instead of the related table</span>
          <span class="c1">// on insert.</span>
          <span class="c1">//</span>
          <span class="c1">// extra: ['someExtra']</span>
        <span class="p">},</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'Movie.id'</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre>
<p>This property defines the relations to other models.</p>

<p>relationMappings is an object (or a function that returns an object) whose keys are relation names and values are <a href="#relationmapping"><code class="prettyprint">RelationMapping</code></a> instances.
The <code class="prettyprint">join</code> property in addition to the relation type define how the models are related to one
another. The <code class="prettyprint">from</code> and <code class="prettyprint">to</code> properties of the <code class="prettyprint">join</code> object define the database columns through which the
models are associated. Note that neither of these columns need to be primary keys. They can be any
columns. In the case of ManyToManyRelation also the join table needs to be defined. This is
done using the <code class="prettyprint">through</code> object.</p>

<p>The <code class="prettyprint">modelClass</code> passed to the relation mappings is the class of the related model. It can be one of the following:</p>

<ol>
<li>A model class constructor</li>
<li>An absolute path to a module that exports a model class</li>
<li>A path relative to one of the paths in <a href="#modelpaths"><code class="prettyprint">modelPaths</code></a> array.</li>
</ol>

<p>The file path versions are handy for avoiding require loops.</p>

<p>See <a href="#relationmapping"><code class="prettyprint">RelationMapping</code></a></p>

<h5 id="relationmapping">RelationMapping</h5>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relation</td>
<td>function</td>
<td>The relation type. One of <code class="prettyprint">Model.BelongsToOneRelation</code>, <code class="prettyprint">Model.HasOneRelation</code>, <code class="prettyprint">Model.HasManyRelation</code> and <code class="prettyprint">Model.ManyToManyRelation</code>.</td>
</tr>
<tr>
<td>modelClass</td>
<td><a href="#model"><code class="prettyprint">Model</code></a>&#124;string</td>
<td>Constructor of the related model class, an absolute path to a module that exports one or a path relative to <a href="#modelpaths"><code class="prettyprint">modelPaths</code></a> that exports a model class.</td>
</tr>
<tr>
<td>join</td>
<td><a href="#relationjoin"><code class="prettyprint">RelationJoin</code></a></td>
<td>Describes how the models are related to each other. See <a href="#relationjoin"><code class="prettyprint">RelationJoin</code></a>.</td>
</tr>
<tr>
<td>modify</td>
<td>function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)</td>
<td>Optional modifier for the relation query. This is called each time the relation is fetched.</td>
</tr>
<tr>
<td>filter</td>
<td>function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)</td>
<td>Alias for modify.</td>
</tr>
</tbody></table>

<h5 id="relationjoin">RelationJoin</h5>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>from</td>
<td>string&#124;Array.&lt;string&gt;</td>
<td>The relation column in the owner table. Must be given with the table name. For example <code class="prettyprint">Person.id</code>. Composite key can be specified using an array of columns e.g. <code class="prettyprint">[&#39;Person.a&#39;, &#39;Person.b&#39;]</code>. Note that neither this nor <code class="prettyprint">to</code> need to be foreign keys or primary keys. You can join any column to any column.</td>
</tr>
<tr>
<td>to</td>
<td>string&#124;Array.&lt;string&gt;</td>
<td>The relation column in the related table. Must be given with the table name. For example <code class="prettyprint">Movie.id</code>. Composite key can be specified using an array of columns e.g. <code class="prettyprint">[&#39;Movie.a&#39;, &#39;Movie.b&#39;]</code>. Note that neither this nor <code class="prettyprint">from</code> need to be foreign keys or primary keys. You can join any column to any column.</td>
</tr>
<tr>
<td>through</td>
<td><a href="#relationthrough"><code class="prettyprint">RelationThrough</code></a></td>
<td>Describes the join table if the models are related through one.</td>
</tr>
</tbody></table>

<h5 id="relationthrough">RelationThrough</h5>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>from</td>
<td>string&#124;Array.&lt;string&gt;</td>
<td>The column that is joined to <code class="prettyprint">from</code> property of the <code class="prettyprint">RelationJoin</code>. For example <code class="prettyprint">Person_Movie.actorId</code> where <code class="prettyprint">Person_Movie</code> is the join table. Composite key can be specified using an array of columns e.g. <code class="prettyprint">[&#39;Person_Movie.a&#39;, &#39;Person_Movie.b&#39;]</code>.</td>
</tr>
<tr>
<td>to</td>
<td>string&#124;Array.&lt;string&gt;</td>
<td>The column that is joined to <code class="prettyprint">to</code> property of the <code class="prettyprint">RelationJoin</code>. For example <code class="prettyprint">Person_Movie.movieId</code> where <code class="prettyprint">Person_Movie</code> is the join table. Composite key can be specified using an array of columns e.g. <code class="prettyprint">[&#39;Person_Movie.a&#39;, &#39;Person_Movie.b&#39;]</code>.</td>
</tr>
<tr>
<td>modelClass</td>
<td>string&#124;ModelClass</td>
<td>If you have a model class for the join table, you should specify it here. This is optional so you don&rsquo;t need to create a model class if you don&rsquo;t want to.</td>
</tr>
<tr>
<td>extra</td>
<td>Array.&lt;string&gt;&#124;Object</td>
<td>Columns listed here are automatically joined to the related objects when they are fetched and automatically written to the join table instead of the related table on insert. The values can be aliased by providing an object <code class="prettyprint">{propertyName: &#39;columnName&#39;, otherPropertyName: &#39;otherColumnName&#39;} instead of array</code></td>
</tr>
</tbody></table>

<h4 id="jsonattributes">jsonAttributes</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">jsonAttributes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'someProp'</span><span class="p">,</span> <span class="s1">'someOtherProp'</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">jsonAttributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'someProp'</span><span class="p">,</span> <span class="s1">'someOtherProp'</span><span class="p">];</span>
<span class="p">}</span>
</code></pre>
<p>Properties that should be saved to database as JSON strings.</p>

<p>The properties listed here are serialized to JSON strings upon insertion/update to the database
and parsed back to objects when models are read from the database. Combined with the
postgresql&rsquo;s json or jsonb data type, this is a powerful way of representing documents
as single database rows.</p>

<p>If this property is left unset all properties declared as objects or arrays in the
<a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> are implicitly added to this list.</p>

<h4 id="virtualattributes">virtualAttributes</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">virtualAttributes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="s1">'fullName'</span><span class="p">,</span> <span class="s1">'isFemale'</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">fullName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">firstName</span><span class="p">}</span><span class="s2"> </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">get</span> <span class="nx">isFemale</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">gender</span> <span class="o">===</span> <span class="s1">'female'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span>
  <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
  <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Aniston'</span><span class="p">,</span>
  <span class="na">gender</span><span class="p">:</span> <span class="s1">'female'</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
<span class="c1">// --&gt; {"firstName": "Jennifer", "lastName": "Aniston", "isFemale": true, "fullName": "Jennifer Aniston"}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">virtualAttributes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'fullName'</span><span class="p">,</span> <span class="s1">'isFemale'</span><span class="p">];</span>

  <span class="nx">fullName</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">firstName</span><span class="p">}</span><span class="s2"> </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">get</span> <span class="nx">isFemale</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">gender</span> <span class="o">===</span> <span class="s1">'female'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span>
  <span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span>
  <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Aniston'</span><span class="p">,</span>
  <span class="na">gender</span><span class="p">:</span> <span class="s1">'female'</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">());</span>
<span class="c1">// --&gt; {"firstName": "Jennifer", "lastName": "Aniston", "isFemale": true, "fullName": "Jennifer Aniston"}</span>
</code></pre>
<p>Getters and methods listed here are serialized with real properties when <code class="prettyprint">toJSON</code> is called.</p>

<p>The virtual values are not written to database. Only the &ldquo;external&rdquo; JSON format will contain them.</p>

<h4 id="uidprop">uidProp</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">uidProp</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'#id'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">uidProp</span> <span class="o">=</span> <span class="s1">'#id'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Name of the property used to store a temporary non-db identifier for the model.</p>

<p>Defaults to &rsquo;#id&rsquo;.</p>

<h4 id="uidrefprop">uidRefProp</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">uidRefProp</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'#ref'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">uidRefProp</span> <span class="o">=</span> <span class="s1">'#ref'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Name of the property used to store a reference to a <a href="#uidprop"><code class="prettyprint">uidProp</code></a></p>

<p>Defaults to &rsquo;#ref&rsquo;.</p>

<h4 id="dbrefprop">dbRefProp</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">dbRefProp</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s1">'#dbRef'</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">dbRefProp</span> <span class="o">=</span> <span class="s1">'#dbRef'</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Name of the property used to point to an existing database row from an <code class="prettyprint">insertGraph</code> graph.</p>

<p>Defaults to &rsquo;#dbRef&rsquo;.</p>

<h4 id="proprefregex">propRefRegex</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">propRefRegex</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sr">/#ref{</span><span class="se">([^\.]</span><span class="sr">+</span><span class="se">)\.([^</span><span class="sr">}</span><span class="se">]</span><span class="sr">+</span><span class="se">)</span><span class="sr">}/g</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">propRefRegex</span> <span class="o">=</span> <span class="sr">/#ref{</span><span class="se">([^\.]</span><span class="sr">+</span><span class="se">)\.([^</span><span class="sr">}</span><span class="se">]</span><span class="sr">+</span><span class="se">)</span><span class="sr">}/g</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Regular expression for parsing a reference to a property.</p>

<p>Defaults to <code class="prettyprint">/#ref{([^\.]+)\.([^}]+)}/g</code>.</p>

<h4 id="pickjsonschemaproperties">pickJsonSchemaProperties</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">pickJsonSchemaProperties</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">pickJsonSchemaProperties</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>If this is true only properties in <code class="prettyprint">jsonSchema</code> are picked when inserting or updating a row
in the database.</p>

<p>Defaults to false.</p>

<h4 id="defaulteageralgorithm">defaultEagerAlgorithm</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">defaultEagerAlgorithm</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">WhereInEagerAlgorithm</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">defaultEagerAlgorithm</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">WhereInEagerAlgorithm</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p>Sets the default eager loading algorithm for this model. Must be either
<code class="prettyprint">Model.WhereInEagerAlgorithm</code> or <code class="prettyprint">Model.JoinEagerAlgorithm</code>.</p>

<p>Defaults to <code class="prettyprint">Model.WhereInEagerAlgorithm</code>.</p>

<h4 id="defaulteageroptions">defaultEagerOptions</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">defaultEagerOptions</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">minimize</span><span class="p">:</span> <span class="kc">true</span><span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">defaultEagerOptions</span> <span class="o">=</span> <span class="p">{</span><span class="na">minimize</span><span class="p">:</span> <span class="kc">true</span><span class="p">};</span>
<span class="p">}</span>
</code></pre>
<p>Sets the default options for eager loading algorithm. See the possible
fields <a href="#eageroptions">here</a>.</p>

<p>Defaults to <code class="prettyprint">null</code>.</p>

<h4 id="namedfilters">namedFilters</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Movie</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">namedFilters</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">goodMovies</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'stars'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
      <span class="na">orderByName</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">class</span> <span class="nx">Animal</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">namedFilters</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">dogs</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">)</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>The named filters can be used in any eager query:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'[movies(goodMovies, orderByName).actors, pets(dogs)]'</span><span class="p">)</span>
</code></pre>
<p>Named filters that can be used in any eager query.</p>

<h4 id="querybuilder">QueryBuilder</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">QueryBuilder</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">MyCustomQueryBuilder</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>ESNext:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">QueryBuilder</span> <span class="o">=</span> <span class="nx">MyCustomQueryBuilder</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
<p><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> subclass to use in <a href="#query"><code class="prettyprint">query</code></a> or <a href="#_s_query"><code class="prettyprint">$query</code></a> methods.</p>

<p>This constructor is used whenever a query builder is created using <a href="#query"><code class="prettyprint">query</code></a> or <a href="#_s_query"><code class="prettyprint">$query</code></a> methods.
You can override this to use your own <a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a> subclass.</p>

<p><a href="#custom-query-builder">Usage example</a>.</p>

<h3 id="static-methods">Static methods</h3>

<h4 id="query">query</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">queryBuilder</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">transactionOrKnex</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Read models from the database:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="c1">// Get all rows.</span>
<span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'there are'</span><span class="p">,</span> <span class="nx">people</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">'people in the database'</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Example of a more complex WHERE clause. This generates:</span>
<span class="c1">// SELECT FROM "Person"</span>
<span class="c1">// WHERE ("firstName" = 'Jennifer' AND "age" &lt; 30)</span>
<span class="c1">// OR ("firstName" = 'Mark' AND "age" &gt; 30)</span>
<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'Jennifer'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&lt;'</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">orWhere</span><span class="p">(</span><span class="nx">builder</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">builder</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'Mark'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">marksAndJennifers</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">marksAndJennifers</span><span class="p">);</span>
  <span class="p">});</span>

<span class="c1">// Get a subset of rows and fetch related models</span>
<span class="c1">// for each row.</span>
<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children.children.movies'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">oldPeople</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'some old person\'s grand child has appeared in'</span><span class="p">,</span>
      <span class="nx">oldPeople</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="s1">'movies'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Insert models to the database:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sylvester'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Stallone'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">sylvester</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">sylvester</span><span class="p">.</span><span class="nx">fullName</span><span class="p">());</span>
    <span class="c1">// --&gt; 'Sylvester Stallone'.</span>
  <span class="p">});</span>

<span class="c1">// Batch insert. This only works on Postgresql as it is</span>
<span class="c1">// the only database that returns the identifiers of</span>
<span class="c1">// _all_ inserted rows. If you need to do batch inserts</span>
<span class="c1">// on other databases useknex* directly.</span>
<span class="c1">// (See .knexQuery() method).</span>
<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">([</span>
    <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Arnold'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Schwarzenegger'</span><span class="p">},</span>
    <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Sylvester'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Stallone'</span><span class="p">}</span>
  <span class="p">])</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">inserted</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">inserted</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">fullName</span><span class="p">());</span> <span class="c1">// --&gt; 'Arnold Schwarzenegger'</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">update</code> and <code class="prettyprint">patch</code> can be used to update models. Only difference between the mentioned methods
is that <code class="prettyprint">update</code> validates the input objects using the model class&rsquo;s full jsonSchema and <code class="prettyprint">patch</code>
ignores the <code class="prettyprint">required</code> property of the schema. Use <code class="prettyprint">update</code> when you want to update <em>all</em> properties
of a model and <code class="prettyprint">patch</code> when only a subset should be updated.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">35</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">numUpdatedRows</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">numUpdatedRows</span><span class="p">);</span>
  <span class="p">});</span>

<span class="c1">// This will throw assuming that `firstName` or `lastName`</span>
<span class="c1">// is a required property for a Person.</span>
<span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">update</span><span class="p">({</span><span class="na">age</span><span class="p">:</span> <span class="mi">100</span><span class="p">});</span>

<span class="c1">// This will _not_ throw.</span>
<span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">age</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Everyone is now 100 years old'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Models can be deleted using the delete method. Naturally the delete query can be chained with
any knex* methods:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'age'</span><span class="p">,</span> <span class="s1">'&gt;'</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'anyone over 90 is now removed from the database'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Creates a query builder for the model&rsquo;s table.</p>

<p>See the <a href="#query-examples">query examples</a> section for more examples.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>transactionOrKnex</td>
<td>object</td>
<td>Optional transaction or knex instance for the query. This can be used to specify a transaction or even a different database for a query. Falsy values are ignored.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>The created query builder</td>
</tr>
</tbody></table>

<h4 id="knex">knex</h4>

<blockquote>
<p>Get:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">knex</span><span class="p">();</span>
</code></pre>
<blockquote>
<p>Set:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">let</span> <span class="nx">knex</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'knex'</span><span class="p">)({</span>
  <span class="na">client</span><span class="p">:</span> <span class="s1">'sqlite3'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'database.db'</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">Model</span><span class="p">.</span><span class="nx">knex</span><span class="p">(</span><span class="nx">knex</span><span class="p">);</span>
<span class="nx">knex</span> <span class="o">=</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">knex</span><span class="p">();</span>
</code></pre>
<p>Get/Set the knex instance for this model class.</p>

<p>Subclasses inherit the connection. A system-wide knex instance can thus be set by calling
<code class="prettyprint">objection.Model.knex(knex)</code>. This works even after subclasses have been created.</p>

<p>See <a href="#bindknex"><code class="prettyprint">bindKnex</code></a> method if you want to use multiple databases in the same
application.</p>

<h4 id="raw">raw</h4>

<p>Shortcut for <code class="prettyprint">Person.knex().raw(...args)</code></p>

<h4 id="fn">fn</h4>

<p>Shortcut for <code class="prettyprint">Person.knex().fn</code></p>

<h4 id="formatter">formatter</h4>

<p>Shortcut for <code class="prettyprint">Person.knex().client.formatter()</code></p>

<h4 id="knexquery">knexQuery</h4>

<p>Shortcut for <code class="prettyprint">Person.knex().table(Person.tableName)</code></p>

<h4 id="bindknex">bindKnex</h4>

<blockquote>
<p>Example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">knex1</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'knex'</span><span class="p">)({</span>
  <span class="na">client</span><span class="p">:</span> <span class="s1">'sqlite3'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'database1.db'</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">knex2</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'knex'</span><span class="p">)({</span>
  <span class="na">client</span><span class="p">:</span> <span class="s1">'sqlite3'</span><span class="p">,</span>
  <span class="na">connection</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">filename</span><span class="p">:</span> <span class="s1">'database2.db'</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">SomeModel</span><span class="p">.</span><span class="nx">knex</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">BoundModel1</span> <span class="o">=</span> <span class="nx">SomeModel</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex1</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">BoundModel2</span> <span class="o">=</span> <span class="nx">SomeModel</span><span class="p">.</span><span class="nx">bindKnex</span><span class="p">(</span><span class="nx">knex2</span><span class="p">);</span>

<span class="c1">// Throws since the knex instance is null.</span>
<span class="nx">SomeModel</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">then</span><span class="p">();</span>

<span class="c1">// Works.</span>
<span class="nx">BoundModel1</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">models</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">SomeModel</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">BoundModel1</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
<span class="p">});</span>

<span class="c1">// Works.</span>
<span class="nx">BoundModel2</span><span class="p">.</span><span class="nx">query</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">models</span> <span class="o">=&gt;</span> <span class="p">{</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">SomeModel</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
 <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">BoundModel2</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
<span class="p">});</span>
</code></pre>
<p>Creates an anonymous subclass of this class that is bound to the given knex.</p>

<p>This method can be used to bind a Model subclass to multiple databases for example in
a multi-tenant system. See the <a href="#multi-tenancy">multi tenancy recipe</a> for more info.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>knex</td>
<td>Knex</td>
<td>knex connection to bind to</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>function</td>
<td>The create model subclass constructor</td>
</tr>
</tbody></table>

<h4 id="bindtransaction">bindTransaction</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">Person</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./models/Person'</span><span class="p">);</span>

<span class="nx">objection</span><span class="p">.</span><span class="nx">transaction</span><span class="p">(</span><span class="nx">Person</span><span class="p">.</span><span class="nx">knex</span><span class="p">(),</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">trx</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">TransactingPerson</span> <span class="o">=</span>  <span class="nx">Person</span><span class="p">.</span><span class="nx">bindTransaction</span><span class="p">(</span><span class="nx">trx</span><span class="p">);</span>

  <span class="nx">await</span> <span class="nx">TransactingPerson</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">});</span>

  <span class="k">return</span> <span class="nx">await</span> <span class="nx">TransactingPerson</span>
    <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">})</span>
    <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>Alias for <a href="#bindknex"><code class="prettyprint">bindKnex</code></a>.</p>

<h4 id="fromjson">fromJson</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">opt</span><span class="p">);</span>
</code></pre>
<p>Creates a model instance from a JSON object.</p>

<p>The object is checked against <a href="#jsonschema"><code class="prettyprint">jsonSchema</code></a> and an exception is thrown on failure.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object from which to create the model.</td>
</tr>
<tr>
<td>opt</td>
<td><a href="#modeloptions">ModelOptions</a></td>
<td>Update options.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The created model instance</td>
</tr>
</tbody></table>

<h4 id="fromdatabasejson">fromDatabaseJson</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">person</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">fromDatabaseJson</span><span class="p">(</span><span class="nx">row</span><span class="p">);</span>
</code></pre>
<p>Creates a model instance from a JSON object in database format.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>row</td>
<td>Object</td>
<td>A database row.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>The created model instance</td>
</tr>
</tbody></table>

<h4 id="createvalidator">createValidator</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyCustomValidator</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>The default implementation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">AjvValidator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">AjvValidator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">AjvValidator</span><span class="p">({</span>
      <span class="na">onCreateAjv</span><span class="p">:</span> <span class="p">(</span><span class="nx">ajv</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Here you can modify the `Ajv` instance.</span>
      <span class="p">},</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">allErrors</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">validateSchema</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">ownProperties</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">v5</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Creates an instance of a <a href="#validator"><code class="prettyprint">Validator</code></a> that is used to do
all validation related stuff. This method is called only once per
model class.</p>

<p>You can override this method to return an instance of your custom
validator. The custom validator doesn&rsquo;t need to be based on the
<code class="prettyprint">jsonSchema</code>. It can be anything at all as long as it implements the
<a href="#validator"><code class="prettyprint">Validator</code></a> interface.</p>

<p>If you want to use the default json schema based <a href="#ajvvalidator"><code class="prettyprint">AjvValidator</code></a> but
want to modify it, you can use the <code class="prettyprint">objection.AjvValidator</code> constructor. See
the default implementation example.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#validator"><code class="prettyprint">Validator</code></a></td>
<td>The created validator instance</td>
</tr>
</tbody></table>

<h4 id="createnotfounderror">createNotFoundError</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createNotFoundError</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyCustomNotFoundError</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>The default implementation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createNotFoundError</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">NotFoundError</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Creates an error thrown by <a href="#throwifnotfound"><code class="prettyprint">throwIfNotFound()</code></a> method. You can override this
to throw any error you want.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of query that produced the empty result. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">Error</code></td>
<td>The created error. <a href="#notfounderror"><code class="prettyprint">Model.NotFoundError</code></a> by default.</td>
</tr>
</tbody></table>

<h4 id="createvalidationerror">createValidationError</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidationError</span><span class="p">(</span><span class="nx">errorHash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyCustomValidationError</span><span class="p">(</span><span class="nx">errorHash</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>The default implementation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidationError</span><span class="p">(</span><span class="nx">errorHash</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="k">this</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">(</span><span class="nx">errorHash</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Creates an error thrown when validation fails for a model. You can override this
to throw any error you want.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>errorHash</td>
<td>Object</td>
<td>The failed validations. See <a href="#validationerror"><code class="prettyprint">ValidationError</code></a> documentation for details.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code class="prettyprint">Error</code></td>
<td>The created error. <a href="#validationerror"><code class="prettyprint">Model.ValidationError</code></a> by default.</td>
</tr>
</tbody></table>

<h4 id="omitimpl">omitImpl</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">omitImpl</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">prop</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Omit implementation to use.</p>

<p>The default implementation <code class="prettyprint">delete</code>s the property.</p>

<h4 id="loadrelated">loadRelated</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">promise</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">loadRelated</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="nx">expression</span><span class="p">,</span> <span class="nx">filters</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Examples:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">loadRelated</span><span class="p">([</span><span class="nx">person1</span><span class="p">,</span> <span class="nx">person2</span><span class="p">],</span> <span class="s1">'children.pets'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">person1</span> <span class="o">=</span> <span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">person2</span> <span class="o">=</span> <span class="nx">people</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Relations can be filtered by giving named filter functions as arguments to the relations:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">loadRelated</span><span class="p">([</span><span class="nx">person1</span><span class="p">,</span> <span class="nx">person2</span><span class="p">],</span> <span class="s1">'children(orderByAge).[pets(onlyDogs, orderByName), movies]'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">orderByAge</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'age'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">orderByName</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">onlyDogs</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">});</span>
</code></pre>
<p>Load related models for a set of models using a <a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a>.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>models</td>
<td>Array.&lt;<a href="#model"><code class="prettyprint">Model</code></a>&#124;Object&gt;</td>
<td></td>
</tr>
<tr>
<td>expression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>The relation expression</td>
</tr>
<tr>
<td>filters</td>
<td>Object.&lt;string, function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)&gt;</td>
<td>Optional named filters</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>The created query builder</td>
</tr>
</tbody></table>

<h4 id="traverse">traverse</h4>

<blockquote>
<p>There are two ways to call this method:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Model</span><span class="p">.</span><span class="nx">traverse</span><span class="p">(</span><span class="nx">models</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">parentModel</span><span class="p">,</span> <span class="nx">relationName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">doSomething</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>and</p>
<pre class="highlight javascript"><code><span class="nx">Model</span><span class="p">.</span><span class="nx">traverse</span><span class="p">(</span><span class="nx">Person</span><span class="p">,</span> <span class="nx">models</span><span class="p">,</span> <span class="p">(</span><span class="nx">person</span><span class="p">,</span> <span class="nx">parentModel</span><span class="p">,</span> <span class="nx">relationName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">doSomethingForPerson</span><span class="p">(</span><span class="nx">person</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>Traverses the relation tree of a list of models.</p>

<p>Calls the callback for each related model recursively. The callback is called
also for the input models themselves.</p>

<p>In the second example the traverser function is only called for <code class="prettyprint">Person</code> instances.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>filterConstructor</td>
<td>function</td>
<td>If this optional constructor is given, the <code class="prettyprint">traverser</code> is only called for models for which <code class="prettyprint">model instanceof filterConstructor</code> returns true.</td>
</tr>
<tr>
<td>models</td>
<td><a href="#model"><code class="prettyprint">Model</code></a>&#124;Array.&lt;<a href="#model"><code class="prettyprint">Model</code></a>&gt;</td>
<td>The model(s) whose relation trees to traverse.</td>
</tr>
<tr>
<td>traverser</td>
<td>function(<a href="#model"><code class="prettyprint">Model</code></a>, string, string)</td>
<td>The traverser function that is called for each model. The first argument is the model itself. If the model is in a relation of some other model the second argument is the parent model and the third argument is the name of the relation.</td>
</tr>
</tbody></table>

<h4 id="getrelations">getRelations</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">relations</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">getRelations</span><span class="p">();</span>
</code></pre>
<p>Returns a <a href="#relation"><code class="prettyprint">Relation</code></a> object for each relation defined in <a href="#relationmappings"><code class="prettyprint">relationMappings</code></a>.</p>

<p>This method is mainly useful for plugin developers and for other generic usages.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object.&lt;string, <a href="#relation"><code class="prettyprint">Relation</code></a>&gt;</td>
<td>Object whose keys are relation names and values are <a href="#relation"><code class="prettyprint">Relation</code></a> instances.</td>
</tr>
</tbody></table>

<h3 id="instance-methods">Instance methods</h3>

<h4 id="id">$id</h4>
<pre class="highlight javascript"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">$id</span><span class="p">());</span> <span class="c1">// -&gt; 100</span>
<span class="c1">// Sets the id.</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">$id</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Composite key</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">$id</span><span class="p">());</span> <span class="c1">// -&gt; [100, 20, 30]</span>
<span class="c1">// Sets the id.</span>
<span class="nx">model</span><span class="p">.</span><span class="nx">$id</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">]);</span>
</code></pre>
<p>Returns or sets the identifier of a model instance.</p>

<p>The identifier property does not have to be accessed or set using this method.
If the identifier property is known it can be accessed or set just like any
other property.</p>

<h4 id="beforevalidate">$beforeValidate</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeValidate</span><span class="p">(</span><span class="nx">jsonSchema</span><span class="p">,</span> <span class="nx">json</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">jsonSchema</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This is called before validation.</p>

<p>You can add any additional validation to this method. If validation fails, simply throw an exception and
the query will be rejected. If you modify the <code class="prettyprint">jsonSchema</code> argument and return it, that one will be used
to validate the model.</p>

<p><code class="prettyprint">opt.old</code> object contains the old values while <code class="prettyprint">json</code> contains the new values if validation is being done
for an existing object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>jsonSchema</td>
<td>Object</td>
<td>A deep clone of this class&rsquo;s jsonSchema</td>
</tr>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object to be validated</td>
</tr>
<tr>
<td>opt</td>
<td><a href="#modeloptions"><code class="prettyprint">ModelOptions</code></a></td>
<td>Optional options</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>The modified jsonSchema or the input jsonSchema.</td>
</tr>
</tbody></table>

<h4 id="validate">$validate</h4>
<pre class="highlight javascript"><code><span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$validate</span><span class="p">();</span>
</code></pre>
<p>Validates the model instance.</p>

<p>Calls <a href="#_s_beforevalidate"><code class="prettyprint">$beforeValidate</code></a> and <a href="#_s_aftervalidate"><code class="prettyprint">$afterValidate</code></a> methods. This method is called
automatically from <a href="#fromjson"><code class="prettyprint">fromJson</code></a> and <a href="#_s_setjson"><code class="prettyprint">$setJson</code></a> methods. This method can also be
called explicitly when needed.</p>

<h5 id="throws">Throws</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#validationerror"><code class="prettyprint">ValidationError</code></a></td>
<td>If validation fails.</td>
</tr>
</tbody></table>

<h4 id="todatabasejson">$toDatabaseJson</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">row</span> <span class="o">=</span> <span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$toDatabaseJson</span><span class="p">();</span>
</code></pre>
<p>Exports this model as a database JSON object.</p>

<p>This method is called internally to convert a model into a database row.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>Database row.</td>
</tr>
</tbody></table>

<h4 id="tojson">$toJson</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">jsonObj</span> <span class="o">=</span> <span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$toJson</span><span class="p">();</span>
</code></pre>
<p>Exports this model as a JSON object.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>Model as a JSON object.</td>
</tr>
</tbody></table>

<h4 id="tojson">toJSON</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">jsonObj</span> <span class="o">=</span> <span class="nx">modelInstance</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>
</code></pre>
<p>Exports this model as a JSON object.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>Model as a JSON object.</td>
</tr>
</tbody></table>

<h4 id="aftervalidate">$afterValidate</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$afterValidate</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>

  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This is called after successful validation.</p>

<p>You can do further validation here and throw a <a href="#validationerror"><code class="prettyprint">ValidationError</code></a> if something goes wrong.</p>

<p><code class="prettyprint">opt.old</code> object contains the old values while <code class="prettyprint">json</code> contains the new values if validation is being done
for an existing object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object to be validated</td>
</tr>
<tr>
<td>opt</td>
<td><a href="#modeloptions"><code class="prettyprint">ModelOptions</code></a></td>
<td>Optional options</td>
</tr>
</tbody></table>

<h4 id="parsedatabasejson">$parseDatabaseJson</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$parseDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Remember to call the super class's implementation.</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$parseDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="c1">// Do your conversion here.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This is called when a <a href="#model"><code class="prettyprint">Model</code></a> is created from a database JSON object.</p>

<p>Converts the JSON object from the database format to the internal format.</p>

<p>There are a couple of requirements for the implementation:</p>

<p>1. This function must be pure. It should&rsquo;t have any side effects because it is called
       from &ldquo;unexpected&rdquo; places (for example to determine if your model somehow transforms
       column names between db and code).</p>

<p>2. This function must be able to handle any subset of model&rsquo;s properties coming in.
       You cannot assume that some column is present in the <code class="prettyprint">json</code> object as it depends
       on the select statement. There can also be additional columns because of joins,
       aliases etc. This method must also be prepared for null values in <em>any</em> property
       of the <code class="prettyprint">json</code> object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object in database format</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>The JSON object in internal format</td>
</tr>
</tbody></table>

<h4 id="formatdatabasejson">$formatDatabaseJson</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$formatDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Remember to call the super class's implementation.</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$formatDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="c1">// Do your conversion here.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This is called when a <a href="#model"><code class="prettyprint">Model</code></a> is converted to database format.</p>

<p>Converts the JSON object from the internal format to the database format.</p>

<p>There are a couple of requirements for the implementation:</p>

<p>1. This function must be pure. It should&rsquo;t have any side effects because it is called
       from &ldquo;unexpected&rdquo; places (for example to determine if your model somehow transforms
       column names between db and code).</p>

<p>2. This function must be able to handle any subset of model&rsquo;s properties coming in.
       You cannot assume that some property is present in the <code class="prettyprint">json</code> object. There can
       also be additional properties. This method must also be prepared for null values
       in <em>any</em> property of the <code class="prettyprint">json</code> object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object in internal format</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>The JSON object in database format</td>
</tr>
</tbody></table>

<h4 id="parsejson">$parseJson</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$parseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">opt</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Remember to call the super class's implementation.</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$parseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">opt</span><span class="p">);</span>
    <span class="c1">// Do your conversion here.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This is called when a <a href="#model"><code class="prettyprint">Model</code></a> is created from a JSON object.</p>

<p>Converts the JSON object from the external format to the internal format.</p>

<p>There are a couple of requirements for the implementation:</p>

<p>1. This function must be pure. It should&rsquo;t have any side effects because it is called
       from &ldquo;unexpected&rdquo; places (for example to determine if your model somehow transforms
       column names between db and code).</p>

<p>2. This function must be able to handle any subset of model&rsquo;s properties coming in.
       You cannot assume that some property is present in the <code class="prettyprint">json</code> object. There can
       also be additional properties. This method must also be prepared for null values
       in <em>any</em> property of the <code class="prettyprint">json</code> object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object in external format</td>
</tr>
<tr>
<td>opt</td>
<td><a href="#modeloptions"><code class="prettyprint">ModelOptions</code></a></td>
<td>Optional options</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>The JSON object in internal format</td>
</tr>
</tbody></table>

<h4 id="formatjson">$formatJson</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$formatJson</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Remember to call the super class's implementation.</span>
    <span class="nx">json</span> <span class="o">=</span> <span class="kr">super</span><span class="p">.</span><span class="nx">$formatJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
    <span class="c1">// Do your conversion here.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>This is called when a <a href="#model"><code class="prettyprint">Model</code></a> is converted to JSON.</p>

<p>Converts the JSON object from the internal format to the external format.</p>

<p>There are a couple of requirements for the implementation:</p>

<p>1. This function must be pure. It should&rsquo;t have any side effects because it is called
       from &ldquo;unexpected&rdquo; places (for example to determine if your model somehow transforms
       column names between db and code).</p>

<p>2. This function must be able to handle any subset of model&rsquo;s properties coming in.
       You cannot assume that some column is present in the <code class="prettyprint">json</code> object as it depends
       on the select statement. There can also be additional columns because of joins,
       aliases etc. This method must also be prepared for null values in <em>any</em> property
       of the <code class="prettyprint">json</code> object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object in internal format</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>Object</td>
<td>The JSON object in external format</td>
</tr>
</tbody></table>

<h4 id="setjson">$setJson</h4>
<pre class="highlight javascript"><code><span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$setJson</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="nx">opt</span><span class="p">);</span>
</code></pre>
<p>Sets the values from a JSON object.</p>

<p>Validates the JSON before setting values.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object to set</td>
</tr>
<tr>
<td>opt</td>
<td><a href="#modeloptions"><code class="prettyprint">ModelOptions</code></a></td>
<td>Optional options</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td><code class="prettyprint">this</code> for chaining</td>
</tr>
</tbody></table>

<h4 id="setdatabasejson">$setDatabaseJson</h4>
<pre class="highlight javascript"><code><span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$setDatabaseJson</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
</code></pre>
<p>Sets the values from a JSON object in database format.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>json</td>
<td>Object</td>
<td>The JSON object in database format</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td><code class="prettyprint">this</code> for chaining</td>
</tr>
</tbody></table>

<h4 id="set">$set</h4>
<pre class="highlight javascript"><code><span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$set</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>
</code></pre>
<p>Sets the values from another model or object.</p>

<p>Unlike <a href="#_s_setjson"><code class="prettyprint">$setJson</code></a>, this doesn&rsquo;t call any <a href="#_s_parsejson"><code class="prettyprint">$parseJson</code></a> methods or validate the input.
This simply sets each value in the object to this object.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>obj</td>
<td>Object</td>
<td></td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td><code class="prettyprint">this</code> for chaining</td>
</tr>
</tbody></table>

<h4 id="omit">$omit</h4>
<pre class="highlight javascript"><code><span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$omit</span><span class="p">(</span><span class="nx">keys</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Omits a set of properties.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person</span>
  <span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">$omit</span><span class="p">(</span><span class="s1">'lastName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">));</span> <span class="c1">// --&gt; false</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person</span>
  <span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">$omit</span><span class="p">([</span><span class="s1">'lastName'</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">));</span> <span class="c1">// --&gt; false</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person</span>
  <span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">$omit</span><span class="p">({</span><span class="na">lastName</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">));</span> <span class="c1">// --&gt; false</span>
</code></pre>
<p>Omits a set of properties.</p>

<p>The selected properties are set to <code class="prettyprint">undefined</code>. Note that this is done in-place.
Properties are set to undefined instead of deleting them for performance reasons
(V8 doesn&rsquo;t like delete).</p>

<p>If you want to use <code class="prettyprint">delete</code> instead of undefining, you can override the
<a href="#omitimpl"><code class="prettyprint">omitImpl</code></a> method.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>keys</td>
<td>string&#124;Array.&lt;string&gt;&#124;Object.&lt;string, boolean&gt;</td>
<td>keys to omit</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td><code class="prettyprint">this</code> for chaining</td>
</tr>
</tbody></table>

<h4 id="pick">$pick</h4>
<pre class="highlight javascript"><code><span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$pick</span><span class="p">(</span><span class="nx">keys</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Omits a set of properties.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person</span>
  <span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">$pick</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">));</span> <span class="c1">// --&gt; false</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person</span>
  <span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">$pick</span><span class="p">([</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="s1">'age'</span><span class="p">])</span>
  <span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">));</span> <span class="c1">// --&gt; false</span>
</code></pre><pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">person</span>
  <span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">,</span> <span class="na">lastName</span><span class="p">:</span> <span class="s1">'Lawrence'</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">$pick</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">age</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">toJSON</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="s1">'lastName'</span><span class="p">));</span> <span class="c1">// --&gt; false</span>
</code></pre>
<p>Picks a set of properties.</p>

<p>All other properties but the selected ones are set to <code class="prettyprint">undefined</code>. Note that
this is done in-place. Properties are set to undefined instead of deleting
them for performance reasons (V8 doesn&rsquo;t like delete).</p>

<p>If you want to use <code class="prettyprint">delete</code> instead of undefining, you can override the
<a href="#omitimpl"><code class="prettyprint">omitImpl</code></a> method.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>keys</td>
<td>string&#124;Array.&lt;string&gt;&#124;Object.&lt;string, boolean&gt;</td>
<td>keys to pick</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td><code class="prettyprint">this</code> for chaining</td>
</tr>
</tbody></table>

<h4 id="clone">$clone</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">clone</span> <span class="o">=</span> <span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$clone</span><span class="p">;</span>
</code></pre>
<p>Returns a deep copy of this model.</p>

<p>If this object has instances of <a href="#model"><code class="prettyprint">Model</code></a> as properties (or arrays of them)
they are cloned using their <code class="prettyprint">$clone()</code> method.</p>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#model"><code class="prettyprint">Model</code></a></td>
<td>Deep clone of <code class="prettyprint">this</code></td>
</tr>
</tbody></table>

<h4 id="query">$query</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">queryBuilder</span> <span class="o">=</span> <span class="nx">person</span><span class="p">.</span><span class="nx">$query</span><span class="p">(</span><span class="nx">transactionOrKnex</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Re-fetch the instance from the database:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span><span class="p">.</span><span class="nx">$query</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">person</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">person</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Insert a new model to database:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span><span class="p">.</span><span class="nx">fromJson</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Jennifer'</span><span class="p">}).</span><span class="nx">$query</span><span class="p">().</span><span class="nx">insert</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Patch a model:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span><span class="p">.</span><span class="nx">$query</span><span class="p">().</span><span class="nx">patch</span><span class="p">({</span><span class="na">lastName</span><span class="p">:</span> <span class="s1">'Cooper'</span><span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'person updated'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Delete a model.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">person</span><span class="p">.</span><span class="nx">$query</span><span class="p">().</span><span class="k">delete</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'person deleted'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>Creates a query builder for this model instance.</p>

<p>All queries built using the returned builder only affect this instance.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>transactionOrKnex</td>
<td>object</td>
<td>Optional transaction or knex instance for the query. This can be used to specify a transaction or even a different database for a query. Falsy values are ignored.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>query builder</td>
</tr>
</tbody></table>

<h4 id="relatedquery">$relatedQuery</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="nx">relationName</span><span class="p">,</span> <span class="nx">transactionOrKnex</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Fetch all models related to a model through a relation. The fetched models are
also stored to the owner model&rsquo;s property named after the relation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span><span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">pets</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jennifer has'</span><span class="p">,</span> <span class="nx">pets</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">'pets'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">pets</span> <span class="o">===</span> <span class="nx">pets</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>The related query is just like any other query. All knex methods are available:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s1">'Animal.*'</span><span class="p">,</span> <span class="s1">'Person.name as ownerName'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orWhere</span><span class="p">(</span><span class="s1">'breed'</span><span class="p">,</span> <span class="s1">'='</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">innerJoin</span><span class="p">(</span><span class="s1">'Person'</span><span class="p">,</span> <span class="s1">'Person.id'</span><span class="p">,</span> <span class="s1">'Animal.ownerId'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'Animal.name'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">dogsAndCats</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// All the dogs and cats have the owner's name "Jennifer"</span>
    <span class="c1">// joined as the `ownerName` property.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dogsAndCats</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>This inserts a new model to the database and binds it to the owner model as defined
by the relation:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">insert</span><span class="p">({</span><span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy'</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">waldo</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">waldo</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>To add an existing model to a relation the <code class="prettyprint">relate</code> method can be used. In this example
the dog <code class="prettyprint">fluffy</code> already exists in the database but it isn&rsquo;t related to <code class="prettyprint">jennifer</code> through
the <code class="prettyprint">pets</code> relation. We can make the connection like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">relate</span><span class="p">(</span><span class="nx">fluffy</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'fluffy is now related to jennifer through pets relation'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>The connection can be removed using the <code class="prettyprint">unrelate</code> method. Again, this doesn&rsquo;t delete the
related model. Only the connection is removed. For example in the case of ManyToMany relation
the join table entries are deleted.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">unrelate</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">fluffy</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jennifer no longer has fluffy as a pet'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Related models can be deleted using the delete method. Note that in the case of ManyToManyRelation
the join table entries are not deleted. Naturally the delete query can be chained with anyknex*
methods.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="k">delete</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'cat'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jennifer no longer has any cats'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p><code class="prettyprint">update</code> and <code class="prettyprint">patch</code> can be used to update related models. Only difference between the mentioned
methods is that <code class="prettyprint">update</code> validates the input objects using the related model class&rsquo;s full schema
and <code class="prettyprint">patch</code> ignores the <code class="prettyprint">required</code> property of the schema. Use <code class="prettyprint">update</code> when you want to update
<em>all</em> properties of a model and <code class="prettyprint">patch</code> when only a subset should be updated.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">species</span><span class="p">:</span> <span class="s1">'dog'</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="s1">'Fluffy the great'</span><span class="p">,</span> <span class="na">vaccinated</span><span class="p">:</span> <span class="kc">false</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="nx">fluffy</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">updatedFluffy</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'fluffy\'s new name is'</span><span class="p">,</span> <span class="nx">updatedFluffy</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">});</span>

<span class="c1">// This query will be rejected assuming that `name` or `species`</span>
<span class="c1">// is a required property for an Animal.</span>
<span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="na">vaccinated</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>

<span class="c1">// This query will succeed.</span>
<span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$relatedQuery</span><span class="p">(</span><span class="s1">'pets'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">patch</span><span class="p">({</span><span class="na">vaccinated</span><span class="p">:</span> <span class="kc">true</span><span class="p">})</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'jennifer just got all her dogs vaccinated'</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<p>Use this to build a query that only affects the models related to this instance through a relation.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>relationName</td>
<td>string</td>
<td>The name of the relation to query.</td>
</tr>
<tr>
<td>transactionOrKnex</td>
<td>object</td>
<td>Optional transaction or knex instance for the query. This can be used to specify a transaction or even a different database for a query. Falsy values are ignored.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>A query builder</td>
</tr>
</tbody></table>

<h4 id="loadrelated">$loadRelated</h4>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">builder</span> <span class="o">=</span> <span class="nx">modelInstance</span><span class="p">.</span><span class="nx">$loadRelated</span><span class="p">(</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">filters</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Examples:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span><span class="p">.</span><span class="nx">$loadRelated</span><span class="p">(</span><span class="s1">'[pets, children.[pets, father]]'</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer has'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">'pets'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer has'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">'children'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer\'s first child has'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">'pets'</span><span class="p">);</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Jennifer had her first child with'</span><span class="p">,</span> <span class="nx">jennifer</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">father</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<blockquote>
<p>Relations can be filtered by giving named filter functions as arguments
to the relations:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">jennifer</span>
  <span class="p">.</span><span class="nx">$loadRelated</span><span class="p">(</span><span class="s1">'children(orderByAge).[pets(onlyDogs, orderByName), movies]'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">orderByAge</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'age'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">orderByName</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="s1">'name'</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="na">onlyDogs</span><span class="p">:</span> <span class="p">(</span><span class="nx">builder</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">builder</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'species'</span><span class="p">,</span> <span class="s1">'dog'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">jennifer</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">jennifer</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">});</span>
</code></pre>
<p>Loads related models using a <a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a>.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>expression</td>
<td>string&#124;<a href="#relationexpression"><code class="prettyprint">RelationExpression</code></a></td>
<td>The relation expression</td>
</tr>
<tr>
<td>filters</td>
<td>Object.&lt;string, function(<a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a>)&gt;</td>
<td>Optional named filters</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="#querybuilder"><code class="prettyprint">QueryBuilder</code></a></td>
<td>The created query builder</td>
</tr>
</tbody></table>

<h4 id="traverse">$traverse</h4>

<p>Shortcut for <a href="#traverse-2212"><code class="prettyprint">Model.traverse(filterConstructor, this, callback)</code></a>.</p>

<h4 id="knex">$knex</h4>

<p>Shortcut for <a href="#knex"><code class="prettyprint">return this.constructor.knex()</code></a>.</p>

<h4 id="transaction">$transaction</h4>

<p>Shortcut for <a href="#knex"><code class="prettyprint">return this.constructor.knex()</code></a>.</p>

<h4 id="beforeinsert">$beforeInsert</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeInsert</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Called before a model is inserted into the database.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff. You can
also throw an exception to abort the insert and reject the query. This can be useful if
you need to do insert specific validation.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the insert query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h4 id="afterinsert">$afterInsert</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$afterInsert</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Called after a model has been inserted into the database.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the insert query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h4 id="beforeupdate">$beforeUpdate</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeUpdate</span><span class="p">(</span><span class="nx">opt</span><span class="p">,</span> <span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Note that the the <code class="prettyprint">opt.old</code> object is only populated for instance queries started with <code class="prettyprint">$query</code>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">somePerson</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">newValues</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>For the following query <code class="prettyprint">opt.old</code> is <code class="prettyprint">undefined</code> because there is no old object in the javascript
side. objection.js doesn&rsquo;t fetch the old values even if they existed in the database
for performance and simplicity reasons.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">newValues</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">);</span>
</code></pre>
<p>Called before a model is updated.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff. You can
also throw an exception to abort the update and reject the query. This can be useful if
you need to do update specific validation.</p>

<p>This method is also called before a model is patched. Therefore all the model&rsquo;s properties
may not exist. You can check if the update operation is a patch by checking the <code class="prettyprint">opt.patch</code>
boolean.</p>

<p><code class="prettyprint">opt.old</code> object contains the old values while <code class="prettyprint">this</code> contains the updated values. The old
values are never fetched from the database implicitly. For non-instance queries the <code class="prettyprint">opt.old</code>
object is <code class="prettyprint">undefined</code>. See the examples &ndash;&gt;.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>opt</td>
<td>ModelOptions</td>
<td>Update options.</td>
</tr>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the update query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h4 id="afterupdate">$afterUpdate</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$afterUpdate</span><span class="p">(</span><span class="nx">opt</span><span class="p">,</span> <span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>Note that the the <code class="prettyprint">opt.old</code> object is only populated for instance queries started with <code class="prettyprint">$query</code>:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">somePerson</span>
  <span class="p">.</span><span class="nx">$query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">newValues</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>For the following query <code class="prettyprint">opt.old</code> is <code class="prettyprint">undefined</code> because there is no old object in the javascript
side. objection.js doesn&rsquo;t fetch the old values even if they existed in the database
for performance and simplicity reasons.</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">newValues</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">);</span>
</code></pre>
<p>Called after a model is updated.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff.</p>

<p>This method is also called after a model is patched. Therefore all the model&rsquo;s properties
may not exist. You can check if the update operation is a patch by checking the <code class="prettyprint">opt.patch</code>
boolean.</p>

<p><code class="prettyprint">opt.old</code> object contains the old values while <code class="prettyprint">this</code> contains the updated values. The old
values are never fetched from the database implicitly. For non-instance queries the <code class="prettyprint">opt.old</code>
object is <code class="prettyprint">undefined</code>. See the examples &ndash;&gt;.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>opt</td>
<td>ModelOptions</td>
<td>Update options.</td>
</tr>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the update query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h4 id="beforedelete">$beforeDelete</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$beforeDelete</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Called before a model is deleted.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff.</p>

<p>Note that this method is only called for instance deletes started with <code class="prettyprint">$query()</code> method.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the delete query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h4 id="afterdelete">$afterDelete</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$afterDelete</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Called after a model is deleted.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff.</p>

<p>Note that this method is only called for instance deletes started with <code class="prettyprint">$query()</code> method.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the delete query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h4 id="afterget">$afterGet</h4>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="nx">$afterGet</span><span class="p">(</span><span class="nx">queryContext</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">doPossiblyAsyncStuff</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Called after a model is fetched.</p>

<p>This method is <em>not</em> called for insert, update or delete operations.</p>

<p>You can return a promise from this function if you need to do asynchronous stuff.</p>

<h5 id="arguments">Arguments</h5>

<table><thead>
<tr>
<th>Argument</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>queryContext</td>
<td>Object</td>
<td>The context object of the get query. See <a href="#context"><code class="prettyprint">context</code></a>.</td>
</tr>
</tbody></table>

<h5 id="return-value">Return value</h5>

<table><thead>
<tr>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><a href="http://bluebirdjs.com/docs/getting-started.html"><code class="prettyprint">Promise</code></a>&#124;*</td>
<td></td>
</tr>
</tbody></table>

<h2 id="transaction">transaction</h2>

<p>See the section on <a href="#transaction-callback">transaction callback</a></p>

<h3 id="methods">Methods</h3>

<h4 id="start">start</h4>

<p>See the section on <a href="#transaction-object">transaction object</a></p>

<h2 id="transactionobject">TransactionObject</h2>

<p>See the section on <a href="#transaction-object">transaction object</a></p>

<h3 id="instance-methods">Instance methods</h3>

<h4 id="commit">commit</h4>

<p>Call this method to commit the transaction.</p>

<h4 id="rollback">rollback</h4>

<p>Call this method to rollback the transaction.</p>

<h2 id="fieldexpression">FieldExpression</h2>

<p>Field expressions allow one to refer to JSONB fields inside columns.</p>

<p>Syntax: <code class="prettyprint">&lt;column reference&gt;[:&lt;json field reference&gt;]</code></p>

<p>e.g. <code class="prettyprint">Person.jsonColumnName:details.names[1]</code> would refer to value <code class="prettyprint">&#39;Second&#39;</code>
in column <code class="prettyprint">Person.jsonColumnName</code> which has
<code class="prettyprint">{ details: { names: [&#39;First&#39;, &#39;Second&#39;, &#39;Last&#39;] } }</code> object stored in it.</p>

<p>First part <code class="prettyprint">&lt;column reference&gt;</code> is compatible with column references used in
knex e.g. <code class="prettyprint">MyFancyTable.tributeToThBestColumnNameEver</code>.</p>

<p>Second part describes a path to an attribute inside the referred column.
It is optional and it always starts with colon which follows directly with
first path element. e.g. <code class="prettyprint">Table.jsonObjectColumnName:jsonFieldName</code> or
<code class="prettyprint">Table.jsonArrayColumn:[321]</code>.</p>

<p>Syntax supports <code class="prettyprint">[&lt;key or index&gt;]</code> and <code class="prettyprint">.&lt;key or index&gt;</code> flavors of reference
to json keys / array indexes:</p>

<p>e.g. both <code class="prettyprint">Table.myColumn:[1][3]</code> and <code class="prettyprint">Table.myColumn:1.3</code> would access correctly
both of the following objects <code class="prettyprint">[null, [null,null,null, &quot;I was accessed&quot;]]</code> and
<code class="prettyprint">{ &quot;1&quot;: { &quot;3&quot; : &quot;I was accessed&quot; } }</code></p>

<p>Caveats when using special characters in keys:</p>

<ol>
<li><code class="prettyprint">objectColumn.key</code> This is the most common syntax, good if you are not using dots or square brackets <code class="prettyprint">[]</code> in your json object key name.</li>
<li>Keys containing dots <code class="prettyprint">objectColumn:[keywith.dots]</code> Column <code class="prettyprint">{ &quot;keywith.dots&quot; : &quot;I was referred&quot; }</code></li>
<li>Keys containing square brackets <code class="prettyprint">column[&#39;[]&#39;]</code> <code class="prettyprint">{ &quot;[]&quot; : &quot;This is getting ridiculous...&quot; }</code></li>
<li>Keys containing square brackets and quotes <code class="prettyprint">objectColumn:[&#39;Double.&quot;Quote&quot;.[]&#39;]</code> and <code class="prettyprint">objectColumn:[&quot;Sinlge.&#39;Quote&#39;.[]&quot;]</code> Column <code class="prettyprint">{ &quot;Double.\&quot;Quote\&quot;.[]&quot; : &quot;I was referred&quot;,  &quot;Sinlge.&#39;Quote&#39;.[]&quot; : &quot;Mee too!&quot; }</code></li>
<li>Keys containing dots, square brackets, single quotes and double quotes in one json key is not currently supported</li>
</ol>

<h2 id="relationexpression">RelationExpression</h2>

<blockquote>
<p>For example an expression <code class="prettyprint">children.[movies.actors.[pets, children], pets]</code> represents a tree:</p>
</blockquote>
<pre class="highlight plaintext"><code>              children
              (Person)
                 |
         -----------------
         |               |
       movies           pets
      (Movie)         (Animal)
         |
       actors
      (Person)
         |
    -----------
    |         |
   pets    children
 (Animal)  (Person)

</code></pre>
<blockquote>
<p>The model classes are shown in parenthesis.</p>

<p>This class rarely needs to be used directly. The relation expression can be given to a bunch
of functions in objection.js. For example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">Person</span>
  <span class="p">.</span><span class="nx">query</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">eager</span><span class="p">(</span><span class="s1">'children.[movies.actors.[pets, children], pets]'</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">people</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// All persons have the given relation tree fetched.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">people</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">movies</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">actors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">pets</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">});</span>
</code></pre>
<blockquote>
<p>Relation expressions can have arguments. Arguments are listed in parenthesis after the relation names
like this:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">children</span><span class="p">(</span><span class="nx">arg1</span><span class="p">,</span> <span class="nx">arg2</span><span class="p">).[</span><span class="nx">movies</span><span class="p">.</span><span class="nx">actors</span><span class="p">(</span><span class="nx">arg3</span><span class="p">),</span> <span class="nx">pets</span><span class="p">]</span>
</code></pre>
<blockquote>
<p>In this example <code class="prettyprint">children</code> relation had arguments <code class="prettyprint">arg1</code> and <code class="prettyprint">arg2</code> and <code class="prettyprint">actors</code> relation had
the argument <code class="prettyprint">arg3</code>.</p>
</blockquote>

<p>Relation expression is a simple DSL for expressing relation trees.</p>

<p>These are all valid relation expressions:</p>

<ul>
<li><code class="prettyprint">children</code></li>
<li><code class="prettyprint">children.movies</code></li>
<li><code class="prettyprint">[children, pets]</code></li>
<li><code class="prettyprint">[children.movies, pets]</code></li>
<li><code class="prettyprint">[children.[movies, pets], pets]</code></li>
<li><code class="prettyprint">[children.[movies.actors.[children, pets], pets], pets]</code></li>
</ul>

<p>There are two tokens that have special meaning: <code class="prettyprint">*</code> and <code class="prettyprint">^</code>. <code class="prettyprint">*</code> means &ldquo;all relations recursively&rdquo; and
<code class="prettyprint">^</code> means &ldquo;this relation recursively&rdquo;.</p>

<p>For example <code class="prettyprint">children.*</code> means &ldquo;relation <code class="prettyprint">children</code> and all its relations, and all their relations and &hellip;&rdquo;.
The <code class="prettyprint">*</code> token must be used with caution or you will end up fetching your entire database.</p>

<p>Expression <code class="prettyprint">parent.^</code> is equivalent to <code class="prettyprint">parent.parent.parent.parent...</code> up to the point a relation no longer
has results for the <code class="prettyprint">parent</code> relation. The recursion can be limited to certain depth by giving the depth after
the <code class="prettyprint">^</code> character. For example <code class="prettyprint">parent.^3</code> is equal to <code class="prettyprint">parent.parent.parent</code>.</p>

<h2 id="validator">Validator</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">Validator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Validator</span><span class="p">;</span>
</code></pre>
<blockquote>
<p>Usage example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">Validator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Validator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">MyCustomValidator</span> <span class="kr">extends</span> <span class="nx">Validator</span> <span class="p">{</span>
  <span class="nx">validate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// The model instance. May be empty at this point.</span>
    <span class="kr">const</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">model</span><span class="p">;</span>

    <span class="c1">// The properties to validate. After validation these values will</span>
    <span class="c1">// be merged into `model` by objection.</span>
    <span class="kr">const</span> <span class="nx">json</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">json</span><span class="p">;</span>

    <span class="c1">// `ModelOptions` object. If your custom validator sets default</span>
    <span class="c1">// values, you need to check the `opt.patch` boolean. If it is true</span>
    <span class="c1">// we are validating a patch object and the defaults should not be set.</span>
    <span class="kr">const</span> <span class="nx">opt</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>

    <span class="c1">// A context object shared between the validation methods. A new</span>
    <span class="c1">// object is created for each validation operation. You can store</span>
    <span class="c1">// any data here.</span>
    <span class="kr">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">ctx</span><span class="p">;</span>

    <span class="c1">// Do your validation here and throw any exception if the</span>
    <span class="c1">// validation fails.</span>
    <span class="nx">doSomeValidationAndThrowIfFails</span><span class="p">(</span><span class="nx">json</span><span class="p">);</span>

    <span class="c1">// You need to return the (possibly modified) json.</span>
    <span class="k">return</span> <span class="nx">json</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">beforeValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Takes the same arguments as `validate`. Usually there is no need</span>
    <span class="c1">// to override this.</span>
    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">beforeValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">afterValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Takes the same arguments as `validate`. Usually there is no need</span>
    <span class="c1">// to override this.</span>
    <span class="k">return</span> <span class="kr">super</span><span class="p">.</span><span class="nx">afterValidate</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">;</span>

<span class="c1">// Override the `createValidator` method of a `Model` to use the</span>
<span class="c1">// custom validator.</span>
<span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">MyCustomValidator</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>Abstract class from which model validators must be inherited. See the
example for explanation. Also check out the <a href="#createvalidator"><code class="prettyprint">createValidator</code></a>
method.</p>

<h2 id="ajvvalidator">AjvValidator</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">AjvValidator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">AjvValidator</span><span class="p">;</span>
</code></pre>
<blockquote>
<p>Usage example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">Model</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">AjvValidator</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">AjvValidator</span><span class="p">;</span>

<span class="kr">class</span> <span class="nx">BaseModel</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">createValidator</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">AjvValidator</span><span class="p">({</span>
      <span class="na">onCreateAjv</span><span class="p">:</span> <span class="p">(</span><span class="nx">ajv</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Here you can modify the `Ajv` instance.</span>
      <span class="p">},</span>
      <span class="na">options</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">allErrors</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">validateSchema</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">ownProperties</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">v5</span><span class="p">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
<p>The default <a href="https://github.com/epoberezkin/ajv">Ajv</a> based json schema
validator. You can override the <a href="#createvalidator"><code class="prettyprint">createValidator</code></a>
method of <a href="#model"><code class="prettyprint">Model</code></a> like in the example to modify the validator.</p>

<h2 id="validationerror">ValidationError</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">ValidationError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">ValidationError</span><span class="p">;</span>

<span class="k">throw</span> <span class="k">new</span> <span class="nx">ValidationError</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Or</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">ValidationError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">.</span><span class="nx">ValidationError</span><span class="p">;</span>

<span class="k">throw</span> <span class="k">new</span> <span class="nx">ValidationError</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>The <code class="prettyprint">data</code> object should follow this pattern:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">{</span>
  <span class="nl">key1</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">message</span><span class="p">:</span> <span class="s1">'...'</span><span class="p">,</span>
    <span class="na">keyword</span><span class="p">:</span> <span class="s1">'required'</span><span class="p">,</span>
    <span class="na">params</span><span class="p">:</span> <span class="kc">null</span>
  <span class="p">},</span> <span class="p">{</span>
    <span class="na">message</span><span class="p">:</span> <span class="s1">'...'</span><span class="p">,</span>
    <span class="na">keyword</span><span class="p">:</span> <span class="s1">'...'</span><span class="p">,</span>
    <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="p">...],</span>

  <span class="na">key2</span><span class="p">:</span> <span class="p">[{</span>
    <span class="na">message</span><span class="p">:</span> <span class="s1">'...'</span><span class="p">,</span>
    <span class="na">keyword</span><span class="p">:</span> <span class="s1">'minLength'</span><span class="p">,</span>
    <span class="na">params</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">limit</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
      <span class="p">...</span>
    <span class="p">}</span>
  <span class="p">},</span> <span class="p">...],</span>

  <span class="p">...</span>
<span class="p">}</span>
</code></pre>
<blockquote>
<p>For each <code class="prettyprint">key</code>, a list of errors is given. Each error contains the default <code class="prettyprint">message</code> (as returned by the validator), an optional <code class="prettyprint">keyword</code> 
string to identify the validation rule which didn&rsquo;t pass and a <code class="prettyprint">param</code> object which optionally contains more details about the context of the validation error.</p>
</blockquote>

<p>Error of this class is thrown by default if a model validation fails.</p>

<p>You can replace this error by overriding <a href="#createvalidationerror"><code class="prettyprint">Model.createValidationError()</code></a> method.</p>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>statusCode</td>
<td>number</td>
<td>HTTP status code for interop with express error handlers and other libraries that search for status code from errors.</td>
</tr>
<tr>
<td>data</td>
<td>Object</td>
<td>Dictionary of errors.</td>
</tr>
</tbody></table>

<h2 id="notfounderror">NotFoundError</h2>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">NotFoundError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">NotFoundError</span><span class="p">;</span>

<span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundError</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</code></pre>
<blockquote>
<p>Or</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">NotFoundError</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'objection'</span><span class="p">).</span><span class="nx">Model</span><span class="p">.</span><span class="nx">NotFoundError</span><span class="p">;</span>

<span class="k">throw</span> <span class="k">new</span> <span class="nx">NotFoundError</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</code></pre>
<p>Error of this class is thrown by default by <a href="#throwifnotfound"><code class="prettyprint">throwIfNotFound()</code></a></p>

<p>You can replace this error by overriding <a href="#createnotfounderror"><code class="prettyprint">Model.createNotFoundError()</code></a> method.</p>

<h2 id="modeloptions">ModelOptions</h2>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>patch</td>
<td>boolean</td>
<td>If true the json is treated as a patch and the <code class="prettyprint">required</code> field of the json schema is ignored in the validation. This allows us to create models with a subset of required properties for patch operations.</td>
</tr>
<tr>
<td>skipValidation</td>
<td>boolean</td>
<td>If true the json schema validation is skipped</td>
</tr>
<tr>
<td>old</td>
<td>object</td>
<td>The old values for methods like <code class="prettyprint">$beforeUpdate</code> and <code class="prettyprint">$beforeValidate</code>.</td>
</tr>
</tbody></table>

<h2 id="eageroptions">EagerOptions</h2>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>minimize</td>
<td>boolean</td>
<td>If true the aliases of the joined tables and columns in a join based eager loading are minimized. This is sometimes needed because of identifier length limitations of some database engines. objection throws an exception when a query exceeds the length limit. You need to use this only in those cases.</td>
</tr>
<tr>
<td>separator</td>
<td>string</td>
<td>Separator between relations in nested join based eager query. Defaults to <code class="prettyprint">:</code>. Dot (<code class="prettyprint">.</code>) cannot be used at the moment because of the way knex parses the identifiers.</td>
</tr>
<tr>
<td>aliases</td>
<td>Object.&lt;string, string&gt;</td>
<td>Aliases for relations in a join based eager query. Defaults to an empty object.</td>
</tr>
</tbody></table>

<h2 id="relation">Relation</h2>

<blockquote>
<p>Note that <code class="prettyprint">Relation</code> instances are actually instances of the relation classes used in <code class="prettyprint">relationMappings</code>. For example:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">get</span> <span class="nx">relationMappings</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">pets</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">relation</span><span class="p">:</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">,</span>
        <span class="na">modelClass</span><span class="p">:</span> <span class="nx">Animal</span><span class="p">,</span>
        <span class="na">join</span><span class="p">:</span> <span class="p">{</span>
          <span class="na">from</span><span class="p">:</span> <span class="s1">'Person.id'</span><span class="p">,</span>
          <span class="na">to</span><span class="p">:</span> <span class="s1">'Animal.ownerId'</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">relations</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">getRelations</span><span class="p">();</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">relations</span><span class="p">.</span><span class="nx">pets</span> <span class="k">instanceof</span> <span class="nx">Model</span><span class="p">.</span><span class="nx">HasManyRelation</span><span class="p">);</span> <span class="c1">// --&gt; true</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">relations</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span> <span class="c1">// --&gt; pets</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">relations</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">ownerCol</span><span class="p">);</span> <span class="c1">// --&gt; ['id']</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">relations</span><span class="p">.</span><span class="nx">pets</span><span class="p">.</span><span class="nx">relatedCol</span><span class="p">);</span> <span class="c1">// --&gt; ['ownerId']</span>
</code></pre>
<p><code class="prettyprint">Relation</code> is a parsed and normalized instance of a <a href="#relationmapping"><code class="prettyprint">RelationMapping</code></a>. <code class="prettyprint">Relation</code>s can be accessed using the <a href="#getrelations"><code class="prettyprint">getRelations</code></a> method.</p>

<p>There is a <code class="prettyprint">*Prop</code> and <code class="prettyprint">*Col</code> version of each key, because models may define conversions between database and external
property names. Most of the times these fields hold the same values, but in case of a conversion, the conversion has
been applied to them. The properties are arrays because of composite key support.</p>

<p><code class="prettyprint">Relation</code> is actually a base class for all relation types <code class="prettyprint">BelongsToOneRelation</code>, <code class="prettyprint">HasManyRelation</code> etc. You can use <code class="prettyprint">instanceof</code> to determine
the type of the relations (see the example on the right). Note that <code class="prettyprint">HasOneRelation</code> is a subclass of <code class="prettyprint">HasManyRelation</code> and <code class="prettyprint">HasOneThroughRelation</code>
is a subclass of <code class="prettyprint">ManyToManyRelation</code>. Arrange your <code class="prettyprint">instanceof</code> checks accordingly.</p>

<table><thead>
<tr>
<th>Property</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>name</td>
<td>string</td>
<td>Name of the relation. For example <code class="prettyprint">pets</code> or <code class="prettyprint">children</code>.</td>
</tr>
<tr>
<td>ownerModelClass</td>
<td>function</td>
<td>The model class that has defined the relation.</td>
</tr>
<tr>
<td>relatedModelClass</td>
<td>function</td>
<td>The model class of the related objects.</td>
</tr>
<tr>
<td>ownerCol</td>
<td>Array&lt;string&gt;</td>
<td>The relation column in the <code class="prettyprint">ownerModelClass</code>.</td>
</tr>
<tr>
<td>ownerProp</td>
<td>Array&lt;string&gt;</td>
<td>The relation property in the <code class="prettyprint">ownerModelClass</code>.</td>
</tr>
<tr>
<td>relatedCol</td>
<td>Array&lt;string&gt;</td>
<td>The relation column in the <code class="prettyprint">relatedModelClass</code>.</td>
</tr>
<tr>
<td>relatedProp</td>
<td>Array&lt;string&gt;</td>
<td>The relation property in the <code class="prettyprint">relatedModelClass</code>.</td>
</tr>
<tr>
<td>joinTable</td>
<td>string</td>
<td>The name of the join table (only for <code class="prettyprint">ManyToMany</code> and <code class="prettyprint">HasOneThrough</code> relations).</td>
</tr>
<tr>
<td>joinTableOwnerCol</td>
<td>Array&lt;string&gt;</td>
<td>The join table column pointing to <code class="prettyprint">ownerCol</code> (only for <code class="prettyprint">ManyToMany</code> and <code class="prettyprint">HasOneThrough</code> relations).</td>
</tr>
<tr>
<td>joinTableOwnerProp</td>
<td>Array&lt;string&gt;</td>
<td>The join table property pointing to <code class="prettyprint">ownerProp</code> (only for <code class="prettyprint">ManyToMany</code> and <code class="prettyprint">HasOneThrough</code> relations).</td>
</tr>
<tr>
<td>joinTableRelatedCol</td>
<td>Array&lt;string&gt;</td>
<td>The join table property pointing to <code class="prettyprint">relatedCol</code> (only for <code class="prettyprint">ManyToMany</code> and <code class="prettyprint">HasOneThrough</code> relations).</td>
</tr>
<tr>
<td>joinTableRelatedProp</td>
<td>Array&lt;string&gt;</td>
<td>The join table property pointing to <code class="prettyprint">relatedProp</code> (only for <code class="prettyprint">ManyToMany</code> and <code class="prettyprint">HasOneThrough</code> relations).</td>
</tr>
</tbody></table>

          <h1 id="changelog">Changelog</h1>

<h2 id="0-8-2">0.8.2</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="http://vincit.github.io/objection.js/#namedfilters"><code class="prettyprint">Model.namedFilters</code></a> object for defining shared filters that can be used by name in eager expressions.</li>
<li>Full support for views and table aliases in eager, join, joinRelation etc. <a href="https://github.com/Vincit/objection.js/issues/181">#181</a></li>
<li>Fix <code class="prettyprint">bindTransaction</code> bug with <code class="prettyprint">ManyToManyRelation</code> junction tables <a href="https://github.com/Vincit/objection.js/issues/395">#395</a></li>
</ul>

<h2 id="0-8-1">0.8.1</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="http://vincit.github.io/objection.js/#throwifnotfound"><code class="prettyprint">throwIfNotFound</code></a> method for making empty query results throw an exception.</li>
<li>fix error when passing model instance to a <code class="prettyprint">where</code> method. <a href="https://github.com/Vincit/objection.js/issues/387">#387</a></li>
</ul>

<h2 id="0-8-0">0.8.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>All query methods now call <code class="prettyprint">Model.query</code> to create a <code class="prettyprint">QueryBuilder</code> instance <a href="https://github.com/Vincit/objection.js/issues/346">#346</a></li>
<li>Objection is no longer transpiled. One of the implications is that you can use a github
link in package.json to test experimental versions.</li>
<li><code class="prettyprint">count</code> can now be called without arguments <a href="https://github.com/Vincit/objection.js/issues/364">#364</a></li>
<li>A new <a href="#getrelations"><code class="prettyprint">getRelations</code></a> method for plugin development and other reflection greatness.</li>
</ul>

<h3 id="breaking-changes">Breaking changes</h3>

<blockquote>
<p>Old model definition</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kd">function</span> <span class="nx">Person</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Model</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Person</span><span class="p">);</span>

<span class="nx">Person</span><span class="p">.</span><span class="nx">tableName</span> <span class="o">=</span> <span class="s1">'Person'</span><span class="p">;</span>

<span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fullName</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// More static and prototype methods.</span>
</code></pre>
<blockquote>
<p>Easiest way to migrate to <code class="prettyprint">class</code> and <code class="prettyprint">extends</code> keywords</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">class</span> <span class="nx">Person</span> <span class="kr">extends</span> <span class="nx">Model</span> <span class="p">{</span>

<span class="p">}</span>

<span class="nx">Person</span><span class="p">.</span><span class="nx">tableName</span> <span class="o">=</span> <span class="s1">'Person'</span><span class="p">;</span>

<span class="nx">Person</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fullName</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">firstName</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastName</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// More static and prototype methods.</span>
</code></pre>
<ul>
<li><p>Support for node versions below 4.0.0 has been removed. With it the support for legacy class inheritance using <code class="prettyprint">Model.extend</code> method
has also been removed. This means that you need to change your model definitions to use the <code class="prettyprint">class</code> and <code class="prettyprint">extends</code> keywords.
To achieve this with the minimum amount of changes you can simply swap the constructor function and <code class="prettyprint">Model.extend</code> to
a class definition. You can still define all static and prototype methods and properties the old way. See the example on the right &ndash;&gt;</p>

<p>Note that this also affects Babel transpilation. You cannot (or need to) use <code class="prettyprint">babel-plugin-transform-es2015-classes</code> anymore.
See the <a href="https://github.com/Vincit/objection.js/tree/master/examples/express-es7">ESNext example project</a> as an example of
how to setup babel.</p></li>
<li><p>The default value of <a href="#pickjsonschemaproperties"><code class="prettyprint">pickJsonSchemaProperties</code></a> was changed to <code class="prettyprint">false</code>. Before, all properties that
were not listed in <code class="prettyprint">jsonSchema</code> were removed before <code class="prettyprint">insert</code>, <code class="prettyprint">patch</code> or <code class="prettyprint">update</code> (if <code class="prettyprint">jsonSchma</code> was defined). Starting from
this version you need to explicitly set the value to <code class="prettyprint">true</code>. You may have been used this feature by accident.
If you have weird problems after the update, try setting <code class="prettyprint">objection.Model.pickJsonSchemaProperties = true;</code> to see
if it helps.</p></li>
<li><p><a href="#pickjsonschemaproperties"><code class="prettyprint">relate</code></a> and <a href="#pickjsonschemaproperties"><code class="prettyprint">unrelate</code></a> methods now return the result of the
underlying query (<code class="prettyprint">patch</code> in case of <code class="prettyprint">HasManyRelation</code>, <code class="prettyprint">HasOneRelation</code>, and <code class="prettyprint">BelongsToOneRelation</code>. <code class="prettyprint">insert</code> otherwise).
Before the method input was always returned.</p></li>
<li><p><code class="prettyprint">Model.RelatedQueryBuilder</code> is removed. <code class="prettyprint">Model.QueryBuilder</code> is now used to create all query builders for the model.
This only affects you if you have defined custom query builders.</p></li>
</ul>

<h2 id="0-7-12">0.7.12</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix <a href="https://github.com/Vincit/objection.js/issues/345">#345</a></li>
</ul>

<h2 id="0-7-11">0.7.11</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix <a href="https://github.com/Vincit/objection.js/issues/339">#339</a></li>
<li>fix <a href="https://github.com/Vincit/objection.js/issues/341">#341</a></li>
</ul>

<h2 id="0-7-10">0.7.10</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix bugs that prevented using <code class="prettyprint">$relatedQuery</code> and <code class="prettyprint">eager</code> together with <code class="prettyprint">JoinEagerAlgorithm</code></li>
<li>typing updates</li>
</ul>

<h2 id="0-7-9">0.7.9</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="http://vincit.github.io/objection.js/#joinrelation"><code class="prettyprint">joinRelation</code></a> now accepts <a href="http://vincit.github.io/objection.js/#relationexpression"><code class="prettyprint">RelationExpressions</code></a> and can join multiple and nested relations.</li>
</ul>

<h2 id="0-7-6">0.7.6</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><code class="prettyprint">range</code> and <code class="prettyprint">page</code> methods now use a window function and only generate one query on postgresql <a href="https://github.com/Vincit/objection.js/issues/62">#62</a></li>
<li>fix MSSQL 2100 parameter limit in eager queries <a href="https://github.com/Vincit/objection.js/issues/311">#311</a></li>
</ul>

<h2 id="0-7-5">0.7.5</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix <a href="https://github.com/Vincit/objection.js/issues/327">#327</a></li>
<li>fix <a href="https://github.com/Vincit/objection.js/issues/256">#256</a></li>
</ul>

<h2 id="0-7-4">0.7.4</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>automatically select columns needed for relations <a href="https://github.com/Vincit/objection.js/issues/309">#309</a></li>
<li>fix an issue where <code class="prettyprint">$formatJson</code> was called inside <code class="prettyprint">insertGraph</code> <a href="https://github.com/Vincit/objection.js/issues/326">#326</a></li>
</ul>

<h2 id="0-7-3">0.7.3</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix <a href="https://github.com/Vincit/objection.js/issues/325">#325</a></li>
<li>fix an issue where <code class="prettyprint">select</code> had to be used in addition to <code class="prettyprint">distinct</code> in some cases</li>
</ul>

<h2 id="0-7-2">0.7.2</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><code class="prettyprint">HasOneThroughRelation</code> relation type.</li>
</ul>

<h2 id="0-7-1">0.7.1</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix <code class="prettyprint">JoinEagerAlgorithm</code> NPE bug</li>
</ul>

<h2 id="0-7-0">0.7.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><code class="prettyprint">jsonSchema</code> without <code class="prettyprint">properties</code> now works. <a href="https://github.com/Vincit/objection.js/issues/205">#205</a></li>
<li><code class="prettyprint">relationMappings</code> can now be a function. <a href="https://github.com/Vincit/objection.js/issues/227">#227</a></li>
<li>many to many extras can now be aliased. <a href="https://github.com/Vincit/objection.js/issues/223">#223</a></li>
<li>zero values are now allowed in relation columns. <a href="https://github.com/Vincit/objection.js/issues/228">#228</a></li>
<li>active transaction can now be accessed in <code class="prettyprint">$before/$after</code> hooks through <code class="prettyprint">queryContext.transaction</code> property.</li>
<li>Validation can now be easily modified through a new <a href="#validator"><code class="prettyprint">Validator</code></a> interface. <a href="https://github.com/Vincit/objection.js/issues/241">#241</a> <a href="https://github.com/Vincit/objection.js/issues/199">#199</a></li>
<li>fix a <code class="prettyprint">JoinEager</code> problem where an empty result for a relation caused the following relations to be empty. <a href="https://github.com/Vincit/objection.js/issues/292">#292</a></li>
<li><code class="prettyprint">ref(fieldExpression)</code> syntax to reduce need for knex.raw and updating single attribute inside JSON column. <a href="https://github.com/Vincit/objection.js/issues/270">#270</a></li>
<li><a href="http://vincit.github.io/objection.js/#mergeeager">mergeEager</a> method.</li>
</ul>

<h3 id="breaking-changes">Breaking changes</h3>

<ul>
<li><code class="prettyprint">$relatedQuery</code> now returns a single model instead of an array for belongsToOne and hasOne relations. <a href="https://github.com/Vincit/objection.js/issues/155">#155</a></li>
<li>identifier of a model can now be updated. Be careful with this one! Before if you forgot a wrong id in an <code class="prettyprint">update</code>/<code class="prettyprint">patch</code> operation, it would simply get ignored. Now the id is also updated just like any other column <a href="https://github.com/Vincit/objection.js/issues/100">#100</a></li>
<li><code class="prettyprint">Table.*</code> is now selected by default in all queries instead of <code class="prettyprint">*</code>. This will break some join queries that don&rsquo;t have an explicit select clause. <a href="https://github.com/Vincit/objection.js/issues/161">#161</a></li>
<li><code class="prettyprint">ValidationError.data</code> is now an object including, for each key, a list of errors with context info. <a href="https://github.com/Vincit/objection.js/issues/283">#283</a></li>
</ul>

<h2 id="0-6-2">0.6.2</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><code class="prettyprint">relationMappings</code> can now be a function <a href="https://github.com/Vincit/objection.js/issues/227">#227</a></li>
</ul>

<h2 id="0-6-1">0.6.1</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix bug <a href="https://github.com/Vincit/objection.js/issues/205">#205</a></li>
</ul>

<h2 id="0-6-0">0.6.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>Eager loading can now be done using joins and zero extra queries. See <a href="#eageralgorithm"><code class="prettyprint">eagerAlgorithm</code></a>, <a href="#defaulteageralgorithm"><code class="prettyprint">defaultEagerAlgorithm</code></a> and <a href="#eager"><code class="prettyprint">eager</code></a> for more info.</li>
<li><code class="prettyprint">#ref</code> in graph inserts can now contain extra properties for many-to-many relations <a href="https://github.com/Vincit/objection.js/issues/156">#156</a></li>
<li><code class="prettyprint">#dbRef</code> can now be used to refer to existing rows from a <code class="prettyprint">insertWithRelated</code> graph.</li>
<li><a href="#modelpaths"><code class="prettyprint">modelPaths</code></a> attribute for cleaner way to point to models in relationMappings.</li>
<li><a href="#pickjsonschemaproperties"><code class="prettyprint">pickJsonSchemaProperties</code></a> config parameter <a href="https://github.com/Vincit/objection.js/issues/110">#110</a></li>
<li><a href="#insertgraphandfetch"><code class="prettyprint">insertGraphAndFetch</code></a> with <code class="prettyprint">insertWithRelatedAndFetch</code> alias. <a href="https://github.com/Vincit/objection.js/issues/172">#172</a></li>
<li>Added <a href="#_s_beforedelete"><code class="prettyprint">$beforeDelete</code></a> and <a href="#_s_afterdelete"><code class="prettyprint">$afterDelete</code></a> hooks <a href="https://github.com/Vincit/objection.js/issues/112">#112</a></li>
<li>Old values can now be accessed from <code class="prettyprint">$beforeUpdate</code>, <code class="prettyprint">$afterUpdate</code>, <code class="prettyprint">$beforeValidate</code> and <code class="prettyprint">$afterValidate</code> hooks <a href="https://github.com/Vincit/objection.js/issues/185">#185</a></li>
<li>Support length property <a href="ttps://github.com/Vincit/objection.js/issues/168">#168</a></li>
<li>Make sure operations are executed in the order they are called <a href="https://github.com/Vincit/objection.js/issues/180">#180</a></li>
<li>Fetch nothing if the <code class="prettyprint">where</code> clauses hit no rows in <code class="prettyprint">update/patchAndFetchById</code> methods <a href="https://github.com/Vincit/objection.js/issues/189">#189</a></li>
<li>Lots of performance tweaks.</li>
<li><code class="prettyprint">$loadRelated</code> and <code class="prettyprint">loadRelated</code> now return a <code class="prettyprint">QueryBuilder</code>.</li>
</ul>

<h3 id="breaking-changes">Breaking changes</h3>

<ul>
<li><p>Undefined values as query method arguments now throw an exception. Before they were just silently ignored
and for example <code class="prettyprint">delete().where(&#39;id&#39;, undefined)</code> caused the entire table to be deleted. <a href="http://vincit.github.io/objection.js/#skipundefined">skipUndefined</a>
method can be called for a query builder to handle the undefined values the old way.</p></li>
<li><p>Deprecated method <code class="prettyprint">dumpSql</code> is now removed.</p></li>
<li><p><code class="prettyprint">$loadRelated</code> and <code class="prettyprint">loadRelated</code> now return a <code class="prettyprint">QueryBuilder</code>. This may break your code is some rare cases
where you have called a non-standard promise method like <code class="prettyprint">reflect</code> for the return value of these functions.</p></li>
</ul>

<h2 id="0-5-5">0.5.5</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="#virtualattributes">Virtual attributes</a></li>
</ul>

<h2 id="0-5-4">0.5.4</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>bugfix: insertWithRelated now works with <code class="prettyprint">additionalProperties = false</code> in <code class="prettyprint">jsonSchema</code></li>
<li>Add updateAndFetch and patchAndFetch methods for <code class="prettyprint">$query</code></li>
<li>bugfix: afterGet was not called for nested models in eager query</li>
<li>Use ajv instad of tv4 for json schema validation</li>
</ul>

<h2 id="0-5-3">0.5.3</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>ES6 promise compatibility fixes.</li>
</ul>

<h2 id="0-5-1">0.5.1</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="#afterget">$afterGet</a> hook.</li>
</ul>

<h2 id="0-5-0">0.5.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="#joinrelation">joinRelation</a> family of query builder methods.</li>
<li><code class="prettyprint">HasOneRelation</code> for creating inverse one-to-one relations.</li>
<li>Relations have been renamed <code class="prettyprint">OneToOneRelation</code> &ndash;&gt; <code class="prettyprint">BelongsToOneRelation</code>, <code class="prettyprint">OneToManyRelation</code> &ndash;&gt; <code class="prettyprint">HasManyRelation</code>.
The old names work, but have been deprecated.</li>
<li><a href="#withschema">withSchema</a> now works as expected and sets the schema of all queries executed by the query builder the
method is called for.</li>
<li><a href="#filtereager">filterEager</a> method for better eager query filtering.</li>
<li><a href="#relationmappings">extra properties</a> feature for selecting/inserting columns from/to the join table in many-to-many relations.</li>
<li>Eager query recursion depth can be controlled like so: <code class="prettyprint">parent.^5</code>.</li>
</ul>

<h2 id="0-4-0">0.4.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>Query context feature. See <a href="https://github.com/Vincit/objection.js/issues/51">#51</a> and <a href="#context">these docs</a> for more info.</li>
<li>Composite key support.</li>
<li><a href="#findbyid">findById</a>, <a href="#deletebyid">deleteById</a>, <a href="#wherecomposite">whereComposite</a> and
<a href="#whereincomposite">whereInComposite</a> query builder methods.</li>
</ul>

<h3 id="breaking-changes">Breaking changes</h3>

<p>There shouldn&rsquo;t be any major breaking changes. We moved from ES5 to ES7 + babel in this version so there are big changes
in the codebase. If something comes up, please open an issue.</p>

<p>There are a few known corner cases that may break:</p>

<ul>
<li><p>You can now define a model for the join table of <code class="prettyprint">ManyToMany</code> relations in <code class="prettyprint">relationMappings</code>. This is optional,
but may be needed if you already have a model for a <code class="prettyprint">ManyToMany</code> relation <em>and</em> you use <code class="prettyprint">snake_case</code>
to <code class="prettyprint">camelCase</code> conversion for the column names. See the documentation on the <a href="#relationthrough">through</a>
property of <a href="#relationmappings">relationMappings</a>.</p></li>
<li><p>The repo no longer contains the actual built javascript. Only the ES7 code that is transpiled when the code is
published to npm. Therefore you can no longer specify a git hash to package.json to use for example the
HEAD version. We will start to publish alpha and RC versions to npm when something new and experimental
is added to the library.</p></li>
</ul>

<h2 id="0-3-3">0.3.3</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>fix regression: QueryBuilder.from is broken.</li>
</ul>

<h2 id="0-3-2">0.3.2</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>Improved relation expression whitespace handling.</li>
</ul>

<h2 id="0-3-1">0.3.1</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><code class="prettyprint">whereJson*</code> methods can now be used inside functions given to <code class="prettyprint">where</code> methods.</li>
<li>Added multiple missing knex methods to <code class="prettyprint">QueryBuilder</code>.</li>
</ul>

<h2 id="0-3-0">0.3.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li><a href="http://vincit.github.io/objection.js/QueryBuilder.html#insertWithRelated">insertWithRelated</a> method for
inserting model trees</li>
<li><a href="http://vincit.github.io/objection.js/QueryBuilder.html#insertAndFetch">insertAndFetch</a>,
<a href="http://vincit.github.io/objection.js/QueryBuilder.html#updateAndFetchById">updateAndFetchById</a> and
<a href="http://vincit.github.io/objection.js/QueryBuilder.html#patchAndFetchById">patchAndFetchById</a> helper methods</li>
<li>Filters for <a href="#eager-queries">eager expressions</a></li>
<li><a href="#transaction-object">New alternative way to use transactions</a></li>
<li>Many performance updates related to cloning, serializing and deserializing model trees.</li>
</ul>

<h3 id="breaking-changes">Breaking changes</h3>

<ul>
<li>QueryBuilder methods <code class="prettyprint">update</code>, <code class="prettyprint">patch</code> and <code class="prettyprint">delete</code> now return the number of affected rows.
The new methods <code class="prettyprint">updateAndFetchById</code> and <code class="prettyprint">patchAndFetchById</code> may help with the migration</li>
<li><code class="prettyprint">modelInstance.$query()</code> instance method now returns a single model instead of an array</li>
<li>Removed <code class="prettyprint">Model.generateId()</code> method. <code class="prettyprint">$beforeInsert</code> can be used instead</li>
</ul>

<h2 id="0-2-8">0.2.8</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>ES6 inheritance support</li>
<li>generator function support for transactions</li>
<li>traverse,pick and omit methods for Model and QueryBuilder</li>
<li>bugfix: issue #38</li>
</ul>

<h2 id="0-2-7">0.2.7</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>bugfix: fix #37 also for <code class="prettyprint">$query()</code>.</li>
<li>Significant <code class="prettyprint">toJson</code>/<code class="prettyprint">fromJson</code> performance boost.</li>
</ul>

<h2 id="0-2-6">0.2.6</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>bugfix: fix regression bug that broke dumpSql.</li>
</ul>

<h2 id="0-2-5">0.2.5</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>bugfix: fix regression bug that prevented values assigned to <code class="prettyprint">this</code> in <code class="prettyprint">$before</code> callbacks from getting into
the actual database query</li>
</ul>

<h2 id="0-2-4">0.2.4</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>bugfix: many-to-many relations didn&rsquo;t work correctly with a snake_case to camelCase conversion
in the related model class.</li>
</ul>

<h2 id="0-2-3">0.2.3</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>Promise constructor is now exposed through <code class="prettyprint">require(&#39;objection&#39;).Promise</code>.</li>
</ul>

<h2 id="0-2-2">0.2.2</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>$beforeUpdate, $afterUpdate, $beforeInsert etc. are now asynchronous and you can return promises from them.</li>
<li>Added <code class="prettyprint">Model.fn()</code> shortcut to <code class="prettyprint">knex.fn</code>.</li>
<li>Added missing <code class="prettyprint">asCallback</code> and <code class="prettyprint">nodeify</code> methods for <code class="prettyprint">QueryBuilder</code>.</li>
</ul>

<h2 id="0-2-1">0.2.1</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>bugfix: Chaining <code class="prettyprint">insert</code> with <code class="prettyprint">returning</code> now returns all listed columns.</li>
</ul>

<h2 id="0-2-0">0.2.0</h2>

<h3 id="what-39-s-new">What&rsquo;s new</h3>

<ul>
<li>New name <code class="prettyprint">objection.js</code>.</li>
<li><code class="prettyprint">$beforeInsert</code>, <code class="prettyprint">$afterInsert</code>, <code class="prettyprint">$beforeUpdate</code> and <code class="prettyprint">$afterUpdate</code> hooks for <code class="prettyprint">Model</code>.</li>
<li>Postgres jsonb query methods: <code class="prettyprint">whereJsonEquals</code>, <code class="prettyprint">whereJsonSupersetOf</code>, <code class="prettyprint">whereJsonSubsetOf</code> and friends.</li>
<li><code class="prettyprint">whereRef</code> query method.</li>
<li>Expose <code class="prettyprint">knex.raw()</code> through <code class="prettyprint">Model.raw()</code>.</li>
<li>Expose <code class="prettyprint">knex.client.formatter()</code> through <code class="prettyprint">Model.formatter()</code>.</li>
<li><code class="prettyprint">QueryBuilder</code> can be used to make sub queries just like knex&rsquo;s <code class="prettyprint">QueryBuilder</code>.</li>
<li>Possibility to use a custom <code class="prettyprint">QueryBuilder</code> subclass by overriding <code class="prettyprint">Model.QueryBuilder</code>.</li>
<li>Filter queries/objects for relations.</li>
<li>A pile of bug fixes.</li>
</ul>

<h3 id="breaking-changes">Breaking changes</h3>

<ul>
<li>Project was renamed to objection.js. Migrate simply by replacing <code class="prettyprint">moron</code> with <code class="prettyprint">objection</code>.</li>
</ul>

<h2 id="0-1-0">0.1.0</h2>

<p>First release.</p>

      </div>
      <div class="dark-box">
      </div>
    </div>
  </body>
</html>
