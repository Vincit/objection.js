<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Migration from objection 2.x to 3.0 | Objection.js</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.3da53256.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.aac9f1d1.js" as="script"><link rel="preload" href="/objection.js/assets/js/2.95f20b73.js" as="script"><link rel="preload" href="/objection.js/assets/js/1.317fd1a4.js" as="script"><link rel="preload" href="/objection.js/assets/js/75.3f83663e.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/10.8a0f09eb.js"><link rel="prefetch" href="/objection.js/assets/js/11.bbb59564.js"><link rel="prefetch" href="/objection.js/assets/js/14.bb8bba7c.js"><link rel="prefetch" href="/objection.js/assets/js/15.bc71fa15.js"><link rel="prefetch" href="/objection.js/assets/js/16.1015d7dd.js"><link rel="prefetch" href="/objection.js/assets/js/17.ab0dd903.js"><link rel="prefetch" href="/objection.js/assets/js/18.a3b06a8a.js"><link rel="prefetch" href="/objection.js/assets/js/19.5c3531e2.js"><link rel="prefetch" href="/objection.js/assets/js/20.2af5813f.js"><link rel="prefetch" href="/objection.js/assets/js/21.6a6c2510.js"><link rel="prefetch" href="/objection.js/assets/js/22.eee14584.js"><link rel="prefetch" href="/objection.js/assets/js/23.6778d240.js"><link rel="prefetch" href="/objection.js/assets/js/24.c29fb8d5.js"><link rel="prefetch" href="/objection.js/assets/js/25.b88ad4e1.js"><link rel="prefetch" href="/objection.js/assets/js/26.9731c624.js"><link rel="prefetch" href="/objection.js/assets/js/27.2309824e.js"><link rel="prefetch" href="/objection.js/assets/js/28.9cd4116c.js"><link rel="prefetch" href="/objection.js/assets/js/29.9bc7197a.js"><link rel="prefetch" href="/objection.js/assets/js/3.67dbd821.js"><link rel="prefetch" href="/objection.js/assets/js/30.1547f4b8.js"><link rel="prefetch" href="/objection.js/assets/js/31.b88bc1d1.js"><link rel="prefetch" href="/objection.js/assets/js/32.66fe2719.js"><link rel="prefetch" href="/objection.js/assets/js/33.e8009bdb.js"><link rel="prefetch" href="/objection.js/assets/js/34.f1f78902.js"><link rel="prefetch" href="/objection.js/assets/js/35.207a938f.js"><link rel="prefetch" href="/objection.js/assets/js/36.b95f3f00.js"><link rel="prefetch" href="/objection.js/assets/js/37.4f09d1c0.js"><link rel="prefetch" href="/objection.js/assets/js/38.95ee9973.js"><link rel="prefetch" href="/objection.js/assets/js/39.5d0d1076.js"><link rel="prefetch" href="/objection.js/assets/js/4.45d2dbd6.js"><link rel="prefetch" href="/objection.js/assets/js/40.1106236d.js"><link rel="prefetch" href="/objection.js/assets/js/41.2819fb93.js"><link rel="prefetch" href="/objection.js/assets/js/42.46aedc9e.js"><link rel="prefetch" href="/objection.js/assets/js/43.97f8a0cf.js"><link rel="prefetch" href="/objection.js/assets/js/44.108db8aa.js"><link rel="prefetch" href="/objection.js/assets/js/45.0b550365.js"><link rel="prefetch" href="/objection.js/assets/js/46.7926c441.js"><link rel="prefetch" href="/objection.js/assets/js/47.2eb7ded0.js"><link rel="prefetch" href="/objection.js/assets/js/48.f94e2444.js"><link rel="prefetch" href="/objection.js/assets/js/49.a31c4e2f.js"><link rel="prefetch" href="/objection.js/assets/js/5.4784c48b.js"><link rel="prefetch" href="/objection.js/assets/js/50.e7cbb678.js"><link rel="prefetch" href="/objection.js/assets/js/51.9cce1f3f.js"><link rel="prefetch" href="/objection.js/assets/js/52.640685d3.js"><link rel="prefetch" href="/objection.js/assets/js/53.5926f518.js"><link rel="prefetch" href="/objection.js/assets/js/54.672b4e20.js"><link rel="prefetch" href="/objection.js/assets/js/55.2684a066.js"><link rel="prefetch" href="/objection.js/assets/js/56.28c3b1d4.js"><link rel="prefetch" href="/objection.js/assets/js/57.d32a8c76.js"><link rel="prefetch" href="/objection.js/assets/js/58.7ef64bdc.js"><link rel="prefetch" href="/objection.js/assets/js/59.57d27807.js"><link rel="prefetch" href="/objection.js/assets/js/6.d162f3c7.js"><link rel="prefetch" href="/objection.js/assets/js/60.fa4c2ff7.js"><link rel="prefetch" href="/objection.js/assets/js/61.03e12088.js"><link rel="prefetch" href="/objection.js/assets/js/62.9237edcc.js"><link rel="prefetch" href="/objection.js/assets/js/63.7f748604.js"><link rel="prefetch" href="/objection.js/assets/js/64.309afa4e.js"><link rel="prefetch" href="/objection.js/assets/js/65.5408ec5a.js"><link rel="prefetch" href="/objection.js/assets/js/66.255018e8.js"><link rel="prefetch" href="/objection.js/assets/js/67.8fe54358.js"><link rel="prefetch" href="/objection.js/assets/js/68.2f58527c.js"><link rel="prefetch" href="/objection.js/assets/js/69.1be647c6.js"><link rel="prefetch" href="/objection.js/assets/js/7.a905ae32.js"><link rel="prefetch" href="/objection.js/assets/js/70.499b7621.js"><link rel="prefetch" href="/objection.js/assets/js/71.1caae563.js"><link rel="prefetch" href="/objection.js/assets/js/72.9fe3e8ea.js"><link rel="prefetch" href="/objection.js/assets/js/73.adc7a66e.js"><link rel="prefetch" href="/objection.js/assets/js/74.051786cd.js"><link rel="prefetch" href="/objection.js/assets/js/8.e75082ac.js"><link rel="prefetch" href="/objection.js/assets/js/9.0594e08f.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.08d45e08.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.3da53256.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Migration to 3.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v2/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v2.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ‚≠ê Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link">
  Guide
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="API Reference" class="dropdown-title"><span class="title">API Reference</span> <span class="arrow down"></span></button> <button type="button" aria-label="API Reference" class="mobile-dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">
  Main Module
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">
  Query Builder
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">
  Model
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">
  Types
</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">
  Recipe Book
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Release Notes" class="dropdown-title"><span class="title">Release Notes</span> <span class="arrow down"></span></button> <button type="button" aria-label="Release Notes" class="mobile-dropdown-title"><span class="title">Release Notes</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/changelog.html" class="nav-link">
  Changelog
</a></li><li class="dropdown-item"><!----> <a href="/objection.js/release-notes/migration.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Migration to 3.0
</a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v2/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v2.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Vincit/objection.js/tree/v1/doc" target="_blank" rel="noopener noreferrer" class="nav-link external">
  v1.x documentation
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ‚≠ê Star
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="migration-from-objection-2-x-to-3-0"><a href="#migration-from-objection-2-x-to-3-0" class="header-anchor">#</a> Migration from objection 2.x to 3.0</h1> <p>This document guides you through each breaking change in objection 3.0 and attempts to provide clear steps to follow. If you find something missing, please open an issue and we'll fix this guide ASAP.</p> <p>Here's a list of the breaking changes</p> <ul><li><a href="#dropped-support-for-node-12">Dropped support for node &lt; 12</a></li> <li><a href="#dropped-support-for-knex-0-95">Dropped support for knex &lt; 0.95</a></li> <li><a href="#typescript-methods-like-findbyid-and-findone-that-return-a-single-item-are-now-typed-correctly">typescript: Methods like <code>findById</code> and <code>findOne</code> that return a single item are now typed correctly</a></li> <li><a href="#typescript-querybuilder-now-inherits-promiselike-instead-of-promise">typescript: <code>QueryBuilder</code> now inherits <code>PromiseLike</code> instead of <code>Promise</code></a></li> <li><a href="#dropped-a-bunch-of-deprecated-methods-and-features">Dropped a bunch of deprecated methods and features</a></li></ul> <h2 id="dropped-support-for-node-12"><a href="#dropped-support-for-node-12" class="header-anchor">#</a> Dropped support for node &lt; 12</h2> <p>Objection 3.0 needs at least node 12 to work.</p> <h2 id="dropped-support-for-knex-0-95"><a href="#dropped-support-for-knex-0-95" class="header-anchor">#</a> Dropped support for knex &lt; 0.95</h2> <p>Objection needs at least knex 0.95.0 to work.</p> <p>This is because knex introduced some breaking changes in 0.95.0.</p> <h2 id="typescript-methods-like-findbyid-and-findone-that-return-a-single-item-are-now-typed-correctly"><a href="#typescript-methods-like-findbyid-and-findone-that-return-a-single-item-are-now-typed-correctly" class="header-anchor">#</a> typescript: Methods like <code>findById</code> and <code>findOne</code> that return a single item are now typed correctly</h2> <p>In 2.0 methods like <code>findById</code>, <code>findOne</code> and <code>first</code> that return one item or undefined were incorrectly typed
to always return a value. Now the return type of those methods is <code>SomeModel | undefined</code>.</p> <p>You'll get compilation errors in places where you've trusted the old typings. All you need to do is to add a
check for undefined values to narrow down the type or chain the <code>throwIfNotFound</code> method that also narrows
down the type back to <code>SomeModel</code>.</p> <p>Before:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>After:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>person<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Person not found'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><p>Or</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throwIfNotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
</code></pre></div><h2 id="typescript-querybuilder-now-inherits-promiselike-instead-of-promise"><a href="#typescript-querybuilder-now-inherits-promiselike-instead-of-promise" class="header-anchor">#</a> typescript: <code>QueryBuilder</code> now inherits <code>PromiseLike</code> instead of <code>Promise</code></h2> <p>In 2.0 and before, the <code>QueryBuilder</code> class inherited <code>Promise</code> in the typings which made code like this possible</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">findPerson</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>However, <code>QueryBuilder</code> doesn't actually inherit <code>Promise</code> but instead is &quot;thenable&quot;. Typescript has the type
<code>PromiseLike</code> for thenable objects which objection now correctly uses. There are couple of ways to fix the
compilation errors this change causes:</p> <ol><li>Chain <code>execute</code> to the query:</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">findPerson</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>Use <code>PromiseLike</code>:</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">findPerson</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> PromiseLike<span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="3"><li>Make the functions <code>async</code>:</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">findPerson</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Person<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="dropped-a-bunch-of-deprecated-methods-and-features"><a href="#dropped-a-bunch-of-deprecated-methods-and-features" class="header-anchor">#</a> Dropped a bunch of deprecated methods and features</h2> <p>All the methods that were marked deprecated (and printed a deprection message during runtime) in 2.0 have
now been removed.</p> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <h1 id="migration-from-objection-1-x-to-2-0"><a href="#migration-from-objection-1-x-to-2-0" class="header-anchor">#</a> Migration from objection 1.x to 2.0</h1> <p>Objection 2.0 brought a lot of great new features, but the main focus was in cleaning the API, which lead to a bunch of breaking changes. This document guides you through each change and attempts to provide clear steps to follow. If you find something missing, please open an issue and we'll fix this guide ASAP.</p> <p>Here's a list of the breaking changes</p> <ul><li><a href="#node-6-and-7-are-no-longer-supported">Node 6 and 7 are no longer supported</a></li> <li><a href="#modify-method-signature-change">modify method signature change</a></li> <li><a href="#bluebird-and-lodash-have-been-removed">Bluebird and lodash have been removed</a></li> <li><a href="#database-errors-now-come-from-the-db-errors-library">Database errors now come from db-errors library</a></li> <li><a href="#ref-references-in-insertgraph-and-upsertgraph-now-require-the-allowrefs-true-option">#ref references in insertGraph and upsertGraph now require the allowRefs: true option</a></li> <li><a href="#relate-method-now-always-returns-the-number-of-affected-rows">relate method now always returns the number of affected rows</a></li> <li><a href="#relatedquery-no-longer-mutates">$relatedQuery no longer mutates</a></li> <li><a href="#context-now-acts-like-mergecontext">context now acts like mergeContext</a></li> <li><a href="#model-raw-and-model-fn-now-return-objection-raw-and-fn">Model.raw and Model.fn now return objection raw and fn</a></li> <li><a href="#querybuilder-tostring-and-querybuilder-tosql-have-been-removed">QueryBuilder.toString and QueryBuilder.toSql have been removed</a></li> <li><a href="#rewritten-typings">Rewritten typings</a></li></ul> <p>In addition to these, <strong>a lot</strong> of methods were deprecated and replaced by a new method. The old methods still work, but they print a warning (once per process) when you use them. The warning message tells which method you should be using in the future and you can slowly replace the methods as you get annoyed by the warnings.</p> <p>Most of the methods have simply been renamed, but in some cases the replacing methods work a little differently. Make sure to read the documentation of the new method.</p> <h2 id="node-6-and-7-are-no-longer-supported"><a href="#node-6-and-7-are-no-longer-supported" class="header-anchor">#</a> Node 6 and 7 are no longer supported</h2> <p>Objection now needs at least node 8 to work.</p> <h2 id="modify-method-signature-change"><a href="#modify-method-signature-change" class="header-anchor">#</a> <code>modify</code> method signature change</h2> <p>Before, you were able to provide multiple modifiers or modifier names to <code>modify</code> by providing multiple arguments like this:</p> <div class="language-js extra-class"><pre class="language-js"><code>Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now only the first argument is used to specify modifiers and all the rest are arguments for the modifiers. The first argument can be an array so you can simply wrap the modifiers in an array if there are more than one of them:</p> <div class="language-js extra-class"><pre class="language-js"><code>Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="bluebird-and-lodash-have-been-removed"><a href="#bluebird-and-lodash-have-been-removed" class="header-anchor">#</a> Bluebird and lodash have been removed</h2> <p>Before, all async operations returned a bluebird promise. Now the bluebird dependency has been dropped and the native <code>Promise</code> is used instead. This also means that all bluebird-specific methods</p> <ul><li><code>map</code></li> <li><code>reduce</code></li> <li><code>reflect</code></li> <li><code>bind</code></li> <li><code>spread</code></li> <li><code>asCallback</code></li> <li><code>nodeify</code></li></ul> <p>have been removed from the <code>QueryBuilder</code>.</p> <p>You need to go through your code and make sure you don't use any bluebird methods or trust that objection returns a bluebird promise.</p> <p>Objection also used to export <code>Promise</code> and <code>lodash</code> properties like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Promise<span class="token punctuation">,</span> lodash <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'objection'</span><span class="token punctuation">;</span>
</code></pre></div><p>which is not true anymore. Both of those exports have been removed.</p> <h2 id="database-errors-now-come-from-the-db-errors-library"><a href="#database-errors-now-come-from-the-db-errors-library" class="header-anchor">#</a> Database errors now come from the db-errors library</h2> <p>Before, when a database operation failed, objection simply passed through the native error thrown by the database client. In 2.0 the errors are wrapped using the <a href="https://github.com/Vincit/db-errors" target="_blank" rel="noopener noreferrer">db-errors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> library.</p> <p>The <code>db-errors</code> library errors expose a <code>nativeError</code> property. If you rely on the properties of the old errors, you can simply change code like this</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">13514</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>into this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  err <span class="token operator">=</span> err<span class="token punctuation">.</span>nativeError <span class="token operator">||</span> err

  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token number">13514</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>A preferred way to handle this would be to use the new <code>db-error</code> classes as described <a href="/objection.js/recipes/error-handling.html#error-handling">here</a>, but the fastest migration path is to do the above trick.</p> <h2 id="ref-references-in-insertgraph-and-upsertgraph-now-require-the-allowrefs-true-option"><a href="#ref-references-in-insertgraph-and-upsertgraph-now-require-the-allowrefs-true-option" class="header-anchor">#</a> #ref references in insertGraph and upsertGraph now require the allowRefs: true option</h2> <p>The usage of <code>'#ref': 'someId'</code> and <code>#ref{someId.someProp}</code> now requires an explicit <code>allowRefs: true</code> option to be passed to the called method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span>graphWithRefs<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">allowRefs</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This change was made for security reasons. An attacker could, in theory, use a <code>#ref{someId.someProperty}</code> reference to access for example the password hash of a user:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> graphUpsertSentByTheAttacker <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">13431</span><span class="token punctuation">,</span>
    <span class="token string-property property">'#id'</span><span class="token operator">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token literal-property property">movie</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'#ref{user.passwordHash}'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>and then the attacker could just take the password hash out of the movies's name in a client of some sort.</p> <p>For this attack to work, the attacker must already have an access to the API that modifies the user's information. Additionally and more importantly, the graph described above (and all other graphs I could think of) would only yield the password hash in the movie's name <strong>if the program sets the hash to the graph before the <code>upsertGraph</code> call is executed</strong>. This is a highly unlikely scenario and in case of passowords, would require the attacker to be able to access a route that changes the user's password. The reference can never access the property in the database, only in the object itself.</p> <p>Even though there's very little chance this kind of attack could be carried out at the moment, I'd advice you to never use <code>upsertGraph</code> with <code>{ allowRefs: true }</code> and unvalidated user input with references!</p> <h2 id="relate-method-now-always-returns-the-number-of-affected-rows"><a href="#relate-method-now-always-returns-the-number-of-affected-rows" class="header-anchor">#</a> relate method now always returns the number of affected rows</h2> <p><code>relate</code> used to return the inserted pivot table row in case of <code>ManyToManyRelation</code> and the number of updated rows in case of other relations. Now an integer indicating the number of affected rows is always returned.</p> <p>You need to go through your code and check how the return values of <code>relate</code> queries are used.</p> <h2 id="relatedquery-no-longer-mutates"><a href="#relatedquery-no-longer-mutates" class="header-anchor">#</a> $relatedQuery no longer mutates</h2> <p>With objection 1.x, doing this</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> somePerson<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>added a property <code>pets</code> for <code>somePerson</code> and saved the result there. This no longer happens with objection 2. Also inserting a new item using</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> somePerson<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>pet<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>would previously add the inserted pet to the <code>pets</code> array of <code>somePerson</code>. This also no longer happens.</p> <p>You can use <code>withGraphFetched</code> and <code>fetchGraph</code> methods if you want to populate the relations. Also, nothing prevents you from doing this:</p> <div class="language-js extra-class"><pre class="language-js"><code>somePerson<span class="token punctuation">.</span>pets <span class="token operator">=</span> <span class="token keyword">await</span> somePerson<span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can also use the <code>Model.relatedInsertQueryMutates</code> and <code>Model.relatedFindQueryMutates</code> properties to revert back to 1.x behavior. Note that those properties are now deprecated and will be removed in 3.0.</p> <h2 id="context-now-acts-like-mergecontext"><a href="#context-now-acts-like-mergecontext" class="header-anchor">#</a> context() now acts like mergeContext()</h2> <p>The <code>context</code> method of <code>QueryBuilder</code> now merges the given object with the current context object instead of replacing it. You can use <code>clearContext</code> to clear the context if you need the old behaviour.</p> <h2 id="model-raw-and-model-fn-now-return-objection-raw-and-fn"><a href="#model-raw-and-model-fn-now-return-objection-raw-and-fn" class="header-anchor">#</a> Model.raw and Model.fn now return objection raw and fn</h2> <p>Previously <code>Model.raw</code> returned a knex raw builder and <code>Model.fn</code> returned a knex <code>FunctionHelper</code> instance. In 2.0 objection's <a href="/objection.js/api/objection/#raw">raw</a> and <a href="/objection.js/api/objection/#fn">fn</a> helpers are returned. To get a knex <code>raw</code> builder, you need to use <code>knex.raw</code> directly.</p> <h2 id="querybuilder-tostring-and-querybuilder-tosql-have-been-removed"><a href="#querybuilder-tostring-and-querybuilder-tosql-have-been-removed" class="header-anchor">#</a> QueryBuilder.toString and QueryBuilder.toSql have been removed</h2> <p>You can use <code>QueryBuilder.toKnexQuery().toSQL()</code> instead.</p> <h2 id="rewritten-typings"><a href="#rewritten-typings" class="header-anchor">#</a> Rewritten typings</h2> <p>The typings have been completely rewritten in 2.0 and many of the types have changed names. By default you shouldn't get that many errors, but whenever you have explicitly defined an objection type for something other than <code>Model</code>, you may need to adjust that type. For example the <code>QueryBuilder</code> no longer takes three generic arguments, but two.</p> <p>For this breaking change we can't easily provide clear migration steps, because we don't know how much you have trusted the typescript type inference, and how much you have used explicit types.</p> <p>One notable change is that you should no longer define your relations properties using <code>Partial&lt;Model&gt;</code> or <code>Partial&lt;Model&gt;[]</code>. You can simply use <code>Model</code> and <code>Model[]</code> and methods like <code>insertGraph</code> and <code>upsertGraph</code> will just work.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/objection.js/assets/js/app.aac9f1d1.js" defer></script><script src="/objection.js/assets/js/2.95f20b73.js" defer></script><script src="/objection.js/assets/js/1.317fd1a4.js" defer></script><script src="/objection.js/assets/js/75.3f83663e.js" defer></script>
  </body>
</html>
